{
  "name": "MoCDecentralizedExchange",
  "source": "// SPDX-License-Identifier: \n// File: openzeppelin-eth/contracts/math/SafeMath.sol\n\npragma solidity ^0.5.2;\n\n/*\n * @title SafeMath\n * @dev Unsigned math operations with safety checks that revert on error\n */\nlibrary SafeMath {\n    /*\n     * @dev Multiplies two unsigned integers, reverts on overflow.\n     */\n    function mul(uint256 a, uint256 b) internal pure returns (uint256) {\n        // Gas optimization: this is cheaper than requiring 'a' not being zero, but the\n        // benefit is lost if 'b' is also tested.\n        // See: https://github.com/OpenZeppelin/openzeppelin-solidity/pull/522\n        if (a == 0) {\n            return 0;\n        }\n\n        uint256 c = a * b;\n        require(c / a == b);\n\n        return c;\n    }\n\n    /*\n     * @dev Integer division of two unsigned integers truncating the quotient, reverts on division by zero.\n     */\n    function div(uint256 a, uint256 b) internal pure returns (uint256) {\n        // Solidity only automatically asserts when dividing by 0\n        require(b > 0);\n        uint256 c = a / b;\n        // assert(a == b * c + a % b); // There is no case in which this doesn't hold\n\n        return c;\n    }\n\n    /*\n     * @dev Subtracts two unsigned integers, reverts on overflow (i.e. if subtrahend is greater than minuend).\n     */\n    function sub(uint256 a, uint256 b) internal pure returns (uint256) {\n        require(b <= a);\n        uint256 c = a - b;\n\n        return c;\n    }\n\n    /*\n     * @dev Adds two unsigned integers, reverts on overflow.\n     */\n    function add(uint256 a, uint256 b) internal pure returns (uint256) {\n        uint256 c = a + b;\n        require(c >= a);\n\n        return c;\n    }\n\n    /*\n     * @dev Divides two unsigned integers and returns the remainder (unsigned integer modulo),\n     * reverts when dividing by zero.\n     */\n    function mod(uint256 a, uint256 b) internal pure returns (uint256) {\n        require(b != 0);\n        return a % b;\n    }\n}\n\n// File: openzeppelin-eth/contracts/math/Math.sol\n\npragma solidity ^0.5.2;\n\n/*\n * @title Math\n * @dev Assorted math operations\n */\nlibrary Math {\n    /*\n     * @dev Returns the largest of two numbers.\n     */\n    function max(uint256 a, uint256 b) internal pure returns (uint256) {\n        return a >= b ? a : b;\n    }\n\n    /*\n     * @dev Returns the smallest of two numbers.\n     */\n    function min(uint256 a, uint256 b) internal pure returns (uint256) {\n        return a < b ? a : b;\n    }\n\n    /*\n     * @dev Calculates the average of two numbers. Since these are integers,\n     * averages of an even and odd number cannot be represented, and will be\n     * rounded down.\n     */\n    function average(uint256 a, uint256 b) internal pure returns (uint256) {\n        // (a + b) / 2 can overflow, so we distribute\n        return (a / 2) + (b / 2) + ((a % 2 + b % 2) / 2);\n    }\n}\n\n// File: zos-lib/contracts/Initializable.sol\n\npragma solidity >=0.4.24 <0.6.0;\n\n\n/*\n * @title Initializable\n *\n * @dev Helper contract to support initializer functions. To use it, replace\n * the constructor with a function that has the `initializer` modifier.\n * WARNING: Unlike constructors, initializer functions must be manually\n * invoked. This applies both to deploying an Initializable contract, as well\n * as extending an Initializable contract via inheritance.\n * WARNING: When used with inheritance, manual care must be taken to not invoke\n * a parent initializer twice, or ensure that all initializers are idempotent,\n * because this is not dealt with automatically as with constructors.\n */\ncontract Initializable {\n\n  /*\n   * @dev Indicates that the contract has been initialized.\n   */\n  bool private initialized;\n\n  /*\n   * @dev Indicates that the contract is in the process of being initialized.\n   */\n  bool private initializing;\n\n  /*\n   * @dev Modifier to use in the initializer function of a contract.\n   */\n  modifier initializer() {\n    require(initializing || isConstructor() || !initialized, \"Contract instance has already been initialized\");\n\n    bool isTopLevelCall = !initializing;\n    if (isTopLevelCall) {\n      initializing = true;\n      initialized = true;\n    }\n\n    _;\n\n    if (isTopLevelCall) {\n      initializing = false;\n    }\n  }\n\n  /// @dev Returns true if and only if the function is running in the constructor\n  function isConstructor() private view returns (bool) {\n    // extcodesize checks the size of the code stored in an address, and\n    // address returns the current address. Since the code is still not\n    // deployed when running a constructor, any checks on its code size will\n    // yield zero, making it an effective way to detect if a contract is\n    // under construction or not.\n    uint256 cs;\n    assembly { cs := extcodesize(address) }\n    return cs == 0;\n  }\n\n  // Reserved storage space to allow for layout changes in the future.\n  uint256[50] private ______gap;\n}\n\n// File: openzeppelin-eth/contracts/utils/ReentrancyGuard.sol\n\npragma solidity ^0.5.2;\n\n\n/*\n * @title Helps contracts guard against reentrancy attacks.\n * @author Remco Bloemen <remco@2Ï€.com>, Eenae <alexey@mixbytes.io>\n * @dev If you mark a function `nonReentrant`, you should also\n * mark it `external`.\n */\ncontract ReentrancyGuard is Initializable {\n    /// @dev counter to allow mutex lock with only one SSTORE operation\n    uint256 private _guardCounter;\n\n    function initialize() public initializer {\n        // The counter starts at one to prevent changing it from zero to a non-zero\n        // value, which is a more expensive operation.\n        _guardCounter = 1;\n    }\n\n    /*\n     * @dev Prevents a contract from calling itself, directly or indirectly.\n     * Calling a `nonReentrant` function from another `nonReentrant`\n     * function is not supported. It is possible to prevent this from happening\n     * by making the `nonReentrant` function external, and make it call a\n     * `private` function that does the actual work.\n     */\n    modifier nonReentrant() {\n        _guardCounter += 1;\n        uint256 localCounter = _guardCounter;\n        _;\n        require(localCounter == _guardCounter);\n    }\n\n    uint256[50] private ______gap;\n}\n\n// File: areopagus/contracts/Governance/ChangeContract.sol\n\npragma solidity 0.5.8;\n\n/*\n  @title ChangeContract\n  @notice This interface is the one used by the governance system.\n  @dev If you plan to do some changes to a system governed by this project you should write a contract\n  that does those changes, like a recipe. This contract MUST not have ANY kind of public or external function\n  that modifies the state of this ChangeContract, otherwise you could run into front-running issues when the governance\n  system is fully in place.\n */\ninterface ChangeContract {\n\n  /*\n    @notice Override this function with a recipe of the changes to be done when this ChangeContract\n    is executed\n   */\n  function execute() external;\n}\n\n// File: areopagus/contracts/Governance/IGovernor.sol\n\npragma solidity 0.5.8;\n\n\n/*\n  @title Governor\n  @notice Governor interface. This functions should be overwritten to\n  enable the comunnication with the rest of the system\n  */\ninterface IGovernor{\n\n  /*\n    @notice Function to be called to make the changes in changeContract\n    @dev This function should be protected somehow to only execute changes that\n    benefit the system. This decision process is independent of this architechture\n    therefore is independent of this interface too\n    @param changeContract Address of the contract that will execute the changes\n   */\n  function executeChange(ChangeContract changeContract) external;\n\n  /*\n    @notice Function to be called to make the changes in changeContract\n    @param _changer Address of the contract that will execute the changes\n   */\n  function isAuthorizedChanger(address _changer) external view returns (bool);\n}\n\n// File: areopagus/contracts/Governance/Governed.sol\n\npragma solidity 0.5.8;\n\n\n\n/*\n  @title Governed\n  @notice Base contract to be inherited by governed contracts\n  @dev This contract is not usable on its own since it does not have any _productive useful_ behaviour\n  The only purpose of this contract is to define some useful modifiers and functions to be used on the\n  governance aspect of the child contract\n  */\ncontract Governed is Initializable {\n\n  /*\n    @notice The address of the contract which governs this one\n   */\n  IGovernor public governor;\n\n  string constant private NOT_AUTHORIZED_CHANGER = \"not_authorized_changer\";\n\n  /*\n    @notice Modifier that protects the function\n    @dev You should use this modifier in any function that should be called through\n    the governance system\n   */\n  modifier onlyAuthorizedChanger() {\n    checkIfAuthorizedChanger();\n    _;\n  }\n\n  /*\n    @notice Initialize the contract with the basic settings\n    @dev This initialize replaces the constructor but it is not called automatically.\n    It is necessary because of the upgradeability of the contracts\n    @param _governor Governor address\n   */\n  function initialize(address _governor) public initializer {\n    governor = IGovernor(_governor);\n  }\n\n  /*\n    @notice Change the contract's governor. Should be called through the old governance system\n    @param newIGovernor New governor address\n   */\n  function changeIGovernor(IGovernor newIGovernor) public onlyAuthorizedChanger {\n    governor = newIGovernor;\n  }\n\n  /*\n    @notice Checks if the msg sender is an authorized changer, reverts otherwise\n   */\n  function checkIfAuthorizedChanger() internal view {\n    require(governor.isAuthorizedChanger(msg.sender), NOT_AUTHORIZED_CHANGER);\n  }\n\n  // Leave a gap betweeen inherited contracts variables in order to be\n  // able to add more variables in them later\n  uint256[50] private upgradeGap;\n}\n\n// File: areopagus/contracts/Stopper/Stoppable.sol\n\npragma solidity 0.5.8;\n\n\n\n/*\n  @title Stoppable\n  @notice Allow a contract to be paused through the stopper subsystem. This contracts\n  is able to disable the stoppability feature through governance.\n  @dev This contract was heavily based on the _Pausable_ contract of openzeppelin-eth but\n  it was modified in order to being able to turn on and off its stopability\n */\ncontract Stoppable is Governed {\n\n  event Paused(address account);\n  event Unpaused(address account);\n\n  bool public stoppable;\n  bool private _paused;\n  address public stopper;\n  string private constant UNSTOPPABLE = \"unstoppable\";\n  string private constant CONTRACT_IS_ACTIVE = \"contract_is_active\";\n  string private constant CONTRACT_IS_PAUSED = \"contract_is_paused\";\n  string private constant NOT_STOPPER = \"not_stopper\";\n\n\n  /*\n    @notice Modifier to make a function callable only when the contract is enable\n    to be paused\n  */\n  modifier whenStoppable() {\n    require(stoppable, UNSTOPPABLE);\n    _;\n  }\n\n  /*\n    @notice Modifier to make a function callable only when the contract is not paused\n  */\n  modifier whenNotPaused() {\n    require(!_paused, CONTRACT_IS_PAUSED);\n    _;\n  }\n\n  /*\n    @notice Modifier to make a function callable only when the contract is paused\n    */\n  modifier whenPaused() {\n    require(_paused, CONTRACT_IS_ACTIVE);\n    _;\n  }\n\n  /*\n    @notice  Modifier to make a function callable only by the pauser\n   */\n  modifier onlyPauser() {\n    require(stopper == msg.sender, NOT_STOPPER);\n    _;\n  }\n\n  /*\n    @notice Initialize the contract with the basic settings\n    @dev This initialize replaces the constructor but it is not called automatically.\n    It is necessary because of the upgradeability of the contracts. Either this function or the next can be used\n    @param _stopper The address that is authorized to stop this contract\n    @param _governor The address that will define when a change contract is authorized to do this unstoppable/stoppable again\n   */\n  function initialize(address _stopper, address _governor) public initializer {\n    initialize(_stopper, _governor, true);\n  }\n\n  /*\n    @notice Initialize the contract with the basic settings\n    @dev This initialize replaces the constructor but it is not called automatically.\n    It is necessary because of the upgradeability of the contracts. Either this function or the previous can be used\n    @param _stopper The address that is authorized to stop this contract\n    @param _governor The address that will define when a change contract is authorized to do this unstoppable/stoppable again\n    @param _stoppable Define if the contract starts being unstoppable or not\n   */\n  function initialize(address _stopper, address _governor, bool _stoppable) public initializer {\n    stoppable = _stoppable;\n    stopper = _stopper;\n    Governed.initialize(_governor);\n  }\n\n  /*\n    @notice Returns true if paused\n   */\n  function paused() public view returns (bool) {\n    return _paused;\n  }\n  /*\n    @notice Called by the owner to pause, triggers stopped state\n    @dev Should only be called by the pauser and when it is stoppable\n   */\n  function pause() public whenStoppable onlyPauser whenNotPaused {\n    _paused = true;\n    emit Paused(msg.sender);\n  }\n\n  /*\n    @notice Called by the owner to unpause, returns to normal state\n   */\n  function unpause() public onlyPauser whenPaused {\n    _paused = false;\n    emit Unpaused(msg.sender);\n  }\n\n\n  /*\n    @notice Switches OFF the stoppability of the contract; if the contract was paused\n    it will no longer be so\n    @dev Should be called through governance\n   */\n  function makeUnstoppable() public onlyAuthorizedChanger {\n    stoppable = false;\n  }\n\n\n  /*\n    @notice Switches ON the stoppability of the contract; if the contract was paused\n    before making it unstoppable it will be paused again after calling this function\n    @dev Should be called through governance\n   */\n  function makeStoppable() public onlyAuthorizedChanger {\n    stoppable = true;\n  }\n\n  /*\n    @notice Changes the address which is enable to stop this contract\n    @param newStopper Address of the newStopper\n    @dev Should be called through governance\n   */\n  function setStopper(address newStopper) public onlyAuthorizedChanger {\n    stopper = newStopper;\n  }\n\n  // Leave a gap betweeen inherited contracts variables in order to be\n  // able to add more variables in them later\n  uint256[50] private upgradeGap;\n}\n\n// File: contracts/OrderIdGenerator.sol\n\npragma solidity 0.5.8;\n\n\ncontract OrderIdGenerator {\n  uint256 private lastOrderId;\n\n  /*\n    @notice Initializes the contract, like a constructor but usable\n    in a proxy-pattern\n    @param _seedId Seed to create the ids from\n   */\n  function initialize(uint256 _seedId) internal {\n    lastOrderId = _seedId;\n  }\n\n  /*\n    @notice Returns the id that a new order should use, and assumes it\n    is created afterwards; this ids are unique for each order\n  */\n  function nextId() internal returns (uint256) {\n    ++lastOrderId;\n    return lastOrderId;\n  }\n\n  // Leave a gap betweeen inherited contracts variables in order to be\n  // able to add more variables in them later\n  uint256[50] private upgradeGap;\n}\n\n// File: openzeppelin-eth/contracts/ownership/Ownable.sol\n\npragma solidity ^0.5.2;\n\n\n/*\n * @title Ownable\n * @dev The Ownable contract has an owner address, and provides basic authorization control\n * functions, this simplifies the implementation of \"user permissions\".\n */\ncontract Ownable is Initializable {\n    address private _owner;\n\n    event OwnershipTransferred(address indexed previousOwner, address indexed newOwner);\n\n    /*\n     * @dev The Ownable constructor sets the original `owner` of the contract to the sender\n     * account.\n     */\n    function initialize(address sender) public initializer {\n        _owner = sender;\n        emit OwnershipTransferred(address(0), _owner);\n    }\n\n    /*\n     * @return the address of the owner.\n     */\n    function owner() public view returns (address) {\n        return _owner;\n    }\n\n    /*\n     * @dev Throws if called by any account other than the owner.\n     */\n    modifier onlyOwner() {\n        require(isOwner());\n        _;\n    }\n\n    /*\n     * @return true if `msg.sender` is the owner of the contract.\n     */\n    function isOwner() public view returns (bool) {\n        return msg.sender == _owner;\n    }\n\n    /*\n     * @dev Allows the current owner to relinquish control of the contract.\n     * It will not be possible to call the functions with the `onlyOwner`\n     * modifier anymore.\n     * @notice Renouncing ownership will leave the contract without an owner,\n     * thereby removing any functionality that is only available to the owner.\n     */\n    function renounceOwnership() public onlyOwner {\n        emit OwnershipTransferred(_owner, address(0));\n        _owner = address(0);\n    }\n\n    /*\n     * @dev Allows the current owner to transfer control of the contract to a newOwner.\n     * @param newOwner The address to transfer ownership to.\n     */\n    function transferOwnership(address newOwner) public onlyOwner {\n        _transferOwnership(newOwner);\n    }\n\n    /*\n     * @dev Transfers control of the contract to a newOwner.\n     * @param newOwner The address to transfer ownership to.\n     */\n    function _transferOwnership(address newOwner) internal {\n        require(newOwner != address(0));\n        emit OwnershipTransferred(_owner, newOwner);\n        _owner = newOwner;\n    }\n\n    uint256[50] private ______gap;\n}\n\n// File: openzeppelin-eth/contracts/token/ERC20/IERC20.sol\n\npragma solidity ^0.5.2;\n\n/*\n * @title ERC20 interface\n * @dev see https://eips.ethereum.org/EIPS/eip-20\n */\ninterface IERC20 {\n    function transfer(address to, uint256 value) external returns (bool);\n\n    function approve(address spender, uint256 value) external returns (bool);\n\n    function transferFrom(address from, address to, uint256 value) external returns (bool);\n\n    function totalSupply() external view returns (uint256);\n\n    function balanceOf(address who) external view returns (uint256);\n\n    function allowance(address owner, address spender) external view returns (uint256);\n\n    event Transfer(address indexed from, address indexed to, uint256 value);\n\n    event Approval(address indexed owner, address indexed spender, uint256 value);\n}\n\n// File: contracts/CommissionManager.sol\n\npragma solidity 0.5.8;\n\n\n\n\n\n\n\n\n/*\n  @notice This contract is in charge of keeping track of the charged commissions\n  and calculating the commissions to reserve/charge depending on the operation and\n  the amount of the order.DESPITE WORKING AS A TRACKER IT DOESN'T KEEP THE FUNDS\n  @dev Should only be callable by dex, so this contract inherits from Ownable and should\n  have dex as its owner\n */\ncontract CommissionManager is Governed, Ownable {\n  using SafeMath for uint256;\n\n  /* mapping for the commission collected by MOCDEX */\n  mapping(address => uint256) public exchangeCommissions;\n\n  address public beneficiaryAddress;\n  uint256 public commissionRate;\n  uint256 public cancelationPenaltyRate;\n  uint256 public expirationPenaltyRate;\n  uint256 public constant RATE_PRECISION = uint256(10**18);\n  uint256 public minimumCommission;\n\n  /*\n    @notice Checks that _rate is a valid rate, i.e. it is between 1(RATE_PRECISION)\n    and 0; fails otherwise\n    @param _rate Rate to be checked\n  */\n  modifier isValidRate(uint256 _rate) {\n    require(_rate <= RATE_PRECISION, \"rate should to be in relation to 1\");\n    _;\n  }\n\n  /*\n    @notice Checks that _address is not zero; fails otherwise\n    @param _address Address to be checked\n  */\n  modifier isValidAddress(address _address, string memory message) {\n    require(_address != address(0), message);\n    _;\n  }\n\n  /*\n    @notice Calculates the commission to be charged for an order matching, also adds the said\n    amount as a charged commission\n    IT DOESN'T KEEP THE FUNDS NOR MOVES ANY\n    @param _orderAmount order's exchangeableAmount amount\n    @param _matchedAmount the order amount that is being exchanged in this iteration\n    @param _commission the order reserved commission\n    @param _tokenAddress the token that it's being exchanged\n    @return the commission amount that its being charged in this iteration\n  */\n  function chargeCommissionForMatch(uint256 _orderAmount, uint256 _matchedAmount, uint256 _commission, address _tokenAddress)\n    external\n    onlyOwner\n    returns (uint256)\n  {\n    assert(_orderAmount >= _matchedAmount);\n    uint256 finalCommission = _matchedAmount.mul(_commission).div(_orderAmount);\n    exchangeCommissions[_tokenAddress] = exchangeCommissions[_tokenAddress].add(finalCommission);\n    return finalCommission;\n  }\n\n  /*\n    @notice Calculates the commission to be charged for an expiration/cancelation, also adds the said\n    amount as a charged commission\n    IT DOESN'T KEEP THE FUNDS NOR MOVES ANY\n    @param _commission The remaining of the commission reserved at the insertion of the order\n    @param _tokenAddress The address of the token\n    @param _isExpiration If true order is taken as expired; else is taken as cancelled\n    @return the commission amount that its being charged in this iteration\n  */\n  function chargeExceptionalCommission(uint256 _commission, address _tokenAddress, bool _isExpiration) external onlyOwner returns (uint256) {\n    return chargeCommission(_commission, _isExpiration ? expirationPenaltyRate : cancelationPenaltyRate, _tokenAddress);\n  }\n\n  /*\n    @notice Calculates the commission to be reserved in the insertion of an order\n    IT DOESN'T KEEP THE FUNDS NOR MOVES ANY NOR TRACKS THE RETURNED AS CHARGED COMMISSION(IT IS JUST RESERVED)\n    @param _amount Order locked amount\n    @param _price Price equivalent to 1 DOC\n   */\n  function calculateInitialFee(uint256 _amount, uint256 _price) external view returns (uint256) {\n    uint256 _minimumFixed = minimumCommission.mul(RATE_PRECISION).div(_price);\n    uint256 _initialFee = _amount.mul(commissionRate).div(RATE_PRECISION);\n    return _minimumFixed.add(_initialFee);\n  }\n\n  /*\n    @param _beneficiaryAddress address to transfer the commission when instructed to\n  */\n  function setBeneficiaryAddress(address _beneficiaryAddress) external onlyAuthorizedChanger {\n    require(_beneficiaryAddress != address(0), \"beneficiaryAddress cannot be null\");\n    beneficiaryAddress = _beneficiaryAddress;\n  }\n\n  /*\n    @param _commissionRate wad from 0 to 1 that represents the rate of the order amount to be charged as commission\n  */\n  function setCommissionRate(uint256 _commissionRate) external onlyAuthorizedChanger isValidRate(_commissionRate) {\n    commissionRate = _commissionRate;\n  }\n\n  /*\n    @param _cancelationPenaltyRate wad from 0 to 1 that represents the rate of the commission to charge as cancelation penalty, 1 represents the full commission\n  */\n  function setCancelationPenaltyRate(uint256 _cancelationPenaltyRate) external onlyAuthorizedChanger isValidRate(_cancelationPenaltyRate) {\n    cancelationPenaltyRate = _cancelationPenaltyRate;\n  }\n\n  /*\n    @param _expirationPenaltyRate wad from 0 to 1 that represents the rate of the commission to charge when the order expire, 1 represents the full commission\n  */\n  function setExpirationPenaltyRate(uint256 _expirationPenaltyRate) external onlyAuthorizedChanger isValidRate(_expirationPenaltyRate) {\n    expirationPenaltyRate = _expirationPenaltyRate;\n  }\n\n  /*\n    @param _minimumCommission is the minimum commission in DOC reserved in commission\n  */\n  function setMinimumCommission(uint256 _minimumCommission) external onlyAuthorizedChanger  {\n    minimumCommission = _minimumCommission;\n  }\n\n  /*\n    @notice Sets the charged commissions back to 0 for a given token\n    It should be called after a withdrawal of the charged commissions\n    IT DOESN'T MOVE ANY FUNDS\n    @param _tokenAddress Address of the contract which manages the token\n    in which the commissions were charged\n   */\n  function clearExchangeCommissions(address _tokenAddress) external onlyOwner {\n    exchangeCommissions[_tokenAddress] = 0;\n  }\n\n  /*\n    @dev This function must initialize every variable in storage, this is necessary because of the proxy\n    pattern we are using. The initializer modifier disables this function once its called so it prevents\n    that someone else calls it without the deployer noticing. Of course they may block your deploys but that\n    would be an extremely unlucky scenario. onlyAuthorizedChanger cannot be used here since the governor is not set yet\n    @param _beneficiaryAddress address to transfer the commission when instructed to\n    @param _commissionRate wad from 0 to 1 that represents the rate of the order amount to be charged as commission\n    @param _cancelationPenaltyRate wad from 0 to 1 that represents the rate of the commission to charge as cancelation penalty, 1 represents the full commission\n    @param _expirationPenaltyRate wad from 0 to 1 that represents the rate of the commission to charge when the order expire, 1 represents the full commission\n    @param _governor Address in charge of determining who is authorized and who is not\n    @param _owner Dex contract\n */\n  function initialize(\n    address _beneficiaryAddress,\n    uint256 _commissionRate,\n    uint256 _cancelationPenaltyRate,\n    uint256 _expirationPenaltyRate,\n    address _governor,\n    address _owner,\n    uint256 _minimumCommission\n  )\n    external\n    initializer\n    isValidAddress(_beneficiaryAddress, \"beneficiaryAddress cannot be null\")\n    isValidAddress(_governor, \"governor cannot be null\")\n    isValidAddress(_owner, \"owner cannot be null\")\n  {\n    require(_commissionRate <= RATE_PRECISION, \"commissionRate should to be in relation to 1\");\n    require(_cancelationPenaltyRate <= RATE_PRECISION, \"cancelationPenaltyRate should to be in relation to 1\");\n    require(_expirationPenaltyRate <= RATE_PRECISION, \"expirationPenaltyRate should to be in relation to 1\");\n\n    beneficiaryAddress = _beneficiaryAddress;\n    commissionRate = _commissionRate;\n    minimumCommission = _minimumCommission;\n    cancelationPenaltyRate = _cancelationPenaltyRate;\n    expirationPenaltyRate = _expirationPenaltyRate;\n    Governed.initialize(_governor);\n    Ownable.initialize(_owner);\n  }\n\n  /*\n    @notice Calculates the commission to be charged for a given percentage of the reserved commission,\n    also adds the said amount as a charged commission\n    IT DOESN'T KEEP THE FUNDS NOR MOVES ANY\n    @param _fullCommission The remaining of the commission reserved at the insertion of the order\n    @param _tokenAddress The address of the token\n    @param _rate Rate of the commission to be charged\n    @return the commission amount that its being charged in this iteration\n  */\n  function chargeCommission(uint256 _fullCommission, uint256 _rate, address _tokenAddress) private returns (uint256) {\n    uint256 finalCommission = _fullCommission.mul(_rate).div(RATE_PRECISION);\n    exchangeCommissions[_tokenAddress] = exchangeCommissions[_tokenAddress].add(finalCommission);\n    return finalCommission;\n  }\n\n  // Leave a gap betweeen inherited contracts variables in order to be\n  // able to add more variables in them later\n  uint256[50] private upgradeGap;\n}\n\n// File: contracts/interface/IPriceProvider.sol\n\npragma solidity 0.5.8;\n\n/*\n * @notice Get price of a Token. See https://github.com/money-on-chain/OMoC-Decentralized-Oracle\n * @dev Interface of OMoC-Decentralized-Oracle, compatible with MOC.\n */\ninterface IPriceProvider {\n  function peek() external view returns (bytes32, bool);\n}\n\n// File: contracts/libs/SafeTransfer.sol\n\npragma solidity 0.5.8;\n\n\n\nlibrary SafeTransfer {\n  event TransferFailed(address indexed _tokenAddress, address indexed _to, uint256 _amount, bool _isRevert);\n\n  /*\n   * @dev Wraps an RRC20 transfer with a low level call to handle revert secenario\n   * Emits TransferFailed with _isRevert flag on in case it actually revert, false on case the call result is false\n   * @param _token ERC20 token to transfer from.\n   * @param _to receipint address\n   * @param _amount to be transfere\n   * @return true if completed, false if reverted or token returns false\n   */\n  function doTransfer(IERC20 _token, address _to, uint256 _amount) internal returns (bool) {\n    // This creates a low level call to the _token\n    // solium-disable-next-line security/no-low-level-calls\n    (bool success, bytes memory returnData) = address(_token).call(\n      abi.encodePacked( // This encodes the function to call and the parameters to pass to that function\n        _token.transfer.selector, // This is the function identifier of the function we want to call\n        abi.encode(_to, _amount) // This encodes the parameter we want to pass to the function\n      )\n    );\n    if (success) {\n      // transfer completed successfully (did not revert)\n      bool callResult = abi.decode(returnData, (bool));\n      // transfer could have return false thou, indicating the operation was not completed\n      if (!callResult) emit TransferFailed(address(_token), _to, _amount, false);\n      return callResult;\n    } else {\n      // transfer reverted\n      emit TransferFailed(address(_token), _to, _amount, true);\n      return false;\n    }\n  }\n}\n\n// File: contracts/libs/TickState.sol\n\npragma solidity 0.5.8;\n\n\n\n\n/*\n  @notice This library manages the inter-tick state(not intra-tick)\n */\nlibrary TickState {\n  using SafeMath for uint256;\n\n  /*\n    @notice notifies the start of the tick\n    @param baseTokenAddress the base token of the pair\n    @param secondaryTokenAddress the secondary token of the pair\n    @param number the tick number that just started\n */\n  event TickStart(address indexed baseTokenAddress, address indexed secondaryTokenAddress, uint64 number);\n\n  /*\n    @notice notifies the end of the tick and its result\n    @param baseTokenAddress the base token of the pair\n    @param secondaryTokenAddress the secondary token of the pair\n    @param number the tick number that just finished\n    @param nextTickBlock the block number after wich one it can be excecuted the next tick\n    @param closingPrice the price [using priceComparisonPrecision] used to match the orders this tick\n */\n  event TickEnd(\n    address indexed baseTokenAddress,\n    address indexed secondaryTokenAddress,\n    uint64 indexed number,\n    uint256 nextTickBlock,\n    uint256 closingPrice\n  );\n\n  /*\n    @param expectedOrdersForTick amount of orders expected to match in each tick\n    @param maxBlocksForTick the max amount of blocks to await until allowing to run the tick\n    @param minBlocksForTick the min amount of blocks to await until allowing to run the tick\n */\n  struct Config {\n    uint256 expectedOrdersForTick;\n    uint256 maxBlocksForTick;\n    uint256 minBlocksForTick;\n  }\n\n  /*\n    @param number the current tick number\n    @param nextTickBlock the block number after wich one it can be excecuted the next tick\n    @param lastTickBlock the block number in which one the last tick was executed\n    @param blockNumberWhenTickStarted 0 when the contract is reciving orders,\n      the block number in which one the tick was executed as the tick started\n  */\n  struct Data {\n    uint256 nextTickBlock;\n    uint256 lastTickBlock;\n    uint256 blockNumberWhenTickStarted;\n    uint64 number;\n  }\n\n  /*\n    @dev reverts if the block since which this tick matching can be executed has not been reached yet\n  */\n  function startTick(Data storage _self, address _baseTokenAddress, address _secondaryTokenAddress) internal {\n    require(block.number >= _self.nextTickBlock, \"Next tick not reached\");\n    _self.blockNumberWhenTickStarted = block.number;\n    emit TickStart(_baseTokenAddress, _secondaryTokenAddress, _self.number);\n  }\n\n  /*\n    @dev Given Tick processing is completed, nextTick calculates and sets the tick state for the\n    following execution. Also emitts the TickEnd event.\n    @param _baseTokenAddress the base token of the pair involved in this tick\n    @param _secondaryTokenAddress the secondary token of the pair involved in this tick\n    @param _config ticks confirguration\n    @param _closingPrice emergent price resulted from this ticks matching\n    @param _actualOrders amount of orders matched on this ticks execution\n  */\n  function nextTick(\n    Data storage _self,\n    address _baseTokenAddress,\n    address _secondaryTokenAddress,\n    Config memory _config,\n    uint256 _closingPrice,\n    uint256 _actualOrders\n  ) internal {\n    assert(_self.blockNumberWhenTickStarted != 0);\n    uint64 previousTickNumber = _self.number;\n\n    // Calculate the minimum amount of blocks until the contract allows to run the tick again\n    uint256 blocksUntilNextTick = calculateBlocks(\n      _config.expectedOrdersForTick,\n      _self.lastTickBlock,\n      _config.maxBlocksForTick,\n      _config.minBlocksForTick,\n      Math.max(_actualOrders, 1),\n      _self.blockNumberWhenTickStarted\n    );\n\n    _self.lastTickBlock = _self.blockNumberWhenTickStarted;\n    _self.nextTickBlock = _self.blockNumberWhenTickStarted + blocksUntilNextTick;\n    _self.number = _self.number + 1;\n    _self.blockNumberWhenTickStarted = 0;\n\n    emit TickEnd(_baseTokenAddress, _secondaryTokenAddress, previousTickNumber, _self.nextTickBlock, _closingPrice);\n  }\n\n  /*\n    @notice Calculate the block that should pass until the next tick is available\n    @param _expectedOrdersForTick Ideal amount of matching orders per tick\n    @param _lastTickBlock The block in which the last tick was run\n    @param _maxBlocksForTick The max blocks between two ticks\n    @param _minBlocksForTick The mix blocks between two ticks\n    @param _actualOrders The amount of matched orders\n    @param _currentBlockNumber The current block number\n    @return Blocks that should pass until the next tick\n  */\n  function calculateBlocks(\n    uint256 _expectedOrdersForTick,\n    uint256 _lastTickBlock,\n    uint256 _maxBlocksForTick,\n    uint256 _minBlocksForTick,\n    uint256 _actualOrders,\n    uint256 _currentBlockNumber\n  ) private pure returns (uint256) {\n    // The amount of blocks since the previous tick until the current one\n    uint256 blocksForLastTick = _currentBlockNumber - _lastTickBlock;\n\n    // The minimum amount of blocks until the next tick, given by linear regression\n    uint256 tentativeBlocksUntilNextTick = _expectedOrdersForTick.mul(blocksForLastTick).div(_actualOrders);\n\n    // if the tentativeBlocksUntilNextTick is greater than the max tolerated, sets it as _maxBlocksForTick\n    tentativeBlocksUntilNextTick = Math.min(tentativeBlocksUntilNextTick, _maxBlocksForTick);\n\n    // if the tentativeBlocksUntilNextTick is lower than the min tolerated, sets it as _minBlocksForTick\n    tentativeBlocksUntilNextTick = Math.max(tentativeBlocksUntilNextTick, _minBlocksForTick);\n\n    return tentativeBlocksUntilNextTick;\n  }\n}\n\n// File: contracts/libs/MoCExchangeLib.sol\n\npragma solidity 0.5.8;\n\n\n\n\n\n\n\n\n\n/*\n  @notice A library that manages the orderbook and pending queue of the pairs listed in the MoCDecentralizedExchange\n */\nlibrary MoCExchangeLib {\n  using TickState for TickState.Data;\n  using SafeMath for uint256;\n  uint256 constant RATE_PRECISION = uint256(10**18);\n  /*\n    @notice Posible types of a match depending on which order is filled\n    @dev At least one order has to be filled in any match in our exchange\n   */\n  enum MatchType {BUYER_FILL, SELLER_FILL, DOUBLE_FILL}\n\n  /*\n    @notice Posible types of a match depending on which order is filled\n    @dev At least one order has to be filled in any match in our exchange\n   */\n  enum OrderType {LIMIT_ORDER, MARKET_ORDER}\n\n  /*\n    @notice Posible states of a tick. RECEIVING_ORDERS can be seen as the\n    non-running tick state as there is no computation pending yet, the exchange is\n    waiting for orders to come\n   */\n  enum TickStage {RECEIVING_ORDERS, RUNNING_SIMULATION, RUNNING_MATCHING, MOVING_PENDING_ORDERS}\n\n  // intentionally using the biggest possible uint256\n  // so it doesn't conflict with valid ids\n  uint256 constant NO_HINT = ~uint256(0);\n\n  /*\n    @notice A new order has been inserted in the orderbook, and it is ready to be matched\n    @param id Id of the order\n    @param sender Address owner of the order\n    @param baseTokenAddress Address of the token used as base in the pair(it is the token being used as currency,\n    to pay the good, the secondary token)\n    @param secondaryTokenAddress Address of the token used as secondary in the pair(it is the good\n    being exchanged in this pair)\n    @param exchangeableAmount Amount that was left to be exchanged\n    @param reservedCommission Commission reserved to be charged later\n    @param price Target price of the order[base/secondary] or priceMultiplier [dimentionless] [pricePrecision]\n    @param expiresInTick Number of tick in which the order can no longer be matched\n    @param isBuy The order is a buy order\n    @param orderType The order's type; LIMIT_ORDER or MARKET_ORDER\n   */\n  event NewOrderInserted(\n    uint256 indexed id,\n    address indexed sender,\n    address baseTokenAddress,\n    address secondaryTokenAddress,\n    uint256 exchangeableAmount,\n    uint256 reservedCommission,\n    uint256 price,\n    uint256 multiplyFactor,\n    uint64 expiresInTick,\n    bool isBuy,\n    MoCExchangeLib.OrderType orderType\n  );\n\n  /*\n    @notice All the charged commission for a given token was withdrawn\n    @param token The address of the withdrawn tokens\n    @param commissionBeneficiary Receiver of the tokens\n    @param withdrawnAmount Amount that was withdrawn\n   */\n  event CommissionWithdrawn(address token, address commissionBeneficiary, uint256 withdrawnAmount);\n\n  /*\n    @notice A new order has been inserted in the pending queue. It is waiting to be moved to the orderbook\n    @dev On the RSK network, having an event with only one parameter which is indexed breaks the web3\n    importer, so a dummy argument is added.\n   */\n  event NewOrderAddedToPendingQueue(uint256 indexed id, uint256 notIndexedArgumentSoTheThingDoesntBreak);\n\n  /*\n    @notice emitted when and expired Order has been process and it funds returned\n    @param orderId id of the expired order processed\n    @param owner the secondary token of the pair\n    @param returnedAmount actual token amount returned to the owner\n    @param commission applied as penalizacion for the expiration\n    @param returnedCommission the commission returned as the expiration does not consume the whole commission\n  */\n  event ExpiredOrderProcessed(\n    uint256 indexed orderId,\n    address indexed owner,\n    uint256 returnedAmount,\n    uint256 commission,\n    uint256 returnedCommission\n  );\n\n  /*\n    @notice notifies the buyer that their order matched\n    @param orderId the buyer's order\n    @param amountSent the amount of baseToken [using baseTokenDecimals] sent to the seller\n    @param commission the amount of baseToken [using baseTokenDecimals] that was charged as commission\n    @param change the amount of baseToken [using baseTokenDecimals] sent back to the buyer\n    @param received the amount of secondaryToken [using secondaryTokenDecimals] received in exchange\n    @param remainingAmount = totalOrderAmount - (amountSent + change), if remainingAmount is 0, the order is filled and removed from the orderbook.\n    @param matchPrice the price [using priceComparisonPrecision] at which the order matched\n    @param tickNumber the tick's number in witch the order matched\n  */\n  event BuyerMatch(\n    uint256 indexed orderId,\n    uint256 amountSent,\n    uint256 commission,\n    uint256 change,\n    uint256 received,\n    uint256 remainingAmount,\n    uint256 matchPrice,\n    uint64 tickNumber\n  );\n\n  /*\n    @notice notifies the seller that their order matched\n    @param orderId the seller's order\n    @param amountSent the amount of secondaryToken [using secondaryTokenDecimals] sent to the buyer\n    @param commission the amount of secondaryToken [using baseTokenDecimals] that was charged as commission\n    @param received the total amount the seller recieved == expected + surplus.\n    @param surplus the amount of baseToken [using baseTokenDecimals] the seller recieved additional to the expected.\n    @param remainingAmount = totalOrderAmount - amountSent, if remainingAmount is 0, the order is filled and removed from the orderbook.\n    @param matchPrice the price [using priceComparisonPrecision] at which the order matched\n    @param tickNumber the tick's number in witch the order matched\n  */\n  event SellerMatch(\n    uint256 indexed orderId,\n    uint256 amountSent,\n    uint256 commission,\n    uint256 received,\n    uint256 surplus,\n    uint256 remainingAmount,\n    uint256 matchPrice,\n    uint64 tickNumber\n  );\n\n  /*\n    @notice Struct representing one of the token of a pair. If it's a base Token, orderbook will have buy Orders\n   */\n  struct Token {\n    Data orderbook;\n    IERC20 token;\n  }\n\n  /*\n    @notice Struct representing a pair being exchanged in this exchange\n   */\n  struct Pair {\n    Token baseToken;\n    Token secondaryToken;\n    IPriceProvider priceProvider;\n    TickState.Data tickState;\n    TickPaginationMemory pageMemory;\n    TickStage tickStage;\n    uint256 priceComparisonPrecision;\n    uint256 lastClosingPrice;\n    bool disabled;\n    uint256 emaPrice;\n    uint256 smoothingFactor;\n  }\n\n  /*\n    @notice Struct used as an auxiliar storage to keep the cross-tick necessary data i.e. data that is volatile between two\n    different ticks but has to be persisted for a given tick\n   */\n  struct TickPaginationMemory {\n    uint256 emergentPrice;\n    uint256 matchesAmount;\n    uint256[] hintIds;\n    uint256 hintIdsIndex;\n    Order lastBuyMatch;\n    Order lastSellMatch;\n    uint256 lastBuyLimitOrderId;\n    uint256 lastBuyMarketOrderId;\n    uint256 lastSellLimitOrderId;\n    uint256 lastSellMarketOrderId;\n    uint256 marketPrice;\n  }\n\n  /*\n    @notice Struct that contains all the order of the same type(buy or sell) of a given pair. It has two internal structures,\n    the orderbook itself and a pendinQueue.\n    @dev The decision to merge the orderbook and pendingQueue into a single struct was made to be able to have both types of\n    orders in the same mapping making the movement between the two structs much cheaper\n   */\n  struct Data {\n    mapping(uint256 => Order) orders;\n    uint256 firstId;\n    uint256 firstMarketOrderId;\n    uint256 length;\n    uint256 marketOrderLength;\n    uint256 limitOrderLength;\n    uint256 firstPendingToPopId;\n    uint256 lastPendingToPopId;\n    uint256 firstPendingMarketOrderToPopId;\n    uint256 lastPendingMarketOrderToPopId;\n    uint256 amountOfPendingOrders;\n    uint256 amountOfPendingMarketOrders;\n    bool orderDescending;\n  }\n\n  /*\n    @notice Struct representing a single order\n    @dev The next attribute is a reference to the next order in the structure this order.\n    There are two types: MarketOrder (with multiplyFactor and volumen) and LimitOrder\n  */\n  struct Order {\n    OrderType orderType;\n    uint256 id;\n    uint256 exchangeableAmount;\n    uint256 reservedCommission;\n    uint256 price;\n    uint256 multiplyFactor;\n    uint256 next;\n    address owner;\n    uint64 expiresInTick;\n  }\n\n  /*\n    @notice Inserts an order in an orderbook without a hint\n    @dev The type of the order is given implicitly by the data structure where it is saved\n    @param self The data structure in where the order will be inserted\n    @param _orderId Id of the order to be inserted\n    @param _sender Owner of the new order\n    @param _exchangeableAmount Amount that was left to be exchanged\n    @param _reservedCommission Commission reserved to be charged later\n    @param _price Target price of the order[base/secondary]\n    @param _expiresInTick Number of tick in which the order can no longer be matched\n  */\n  function insertLimitOrder(\n    Data storage self,\n    uint256 _orderId,\n    address _sender,\n    uint256 _exchangeableAmount,\n    uint256 _reservedCommission,\n    uint256 _price,\n    uint64 _expiresInTick\n  ) public {\n    insertLimitOrder(\n      self,\n      _orderId,\n      _sender,\n      _exchangeableAmount,\n      _reservedCommission,\n      _price,\n      _expiresInTick,\n      findPreviousOrderToPrice(self, _price)\n    );\n  }\n\n  /*\n    @notice Inserts a market order in an orderbook without a hint\n    @dev The type of the order is given implicitly by the data structure where it is saved\n    @param self The data structure in where the order will be inserted\n    @param _orderId Id of the order to be inserted\n    @param _exchangeableAmount Quantity of tokens to addd\n    @param _reservedCommission Commission reserved to be charged later\n    @param _multiplyFactor Target price of the order[base/secondary]\n    @param _expiresInTick Number of tick in which the order can no longer be matched\n  */\n  function insertMarketOrder(\n    Data storage self,\n    uint256 _orderId,\n    uint256 _exchangeableAmount,\n    uint256 _reservedCommission,\n    uint256 _multiplyFactor,\n    uint64 _expiresInTick\n  ) public {\n    insertMarketOrder(\n      self,\n      _orderId,\n      _exchangeableAmount,\n      _reservedCommission,\n      _multiplyFactor,\n      _expiresInTick,\n      findPreviousMarketOrderToMultiplyFactor(self, _multiplyFactor)\n    );\n  }\n\n  /*\n    @notice Withdraws all the already charged(because of a matching, a cancellation or an expiration)\n    commissions of a given token\n    @param token Address of the token to withdraw the commissions from\n  */\n  function withdrawCommissions(address token, CommissionManager _commissionManager) public {\n    uint256 amountToWithdraw = _commissionManager.exchangeCommissions(token);\n    _commissionManager.clearExchangeCommissions(token);\n    address commissionBeneficiary = _commissionManager.beneficiaryAddress();\n    bool success = IERC20(token).transfer(commissionBeneficiary, amountToWithdraw);\n    require(success, \"Transfer failed\");\n    emit CommissionWithdrawn(token, commissionBeneficiary, amountToWithdraw);\n  }\n\n\n  /*\n    @notice Inserts an order in an orderbook with a hint\n    @dev The type of the order is given implicitly by the data structure where it is saved\n    @param self The data structure in where the order will be inserted\n    @param _orderId Id of the order to be inserted\n    @param _sender Owner of the new order\n    @param _exchangeableAmount Amount that was left to be exchanged\n    @param _reservedCommission Commission reserved to be charged later\n    @param _price Target price of the order[base/secondary]\n    @param _expiresInTick Number of tick in which the order can no longer be matched\n    @param  _intendedPreviousOrderId Hint id of the order to be before the new order in the orderbook\n  */\n  function insertLimitOrder(\n    Data storage self,\n    uint256 _orderId,\n    address _sender,\n    uint256 _exchangeableAmount,\n    uint256 _reservedCommission,\n    uint256 _price,\n    uint64 _expiresInTick,\n    uint256 _intendedPreviousOrderId\n  ) public {\n    validatePreviousOrder(self, _price, _intendedPreviousOrderId);\n    createOrder(self, _orderId, _sender, _exchangeableAmount, _reservedCommission, _price, _expiresInTick);\n    positionOrder(self, _orderId, _intendedPreviousOrderId);\n  }\n\n  /*\n    @notice Inserts an order in an orderbook with a hint\n    @dev The type of the order is given implicitly by the data structure where it is saved\n    @param self The data structure in where the order will be inserted\n    @param _orderId Id of the order to be inserted\n    @param _exchangeableAmount Amount that was left to be exchanged\n    @param _reservedCommission Commission reserved to be charged later\n    @param _expiresInTick Number of tick in which the order can no longer be matched\n    @param  _intendedPreviousOrderId Hint id of the order to be before the new order in the orderbook\n  */\n  function insertMarketOrder(\n    Data storage self,\n    uint256 _orderId,\n    uint256 _exchangeableAmount,\n    uint256 _reservedCommission,\n    uint256 _multiplyFactor,\n    uint64 _expiresInTick,\n    uint256 _intendedPreviousOrderId\n  ) public {\n    validatePreviousMarketOrder(self, _multiplyFactor, _intendedPreviousOrderId);\n    createMarketOrder(self, _orderId, msg.sender, _exchangeableAmount, _reservedCommission, _multiplyFactor, _expiresInTick);\n    positionMarketOrder(self, _orderId, _intendedPreviousOrderId);\n  }\n\n  /*\n    @notice Inserts an order in a pending queue\n    @dev The type of the order is given implicitly by the data structure where it is saved\n    @param self The data structure in where the order will be inserted\n    @param _orderId Id of the order to be inserted\n    @param _sender Owner of the new order\n    @param _exchangeableAmount Amount that was left to be exchanged\n    @param _reservedCommission Commission reserved to be charged later\n    @param _price Target price of the order[base/secondary]\n    @param _expiresInTick Number of tick in which the order can no longer be matched\n  */\n  function insertLimitOrderAsPending(\n    Data storage self,\n    uint256 _orderId,\n    address _sender,\n    uint256 _exchangeableAmount,\n    uint256 _reservedCommission,\n    uint256 _price,\n    uint64 _expiresInTick\n  ) public {\n    self.orders[_orderId] = Order(\n      OrderType.LIMIT_ORDER,\n      _orderId,\n      _exchangeableAmount,\n      _reservedCommission,\n      _price,\n      0,\n      0,\n      _sender,\n      _expiresInTick\n    );\n    positionOrderAsPending(self, _orderId);\n  }\n\n  /*\n  @notice Hook that gets triggered when the tick of a given pair finishes.\n  @dev Marks the state of the tick as finished(it is receiving orders again),\n  sets the nextTick configs and cleans the pageMemory\n  @param _pair The group of tokens\n  @param _tickConfig The tick configuration\n  for the execution of a tick of a given pair\n  */\n  function onTickFinish(Pair storage _pair, TickState.Config storage _tickConfig) public {\n    assert(_pair.tickStage == TickStage.MOVING_PENDING_ORDERS);\n    _pair.tickStage = TickStage.RECEIVING_ORDERS;\n    _pair.tickState.nextTick(\n      address(_pair.baseToken.token),\n      address(_pair.secondaryToken.token),\n      _tickConfig,\n      _pair.pageMemory.emergentPrice,\n      _pair.pageMemory.matchesAmount\n    );\n\n    // make sure nothing from this page is reused in the next\n    delete (_pair.pageMemory);\n  }\n\n  /*\n    @notice returns the corresponding user amount. Emits the CancelOrder event\n    @param _pair Token Pair involved in the canceled Order\n    @param _orderId Order id to cancel\n    @param _previousOrderIdHint previous order in the orderbook, used as on optimization to search for.\n    @param _isBuy true if it's a buy order, meaning the funds should be from base Token\n  */\n  function doCancelOrder(\n    Pair storage _pair,\n    uint256 _orderId,\n    uint256 _previousOrderIdHint,\n    bool _isBuy\n    )\n    public returns (uint256, uint256)\n  {\n    Token storage token = _isBuy ? _pair.baseToken : _pair.secondaryToken;\n    Order storage toRemove = get(token.orderbook, _orderId);\n    require(toRemove.id != 0, \"Order not found\");\n    // Copy order needed values before deleting it\n    (uint256 exchangeableAmount, uint256 reservedCommission, address owner) = (\n      toRemove.exchangeableAmount,\n      toRemove.reservedCommission,\n      toRemove.owner\n    );\n    removeOrder(token.orderbook, toRemove, _previousOrderIdHint);\n    require(owner == msg.sender, \"Not order owner\");\n    return (exchangeableAmount, reservedCommission);\n  }\n\n  /*\n    @notice Inserts a market order in a pending queue\n    @dev The type of the order is given implicitly by the data structure where it is saved\n    @param self The data structure in where the order will be inserted\n    @param _orderId Id of the order to be inserted\n    @param _sender Owner of the new order\n    @param _exchangeableAmount The quantity of tokens that was left to be exchanged\n    @param _reservedCommission Commission reserved to be charged later\n    @param _multiplyFactor Multiply factor to compute the the price of a market order\n    @param _expiresInTick Number of tick in which the order can no longer be matched\n  */\n  function insertMarketOrderAsPending(\n    Data storage self,\n    uint256 _orderId,\n    address _sender,\n    uint256 _exchangeableAmount,\n    uint256 _reservedCommission,\n    uint256 _multiplyFactor,\n    uint64 _expiresInTick\n  ) public {\n    self.orders[_orderId] = Order(\n      OrderType.MARKET_ORDER,\n      _orderId, _exchangeableAmount,\n      _reservedCommission,\n      0,\n      _multiplyFactor,\n      0,\n      _sender,\n      _expiresInTick\n    );\n    positionMarketOrderAsPending(self, _orderId);\n  }\n\n  /*\n    @notice Checks that the order should be in the place where it is trying to be inserted, reverts otherwise\n    @param _price Target price of the new order\n    @param _intendedPreviousOrderId Id of the order which is intended to be the order before the new one being inserted,\n    if 0 it is asumed to be put at the start\n   */\n  function validatePreviousOrder(Data storage self, uint256 _price, uint256 _intendedPreviousOrderId) public view {\n    if (_intendedPreviousOrderId == 0) {\n      // order is intended to be the first in the Data\n      validateIntendedFirstOrderInTheData(self, _price);\n    } else {\n      validateOrderIntendedPreviousOrder(self, _intendedPreviousOrderId, _price);\n    }\n  }\n\n    /*\n    @notice Checks that the order should be in the place where it is trying to be inserted, reverts otherwise\n    @param _multiplyFactor Target multiplyFactor of the new order\n    @param _intendedPreviousOrderId Id of the order which is intended to be the order before the new one being inserted,\n    if 0 it is asumed to be put at the start\n   */\n  function validatePreviousMarketOrder(Data storage self, uint256 _multiplyFactor, uint256 _intendedPreviousOrderId) public view {\n    if (_intendedPreviousOrderId == 0) {\n      // order is intended to be the first in the Data\n      validateIntendedFirstMarketOrderInTheData(self, _multiplyFactor);\n    } else {\n      validateMarketOrderIntendedPreviousOrder(self, _intendedPreviousOrderId, _multiplyFactor);\n    }\n  }\n\n  /*\n    @notice Checks that the order should be in the first place of the orderbook where it is trying to be inserted\n    @param _price Target price of the new order\n   */\n  function validateIntendedFirstOrderInTheData(Data storage self, uint256 _price) private view {\n    if (self.limitOrderLength != 0) {\n      // there is one or more orders in the Data, so the price should be the most competitive\n      Order storage firstOrder = first(self);\n      require(priceGoesBefore(self, _price, firstOrder.price), \"Price doesnt belong to start\");\n    }\n  }\n\n  /*\n    @notice Checks that the market order should be in the first place of the orderbook where it is trying to be inserted\n    @param _multiplyFactor Target multiplyFactor of the new order\n  */\n  function validateIntendedFirstMarketOrderInTheData(Data storage self, uint256 _multiplyFactor) private view {\n    if (self.marketOrderLength != 0) {\n      // there is one or more orders in the Data, so the price should be the most competitive\n      Order storage firstOrder = firstMarketOrder(self);\n      require(multiplyFactorGoesBefore(self, _multiplyFactor, firstOrder.multiplyFactor), \"Multiply factor doesnt belong to start\");\n    }\n  }\n\n  /*\n    @notice Checks that the order should be in the place where it is trying to be inserted, reverts otherwise\n    @param _price Target price of the new order\n    @param _intendedPreviousOrderId Id of the order which is intended to be the order before the new one being inserted\n   */\n  function validateOrderIntendedPreviousOrder(Data storage self, uint256 _intendedPreviousOrderId, uint256 _price) private view {\n    Order storage previousOrder = get(self, _intendedPreviousOrderId);\n    // the order for the _intendedPreviousOrderId provided exist\n    require(previousOrder.id != 0, \"PreviousOrder doesnt exist\");\n\n    require(previousOrder.orderType == OrderType.LIMIT_ORDER, \"Hint is not limit order\");\n\n    // the price goes after the intended previous order\n    require(!priceGoesBefore(self, _price, previousOrder.price), \"Order should go before\");\n    Order storage nextOrder = get(self, previousOrder.next);\n    // the price goes before the next order, if there is a next order\n    require(nextOrder.id == 0 || priceGoesBefore(self, _price, nextOrder.price), \"Order should go after\");\n\n\n  }\n\n  /*\n  @notice Checks that the market order should be in the place where it is trying to be inserted, reverts otherwise\n  @param _multiplyFactor Target multiplyOrder of the new order\n  @param _intendedPreviousOrderId Id of the order which is intended to be the order before the new one being inserted\n  */\n  function validateMarketOrderIntendedPreviousOrder(Data storage self, uint256 _intendedPreviousOrderId, uint256 _multiplyFactor) private view {\n    Order storage previousOrder = get(self, _intendedPreviousOrderId);\n    // the order for the _intendedPreviousOrderId provided exist\n    require(previousOrder.id != 0, \"PreviousOrder doesnt exist\");\n\n    require(get(self, _intendedPreviousOrderId).orderType == OrderType.MARKET_ORDER, \"Hint is not market order\");\n\n    // the price goes after the intended previous order\n    require(!multiplyFactorGoesBefore(self, _multiplyFactor, previousOrder.multiplyFactor), \"Market Order should go before\");\n    Order storage nextOrder = get(self, previousOrder.next);\n    // the price goes before the next order, if there is a next order\n    require(nextOrder.id == 0 || multiplyFactorGoesBefore(self, _multiplyFactor, nextOrder.multiplyFactor), \"Market Order should go after\");\n  }\n\n\n  /*\n    @notice drops first element and returs the new top\n    @dev deleted first Order, replacin it wi the following one and shrinks the orderbook size\n    @return new orderbook top (first)\n   */\n  function popAndGetNewTop(Pair storage _pair, Data storage self) internal returns (Order storage) {\n    Order storage orderToPop = mostCompetitiveOrder(_pair.pageMemory.marketPrice, self, first(self), firstMarketOrder(self));\n    Order storage newTop = get(self, orderToPop.next);\n    if (orderToPop.orderType == OrderType.LIMIT_ORDER){\n      self.firstId = newTop.id;\n    }\n    else{\n      self.firstMarketOrderId = newTop.id;\n    }\n    decreaseQueuesLength(self, orderToPop.orderType != OrderType.LIMIT_ORDER);\n    delete (self.orders[orderToPop.id]);\n    return mostCompetitiveOrder(_pair.pageMemory.marketPrice, self, first(self), firstMarketOrder(self));\n  }\n\n  /*\n    @notice decreases the size of the orders queue\n   */\n  function decreaseQueuesLength(Data storage _self, bool _isMarketOrder) internal {\n    _self.length = _self.length.sub(1);\n    if (_isMarketOrder) {\n      _self.marketOrderLength = _self.marketOrderLength.sub(1);\n     } else {\n      _self.limitOrderLength = _self.limitOrderLength.sub(1);\n    }\n  }\n\n  /*\n    @notice Checks if the order is the last of the orderbook where it is saved\n    @param _order Order to be checked\n   */\n  function isLastOfOrderbook(Order storage _order) internal view returns (bool) {\n    return _order.next == 0;\n  }\n\n  /*\n    @notice Checks if the order is the first of the orderbook where it is saved\n    @param self Orderbook where the _order is supposed to be stored(we dont actually check if it is stored there)\n    @param _order Order to be checked\n   */\n  function isFirstOfOrderbook(Data storage self, Order storage _order) internal view returns (bool) {\n    return (_order.orderType == OrderType.LIMIT_ORDER && self.firstId == _order.id);\n  }\n\n\n  /*\n    @notice Checks if the market order is the first of the orderbook where it is saved\n    @param self Orderbook where the _order is supposed to be stored(we dont actually check if it is stored there)\n    @param _order Order to be checked\n   */\n  function isFirstOfMarketOrderbook(Data storage self, Order storage _order) internal view returns (bool) {\n    return (_order.orderType == OrderType.MARKET_ORDER && self.firstMarketOrderId == _order.id);\n  }\n\n  /*\n    @notice removes an order from the self collection\n    @dev copy any Order value before removing it as it will be cleared\n    @param self Data struct to remove the order from\n    @param _toRemove Order to remove\n    @param _startFromId previous hint to look for (if zero, starts from beggining)\n  */\n  function removeOrder(Data storage self, Order storage _toRemove, uint256 _startFromId) public {\n    if (isFirstOfOrderbook(self, _toRemove)) {\n      // If first limit order, re-assing the linked list start to next\n      self.firstId = _toRemove.next;\n    }\n    else if (isFirstOfMarketOrderbook(self, _toRemove)){\n      // If first market order, re-assing the linked list start to next\n      self.firstMarketOrderId = _toRemove.next;\n    }\n    else {\n      (bool found, Order storage previousOrder) = findPreviousOrder(self, _toRemove, _startFromId);\n      require(found, \"Previous order not found\");\n\n      if (isLastOfOrderbook(_toRemove)) {\n        // If last Order, and not only, tails previous\n        previousOrder.next = 0;\n      } else {\n        // if in the middle, link prevoius to next\n        previousOrder.next = _toRemove.next;\n      }\n    }\n    // In any case, the item should be deleted and the list resized\n    bool isMarketOrder = _toRemove.orderType == OrderType.MARKET_ORDER;\n    delete (self.orders[_toRemove.id]);\n    decreaseQueuesLength(self, isMarketOrder);\n  }\n\n  /*\n    @notice Creates a new order to be positioned later in the orderbook or a pendingQueue\n    @param self Container of the data structure in where the order will be positioned later\n    @param _orderId Id of the order to be inserted\n    @param _sender Owner of the new order\n    @param _exchangeableAmount Amount that was left to be exchanged\n    @param _reservedCommission Commission reserved to be charged later\n    @param _price Target price of the order[base/secondary]\n    @param _expiresInTick Number of tick in which the order can no longer be matched\n  */\n  function createOrder(\n    Data storage self,\n    uint256 _orderId,\n    address _sender,\n    uint256 _exchangeableAmount,\n    uint256 _reservedCommission,\n    uint256 _price,\n    uint64 _expiresInTick\n  ) private {\n    // Next order is a position attribute so it should be set in another place\n    self.orders[_orderId] = Order(\n      OrderType.LIMIT_ORDER,\n      _orderId,\n      _exchangeableAmount,\n      _reservedCommission,\n      _price,\n      0,\n      0,\n      _sender,\n      _expiresInTick\n    );\n  }\n\n  /*\n    @notice Creates a new market order to be positioned later in the orderbook or a pendingQueue\n    @param self Container of the data structure in where the market order will be positioned later\n    @param _orderId Id of the order to be inserted\n    @param _sender Owner of the new order\n    @param _exchangeableAmount Quantity of tokens to exchange\n    @param _reservedCommission Commission reserved to be charged later\n    @param _multiplyFactor The factor to manage the final price of the market order\n    @param _expiresInTick Number of tick in which the order can no longer be matched\n  */\n  function createMarketOrder(\n    Data storage self,\n    uint256 _orderId,\n    address _sender,\n    uint256 _exchangeableAmount,\n    uint256 _reservedCommission,\n    uint256 _multiplyFactor,\n    uint64 _expiresInTick\n  ) private {\n    // Next order is a position attribute so it should be set in another place\n    self.orders[_orderId] = Order(\n      OrderType.MARKET_ORDER,\n      _orderId,\n      _exchangeableAmount,\n      _reservedCommission,\n      0,\n      _multiplyFactor,\n      0,\n      _sender,\n      _expiresInTick);\n  }\n\n  /*\n    @notice Positions an order in the provided orderbook\n    @param self Container of the orderbook\n    @param _orderId Id of the order to be positioned\n    @param _previousOrderId Id of the order that should be immediately before the newly positioned order, 0 if should go at the start\n   */\n  function positionOrder(Data storage self, uint256 _orderId, uint256 _previousOrderId) private {\n    Order storage order = get(self, _orderId);\n    self.length = self.length.add(1);\n    self.limitOrderLength = self.limitOrderLength.add(1);\n    if (_previousOrderId != 0) {\n      Order storage previousOrder = get(self, _previousOrderId);\n      order.next = previousOrder.next;\n      previousOrder.next = _orderId;\n    } else {\n      order.next = self.firstId;\n      self.firstId = _orderId;\n    }\n  }\n\n  /*\n    @notice Positions an order in the provided orderbook\n    @param self Container of the orderbook\n    @param _orderId Id of the order to be positioned\n    @param _previousOrderId Id of the order that should be immediately before the newly positioned order, 0 if should go at the start\n   */\n  function positionMarketOrder(Data storage self, uint256 _orderId, uint256 _previousOrderId) private {\n    Order storage order = get(self, _orderId);\n    self.length = self.length.add(1);\n    self.marketOrderLength = self.marketOrderLength.add(1);\n    if (_previousOrderId != 0) {\n      Order storage previousOrder = get(self, _previousOrderId);\n      order.next = previousOrder.next;\n      previousOrder.next = _orderId;\n    } else {\n      order.next = self.firstMarketOrderId;\n      self.firstMarketOrderId = _orderId;\n    }\n  }\n\n  /*\n    @notice Positions an order in the provided pendingQueue\n    @param self Container of the pendingQueue\n    @param _orderId Id of the order to be positioned as pending\n   */\n  function positionOrderAsPending(Data storage self, uint256 _orderId) private {\n    if (self.amountOfPendingOrders != 0) {\n      Order storage previousLastOrder = self.orders[self.lastPendingToPopId];\n      require(previousLastOrder.orderType == OrderType.LIMIT_ORDER, \"It isn't a limit order\");\n      previousLastOrder.next = _orderId;\n    } else {\n      self.firstPendingToPopId = _orderId;\n    }\n    self.lastPendingToPopId = _orderId;\n    self.amountOfPendingOrders = self.amountOfPendingOrders.add(1);\n  }\n\n  /*\n    @notice Positions a market order in the provided pendingQueue\n    @param self Container of the pendingQueue\n    @param _orderId Id of the market order to be positioned as pending\n   */\n  function positionMarketOrderAsPending(Data storage self, uint256 _orderId) private {\n    if (self.amountOfPendingMarketOrders != 0) {\n      Order storage previousLastOrder = self.orders[self.lastPendingMarketOrderToPopId];\n      require(previousLastOrder.orderType == OrderType.MARKET_ORDER, \"It isn't a market order\");\n      previousLastOrder.next = _orderId;\n    } else {\n      self.firstPendingMarketOrderToPopId = _orderId;\n    }\n    self.lastPendingMarketOrderToPopId = _orderId;\n    self.amountOfPendingMarketOrders = self.amountOfPendingMarketOrders.add(1);\n  }\n\n  /*\n    @notice Finds previous order for a new order with a given price in a given orderbook\n    @param self Container of the orderbook\n    @param _price Price of the order to possition\n   */\n  function findPreviousOrderToPrice(Data storage self, uint256 _price) public view returns (uint256) {\n    if (self.limitOrderLength == 0) {\n      return 0;\n    }\n\n    Order storage pivotOrder = first(self);\n\n    bool newPriceGoesFirst = priceGoesBefore(self, _price, pivotOrder.price);\n    if (newPriceGoesFirst) {\n      return 0;\n    }\n    if (pivotOrder.next != 0) {\n      Order storage nextOrder = get(self, pivotOrder.next);\n      newPriceGoesFirst = priceGoesBefore(self, _price, nextOrder.price);\n\n      while (!newPriceGoesFirst && pivotOrder.next != 0) {\n        pivotOrder = nextOrder;\n\n        if (pivotOrder.next != 0) {\n          nextOrder = get(self, pivotOrder.next);\n          newPriceGoesFirst = priceGoesBefore(self, _price, nextOrder.price);\n        }\n      }\n    }\n    return pivotOrder.id;\n  }\n\n  /*\n    @notice Finds previous market order for a new order with a given price in a given orderbook\n    @param self Container of the orderbook\n    @param _price Price of the order to possition. It's equal to exchangableAmount * multiplyFactor\n   */\n  function findPreviousMarketOrderToMultiplyFactor(Data storage self, uint256 _price) public view returns (uint256) {\n    if (self.marketOrderLength == 0) {\n      return 0;\n    }\n\n    Order storage pivotOrder = firstMarketOrder(self);\n\n    bool newMultiplyFactorGoesBefore = multiplyFactorGoesBefore(self, _price, pivotOrder.multiplyFactor);\n    if (newMultiplyFactorGoesBefore) {\n      return 0;\n    }\n    if (pivotOrder.next != 0) {\n      Order storage nextOrder = get(self, pivotOrder.next);\n      newMultiplyFactorGoesBefore = multiplyFactorGoesBefore(self, _price, nextOrder.multiplyFactor);\n\n      while (!newMultiplyFactorGoesBefore && pivotOrder.next != 0) {\n        pivotOrder = nextOrder;\n\n        if (pivotOrder.next != 0) {\n          nextOrder = get(self, pivotOrder.next);\n          newMultiplyFactorGoesBefore = multiplyFactorGoesBefore(self, _price, nextOrder.multiplyFactor);\n        }\n      }\n    }\n    return pivotOrder.id;\n  }\n\n  /*\n    @dev Iterates though self Order collection starting from _startFromId until finding order with id _targetId\n    @param self collection where to look for\n    @param _toRemove Order to remove\n    @param _startFromId hint id to start iterating from, if zero, will search from begining\n    @return true if found\n    @return the Orders starage pointer, should not be used if not found\n  */\n  function findPreviousOrder(Data storage self, Order storage _toRemove, uint256 _startFromId)\n    public\n    view\n    returns (bool found, Order storage prevOrder)\n  {\n    uint256 firstId = (_toRemove.orderType == OrderType.LIMIT_ORDER) ? self.firstId : self.firstMarketOrderId;\n    uint256 startFromId = _startFromId == 0 ? firstId : _startFromId;\n    Order storage pivotOrder = get(self, startFromId);\n    found = pivotOrder.next == _toRemove.id;\n\n    while (!found && !isLastOfOrderbook(pivotOrder)) {\n      pivotOrder = get(self, pivotOrder.next);\n      found = pivotOrder.next == _toRemove.id;\n    }\n    return (found, pivotOrder);\n  }\n\n  /*\n    @notice Returns true if an order with a _price should go before a prexistent order with _existingPrice in an orderbook\n    @param _price New price to compare\n    @param _existingPrice Existing order's price to compare\n   */\n  function priceGoesBefore(Data storage self, uint256 _price, uint256 _existingPrice) private view returns (bool) {\n    return (self.orderDescending && (_price > _existingPrice)) || (!self.orderDescending && (_price < _existingPrice));\n  }\n\n  /*\n    @notice Returns true if an order with a _multiplyFactor should go before a prexistent order with _existingMultiplyFactor in an orderbook\n    @param _multiplyFactor New multiplyFactor to compare\n    @param _existingMultiplyFactor Existing order's multiplyFactor to compare\n  */\n  function multiplyFactorGoesBefore(Data storage self, uint256 _multiplyFactor, uint256 _existingMultiplyFactor) private view returns (bool) {\n    return (\n      self.orderDescending && (_multiplyFactor > _existingMultiplyFactor)) || (!self.orderDescending && (_multiplyFactor < _existingMultiplyFactor)\n    );\n  }\n\n  /*\n    @notice Returns an order by its _id in a given orderbook/pendingQueue container(self)\n    @param self Container of the orderbook/pendingQueue\n    @param _id Id of the order to get\n   */\n  function get(Data storage self, uint256 _id) internal view returns (Order storage) {\n    return self.orders[_id];\n  }\n\n  /*\n    Returns the next valid order. It can be MO or LO.\n    @notice returns the next valid Order for the given _orderbook\n    @dev gets the next Order, if not valid, recursivelly calls itself until finding the first valid or reaching the end.\n\n    @return next valid Order, id = 0 if no valid order found\n   */\n  function getNextValidOrder(\n    Data storage _orderbook,\n    uint64 _tickNumber,\n    uint256 _limitOrderId,\n    uint256 _marketOrderId,\n    uint256 _marketPrice\n  ) public view returns (Order storage, uint256, uint256) {\n    Order storage nextLO = getNextValidLimitOrder(_orderbook, _tickNumber, _limitOrderId);\n    Order storage nextMO = getNextValidMarketOrder(_orderbook, _tickNumber, _marketOrderId);\n    Order storage nextOrder = mostCompetitiveOrder(_marketPrice, _orderbook, nextLO, nextMO);\n    (uint256 newCurrentLimitOrderId, uint256 newCurrentMarketOrderId) = nextOrder.orderType == OrderType.LIMIT_ORDER ?\n      (nextOrder.id, _marketOrderId) :\n      (_limitOrderId, nextOrder.id);\n    return (mostCompetitiveOrder(_marketPrice, _orderbook, nextLO, nextMO), newCurrentLimitOrderId, newCurrentMarketOrderId);\n  }\n\n  /*\n    Returns the next valid order. It can be MO or LO.\n    @notice returns the next valid Order for the given _orderbook\n    @dev gets the next Order, if not valid, recursivelly calls itself until finding the first valid or reaching the end.\n    @param _self the pair of tokens\n    @param _isBuy true to get a buy order, false otherwise.\n    @return next valid Order, id = 0 if no valid order found\n   */\n  function getNextValidOrder(\n    Pair storage _self,\n    bool _isBuy\n  ) public view returns (Order storage nextValidOrder, uint256 newCurrentLimitOrderId, uint256 newCurrentMarketOrderId) {\n    uint64 tickNumber = _self.tickState.number;\n    MoCExchangeLib.Data storage orderbook = _isBuy ? _self.baseToken.orderbook : _self.secondaryToken.orderbook;\n    uint256 limitOrderId = _isBuy ? _self.pageMemory.lastBuyLimitOrderId : _self.pageMemory.lastSellLimitOrderId;\n    uint256 marketOrderId = _isBuy ? _self.pageMemory.lastBuyMarketOrderId : _self.pageMemory.lastSellMarketOrderId;\n\n    return  getNextValidOrder(\n      orderbook,\n      tickNumber,\n      limitOrderId,\n      marketOrderId,\n      _self.pageMemory.marketPrice\n    );\n  }\n\n  /*\n    Returns the next valid order. It can be MO or LO.\n    @notice returns the next valid Order for the given _orderbook\n    @dev gets the next Order, if not valid, recursivelly calls itself until finding the first valid or reaching the end.\n    @param _self the pair of tokens\n    @param _isBuy true to get a buy order, false otherwise.\n    @param _limitOrderId previous id of LO.\n    @param _marketOrderId previous id of MO.\n    @return next valid Order, id = 0 if no valid order found\n   */\n  function getNextValidOrderEP(\n    Pair storage _self,\n    bool _isBuy,\n    uint256 _limitOrderId,\n    uint256 _marketOrderId\n  ) public view returns (Order storage nextValidOrder, uint256 newCurrentLimitOrderId, uint256 newCurrentMarketOrderId) {\n    MoCExchangeLib.Data storage orderbook = _isBuy ? _self.baseToken.orderbook : _self.secondaryToken.orderbook;\n\n    return  getNextValidOrder(\n      orderbook,\n      _self.tickState.number,\n      _limitOrderId,\n      _marketOrderId,\n      getMarketPrice(_self)\n    );\n  }\n\n  /*\n    @notice returns the next valid Order for the given _orderbook\n    @dev gets the net Order, if not valid, recursivelly calls itself until finding the first valid or reaching the end\n    @param _orderbook where the _orderId is from\n    @param _tickNumber for current tick\n    @param _orderId id of the order from with obtain the next one, zero if beginging\n    @return next valid Order, id = 0 if no valid order found\n   */\n  function getNextValidLimitOrder(Data storage _orderbook, uint64 _tickNumber, uint256 _orderId) public view returns (Order storage) {\n    Order storage next = _orderId == 0 ? first(_orderbook) : getNext(_orderbook, _orderId);\n    if (next.id == 0 || !isExpired(next, _tickNumber)) return next;\n    else return getNextValidLimitOrder(_orderbook, _tickNumber, next.id);\n  }\n\n  /*\n    @notice returns the next valid Order for the given _orderbook\n    @dev gets the net Order, if not valid, recursivelly calls itself until finding the first valid or reaching the end\n    @param _orderbook where the _orderId is from\n    @param _tickNumber for current tick\n    @param _orderId id of the order from with obtain the next one, zero if beginging\n    @return next valid Order, id = 0 if no valid order found\n   */\n  function getNextValidMarketOrder(Data storage _orderbook, uint64 _tickNumber, uint256 _orderId) public view returns (Order storage) {\n    Order storage next = _orderId == 0 ? firstMarketOrder(_orderbook) : getNext(_orderbook, _orderId);\n\n    if (next.id == 0 || !isExpired(next, _tickNumber)) return next;\n    else return getNextValidMarketOrder(_orderbook, _tickNumber, next.id);\n  }\n\n  /*\n    @notice returns the most competitive order using curring market price.\n    @dev LOs have higher priority to be processed because they have a TTL (lifespan).\n    @param _marketPrice The market price in base token\n    @param _orderbook the orderbook\n    @param _limitOrder The Limit Order to compare\n    @param _marketOrder The Market Order to compare\n    @return next valid Order, id = 0 if no valid order found\n  */\n  function mostCompetitiveOrder(\n    uint256 _marketPrice,\n    Data storage _orderbook,\n    Order storage _limitOrder,\n    Order storage _marketOrder\n    ) public view returns (Order storage) {\n    // Both are empty. Return first LO empty order\n    if (_limitOrder.id == 0 && _marketOrder.id == 0){\n      return _limitOrder;\n    }\n    // There is only a Limit Order\n    else if (_limitOrder.id != 0 && _marketOrder.id == 0){\n      return _limitOrder;\n    }\n    // There is only a Market Order\n    else if (_limitOrder.id == 0 && _marketOrder.id != 0){\n      return _marketOrder;\n    }\n    // There is a limit order and a market order.\n    // The price to compare MO with LO is computed: multiplyFactor * current market price.\n    // LOs have priority to be processed in case of same price.\n    // Descending orderbooks => Buy Orders\n    else {\n      uint256 currentMOPrice = marketOrderSpotPrice(_marketPrice, _marketOrder.multiplyFactor);\n      if (_limitOrder.price == currentMOPrice || priceGoesBefore(_orderbook, _limitOrder.price, currentMOPrice)){\n        return _limitOrder;\n      }\n      return _marketOrder;\n    }\n  }\n  /*\n    @notice Returns the order following an order which id is _id in a given orderbook/pendingQueue container(self)\n    @param self Container of the orderbook\n    @param _id Id of the order to get the next from\n   */\n  function getNext(Data storage self, uint256 _id) internal view returns (Order storage) {\n    return self.orders[(self.orders[_id]).next];\n  }\n\n  /*\n    @notice Returns the first of order of an orderbook\n    @param self Container of the orderbook\n   */\n  function first(Data storage self) internal view returns (Order storage) {\n    return self.orders[self.firstId];\n  }\n\n  /*\n    @notice Returns the first of market order of an orderbook\n    @param self Container of the orderbook\n   */\n  function firstMarketOrder(Data storage self) internal view returns (Order storage) {\n    return self.orders[self.firstMarketOrderId];\n  }\n\n  /*\n    @notice Returns the first order to be popped from the pendingQueue\n    @param self Container of the pendingQueue\n   */\n  function firstPending(Data storage self) internal view returns (Order storage) {\n    return self.orders[self.firstPendingToPopId];\n  }\n\n  /*\n    @notice Returns the first market order to be popped from the pendingQueue\n    @param self Container of the pendingQueue\n   */\n  function firstPendingMarketOrder(Data storage self) internal view returns (Order storage) {\n    return self.orders[self.firstPendingMarketOrderToPopId];\n  }\n\n\n  /*\n    @notice Returns true if the given order is expired\n    @param _order Order to be checked\n    @param _tickNumber Current tick number\n   */\n  function isExpired(Order storage _order, uint128 _tickNumber) internal view returns (bool) {\n    require(_order.id != 0, \"tried to see expiration of a null order\");\n    return _order.expiresInTick <= _tickNumber;\n  }\n\n  /* TokenPair **/\n\n  /*\n    @notice Returns the status of a pair\n    @param _self Struct pair to be seen\n    @return tickNumber Number of the current tick\n    @return nextTickBlock Block in which the next tick will be able to run\n    @return lastTickBlock Block in which the last tick started to run\n    @return lastClosingPrice Emergent price of the last tick\n    @return disabled True if the pair is disabled(it can not be inserted any orders); false otherwise\n    @return emaPrice The last calculated emaPrice of the last tick\n    @return smoothingFactor The current smoothing factor\n   */\n  function getStatus(Pair storage _self)\n    internal\n    view\n    returns (\n      uint64 tickNumber,\n      uint256 nextTickBlock,\n      uint256 lastTickBlock,\n      uint256 lastClosingPrice,\n      bool disabled,\n      uint256 emaPrice,\n      uint256 smoothingFactor\n    )\n  {\n    tickNumber = _self.tickState.number;\n    nextTickBlock = _self.tickState.nextTickBlock;\n    lastTickBlock = _self.tickState.lastTickBlock;\n    lastClosingPrice = _self.lastClosingPrice;\n    disabled = _self.disabled;\n    emaPrice = _self.emaPrice;\n    smoothingFactor = _self.smoothingFactor;\n  }\n\n  /*\n    @notice inserts a new Order. Emits the NewOrderInserted event\n    @dev the _exchangeableAmount + _reservedCommission of the corresponding Token will be locked in the _receiver address, by making an RRC20 transferFrom,\n    note that the address will need to have allowance and the necesary balance.\n    @param _self Pair (Base & Secondary Token) to insert Order for\n    @param _id Id of the new order\n    @param _exchangeableAmount Order amount to be inserted, baseToken when buy, secondary when sell\n    @param _reservedCommission Commission reserved to allow to charge it later(at expiration/)\n    @param _price price the user is willing to bid/ask for this order.\n    @param _lifespan the amount of ticks that the order is going to ve available to match.\n    @param _previousOrderIdHint previous order in the orderbook, used as on optimization to search for.\n    @param _sender address of the account executing the insertion\n    @param _isBuy true if it's a buy order, meaning the funds should be from base Token\n  */\n  function doInsertLimitOrder(\n    Pair storage _self,\n    uint256 _id,\n    uint256 _exchangeableAmount,\n    uint256 _reservedCommission,\n    uint256 _price,\n    uint64 _lifespan,\n    uint256 _previousOrderIdHint,\n    address _sender,\n    address _receiver,\n    bool _isBuy\n  ) public returns (uint256) {\n    require(!_self.disabled, \"Pair has been disabled\");\n\n    Token storage token = _isBuy ? _self.baseToken : _self.secondaryToken;\n\n    require(token.token.transferFrom(_sender, _receiver, _exchangeableAmount.add(_reservedCommission)), \"Token transfer failed\");\n\n    bool goesToPendingQueue = _self.tickStage != TickStage.RECEIVING_ORDERS;\n    uint64 expiresInTick = _self.tickState.number + _lifespan;\n\n    if (goesToPendingQueue) {\n      insertLimitOrderAsPending(token.orderbook, _id, _sender, _exchangeableAmount, _reservedCommission, _price, expiresInTick);\n      emit NewOrderAddedToPendingQueue(_id, 0);\n    } else {\n      if (_previousOrderIdHint == NO_HINT) {\n        insertLimitOrder(token.orderbook, _id, _sender, _exchangeableAmount, _reservedCommission, _price, expiresInTick);\n      } else {\n        insertLimitOrder(token.orderbook, _id, _sender, _exchangeableAmount, _reservedCommission, _price, expiresInTick, _previousOrderIdHint);\n      }\n      emitNewOrderEventForLimitOrder(_id, _self, _sender, _exchangeableAmount, _reservedCommission, _price, expiresInTick, _isBuy);\n    }\n  }\n\n  /*\n    @notice inserts a new Market Order. Emits the NewOrderInserted event\n    @dev the _exchangeableAmount is the quantity of tokens,\n    note that the address will need to have allowance and the necesary balance.\n    @param _self Pair (Base & Secondary Token) to insert Order for\n    @param _id Id of the new order\n    @param _exchangeableAmount The quantity of tokens to insert, baseToken when buy, secondary when sell\n    @param _reservedCommission Commission reserved to allow to charge it later(at expiration/)\n    @param _multiplyFactor The multiplier factor to calculate the market order price.\n    @param _lifespan the amount of ticks that the order is going to ve available to match.\n    @param _previousOrderIdHint previous order in the orderbook, used as on optimization to search for.\n    @param _sender address of the account executing the insertion\n    @param _isBuy true if it's a buy order, meaning the funds should be from base Token\n  */\n  function doInsertMarketOrder(\n    Pair storage _self,\n    uint256 _id,\n    uint256 _exchangeableAmount,\n    uint256 _reservedCommission,\n    uint256 _multiplyFactor,\n    uint64 _lifespan,\n    uint256 _previousOrderIdHint,\n    address _sender,\n    bool _isBuy\n  ) public returns (uint256) {\n    require(!_self.disabled, \"Pair has been disabled\");\n    //It is not a modifier because of stack to deep\n    require(_multiplyFactor != 0, \"MultiplyFactor cannot be zero\");\n    //It is not a modifier because of stack to deep\n    require(_exchangeableAmount != 0, \"Exchangeable amount cannot be zero\");\n\n    Token storage token = _isBuy ? _self.baseToken : _self.secondaryToken;\n\n    uint256 toTransfer = _exchangeableAmount.add(_reservedCommission);\n\n    require(token.token.allowance(_sender, address(this)) >= toTransfer, \"Allowance too low\");\n    require(token.token.transferFrom(_sender, address(this), toTransfer), \"Token transfer failed\");\n\n    bool goesToPendingQueue = _self.tickStage != TickStage.RECEIVING_ORDERS;\n    uint64 expiresInTick = _self.tickState.number + _lifespan;\n\n    if (goesToPendingQueue) {\n      insertMarketOrderAsPending(token.orderbook, _id, _sender, _exchangeableAmount, _reservedCommission, _multiplyFactor, expiresInTick);\n      emit NewOrderAddedToPendingQueue(_id, 0);\n    } else {\n      if (_previousOrderIdHint == NO_HINT) {\n        insertMarketOrder(token.orderbook, _id, _exchangeableAmount, _reservedCommission, _multiplyFactor, expiresInTick);\n      } else {\n        insertMarketOrder(token.orderbook, _id, _exchangeableAmount, _reservedCommission,  _multiplyFactor, expiresInTick, _previousOrderIdHint);\n      }\n      emitNewOrderEventForMarketOrder(_id, _self, _sender, _exchangeableAmount, _reservedCommission, _multiplyFactor, expiresInTick, _isBuy);\n    }\n  }\n\n  /*\n    @notice Converts an amount in secondary token currency to base token currency\n    @param _secondary Amount to be converted[secondary]\n    @param _price Price used to convert[base/secondary]\n    @param _priceComparisonPrecision Fixed point used precision of _price\n    @return _base Amount converted[base]\n   */\n  function convertToBase(uint256 _secondary, uint256 _price, uint256 _priceComparisonPrecision) internal pure returns (uint256) {\n    return _secondary.mul(_price).div(_priceComparisonPrecision);\n  }\n\n\n  /*\n    @notice Computes the prices of a market order\n    @param _marketPrice The market price\n    @param _multiplyFactor multiplyFactor\n    @return price\n   */\n  function marketOrderSpotPrice(uint256 _marketPrice, uint256 _multiplyFactor) private pure returns (uint256) {\n    return _multiplyFactor.mul(_marketPrice).div(RATE_PRECISION);\n  }\n\n  /*\n    @notice Returns true if the pair is valid i.e. it is initialized, false otherwise\n   */\n  function isValid(Pair storage _self) internal view returns (bool) {\n    return\n      address(_self.baseToken.token) != address(0) && address(_self.secondaryToken.token) != address(0) && _self.priceComparisonPrecision != 0;\n  }\n\n  /*\n    @notice Calculates the new EMA using the exponential smoothing formula:\n        newEMA = (smoothingFactor * newValue) + ((1 - smoothingFactor) * oldEma)\n      where newValue is the lastClosingPrice of current tick, and 0 < smoothingFactor < 1.\n      All values are weighted with the appropiate precision.\n    @param _oldEMA the previous calculated EMA\n    @param _newValue the newValue to smooth, it represents the new lastClosingPrice\n    @param _smoothingFactor the smoothing factor of the exponential smoothing\n    @param _factorPrecision the smoothing factor's precision\n    */\n  function calculateNewEMA(uint256 _oldEMA, uint256 _newValue, uint256 _smoothingFactor, uint256 _factorPrecision)\n    public\n    pure\n    returns (uint256)\n  {\n    uint256 weightedNewValue = _newValue.mul(_smoothingFactor).div(_factorPrecision);\n    uint256 oldEMAWeighted = _oldEMA.mul(_factorPrecision.sub(_smoothingFactor)).div(_factorPrecision);\n    uint256 newEMA = oldEMAWeighted.add(weightedNewValue);\n    return newEMA;\n  }\n\n  /*\n    @dev this wrapp responds more to a \"stack-too-deep\" problem than a desire function break drown\n  */\n  function emitNewOrderEventForLimitOrder(\n    uint256 _orderId,\n    Pair storage _self,\n    address _sender,\n    uint256 _exchangeableAmount,\n    uint256 _reservedCommission,\n    uint256 _price,\n    uint64 _expiresInTick,\n    bool _isBuy\n  ) private {\n    emit NewOrderInserted(\n      _orderId,\n      _sender,\n      address(_self.baseToken.token),\n      address(_self.secondaryToken.token),\n      _exchangeableAmount,\n      _reservedCommission,\n      _price,\n      0,\n      _expiresInTick,\n      _isBuy,\n      OrderType.LIMIT_ORDER\n    );\n  }\n\n  /*\n    @dev this wrapp responds more to a \"stack-too-deep\" problem than a desire function break drown\n  */\n  function emitNewOrderEventForMarketOrder(\n    uint256 _orderId,\n    Pair storage _self,\n    address _sender,\n    uint256 _exchangeableAmount,\n    uint256 _reservedCommission,\n    uint256 _multiplyFactor,\n    uint64 _expiresInTick,\n    bool _isBuy\n  ) private {\n    emit NewOrderInserted(\n      _orderId,\n      _sender,\n      address(_self.baseToken.token),\n      address(_self.secondaryToken.token),\n      _exchangeableAmount,\n      _reservedCommission,\n      0,\n      _multiplyFactor,\n      _expiresInTick,\n      _isBuy,\n      OrderType.MARKET_ORDER\n    );\n  }\n\n  /*\n    @notice Gets the ids of the last sell and buy matching orders.\n    @dev iterates over the pair orderbook, simulating the match to obtain the final matching orders\n    @return lastBuyMatchId Id of the last Buy order to match\n    @return lastSellMatchId Id of the last Sell order to match\n  */\n  function getLastMatchingOrders(Pair storage _self)\n    internal\n    view\n    returns (uint256, uint256)\n  {\n\n    Order memory lastBuyMatch;\n    Order memory lastSellMatch;\n    uint256 marketPrice = getMarketPrice(_self);\n    Order memory buy;\n    Order memory sell;\n\n    uint256 lastBuyLimitOrderId;\n    uint256 lastBuyMarketOrderId;\n    uint256 lastSellLimitOrderId;\n    uint256 lastSellMarketOrderId;\n\n    uint256 pricePrecision = _self.priceComparisonPrecision;\n\n    (buy, lastBuyLimitOrderId, lastBuyMarketOrderId) = getNextValidOrderEP(_self, true, lastBuyLimitOrderId, lastBuyMarketOrderId);\n    (sell, lastSellLimitOrderId, lastSellMarketOrderId) = getNextValidOrderEP(_self, false, lastSellLimitOrderId, lastSellMarketOrderId);\n\n    while (shouldMatchMemory(marketPrice, buy, sell)) {\n      lastBuyMatch = buy;\n      lastSellMatch = sell;\n      (uint256 limitingAmount, MatchType matchType) = compareIntents(\n        buy.exchangeableAmount,\n        getOrderPrice(marketPrice, buy),\n        sell.exchangeableAmount,\n        pricePrecision);\n\n      if (matchType == MatchType.DOUBLE_FILL) {\n        (buy, lastBuyLimitOrderId, lastBuyMarketOrderId) = getNextValidOrderEP(_self, true, lastBuyLimitOrderId, lastBuyMarketOrderId);\n        (sell, lastSellLimitOrderId,lastSellMarketOrderId) = getNextValidOrderEP(_self, false, lastSellLimitOrderId, lastSellMarketOrderId);\n      } else if (matchType == MatchType.BUYER_FILL) {\n        (buy, lastBuyLimitOrderId, lastBuyMarketOrderId) = getNextValidOrderEP(_self, true, lastBuyLimitOrderId, lastBuyMarketOrderId);\n        sell.exchangeableAmount = sell.exchangeableAmount.sub(limitingAmount);\n      } else if (matchType == MatchType.SELLER_FILL) {\n        (sell, lastSellLimitOrderId, lastSellMarketOrderId) = getNextValidOrderEP(_self, false, lastSellLimitOrderId, lastSellMarketOrderId);\n        uint256 moPrice = getOrderPrice(marketPrice, buy);\n        uint256 buyerExpectedSend = convertToBase(limitingAmount, moPrice, pricePrecision);\n\n        buy.exchangeableAmount = buy.exchangeableAmount.sub(buyerExpectedSend);\n      } else {\n        // TODO\n        require(false, \"wow this is a bad implementation\");\n      }\n    }\n\n    return (lastBuyMatch.id, lastSellMatch.id);\n  }\n\n  /*\n    @dev iterates over the pair orderbook, simulating the match to obtain the emergent price\n    @return emergentPrice: AVG price of the last matched Orders\n    @return lastBuyMatchId Id of the last Buy order to match\n    @return lastBuyMatchAmount Amount of the last Buy order to match\n    @return lastSellMatchId Id of the last Sell order to match\n  */\n  function getEmergentPrice(Pair storage _self)\n    public\n    view\n    returns (uint256 emergentPrice, uint256 lastBuyMatchId, uint256 lastBuyMatchAmount, uint256 lastSellMatchId)\n  {\n\n    (uint256 lastBuyMatchedId, uint256 lastSellMatchedId) = getLastMatchingOrders(_self);\n    Order storage lastBuyMatch = get(_self.baseToken.orderbook, lastBuyMatchedId);\n    Order storage lastSellMatch = get(_self.secondaryToken.orderbook, lastSellMatchedId);\n\n    if (lastBuyMatch.id == 0) return (0, 0, 0, 0);\n    emergentPrice = Math.average(getOrderPrice(getMarketPrice(_self), lastBuyMatch), getOrderPrice(getMarketPrice(_self), lastSellMatch));\n    return (emergentPrice, lastBuyMatch.id, lastBuyMatch.exchangeableAmount, lastSellMatch.id);\n\n  }\n  function compareIntents(uint256 _buyAmount, uint256 _buyPrice, uint256 _sellAmount, uint256 _priceComparisonPrecision)\n    public\n    pure\n    returns (uint256 limitingAmount, MatchType matchType)\n  {\n    uint256 buyerIntent = _buyAmount.mul(_priceComparisonPrecision).div(_buyPrice);\n    if (_sellAmount > buyerIntent) {\n      return (buyerIntent, MatchType.BUYER_FILL);\n    } else if (_sellAmount < buyerIntent) {\n      return (_sellAmount, MatchType.SELLER_FILL);\n    } else {\n      return (_sellAmount, MatchType.DOUBLE_FILL);\n    }\n  }\n\n  /*\n    @notice Calculate the different amounts in the process of exchanging a buy order\n    @param _commissionManager contract responsible for resolving commissions\n    @param _pair the pair where the order exist\n    @param _buy the buy order to operate with\n    @param _sell the sell order to operate with\n    @param _limitingAmount the amount in secondary token to be exchanged\n    @param _price the emergent price to use when doing the calculuses\n  */\n  function executeMatch(\n    CommissionManager _commissionManager,\n    Pair storage _pair,\n    Order storage _buy,\n    Order storage _sell,\n    uint256 _limitingAmount,\n    uint256 _price,\n    bool _fillsBuy\n  ) internal {\n    executeBuyerMatch(_fillsBuy, _commissionManager, _pair, _buy, _limitingAmount, _price);\n    executeSellerMatch(_commissionManager, _pair, _sell, _limitingAmount, _price);\n  }\n\n  /*\n    @notice Returns true if the orders should match taking into account its prices\n    false otherwise\n    @dev It is identical to shouldMatchMemory but it receives its params as storage\n    It was done this way to save some gas\n    @param _marketPrice The market price\n    @param _buy Struct of buy order to be checked\n    @param _sell Struct of sell order to be checked\n  */\n  function shouldMatchStorage(uint256 _marketPrice, Order storage _buy, Order storage _sell) private view returns (bool) {\n    return _sell.id != 0 && _buy.id != 0 && getOrderPrice(_marketPrice, _buy) >= getOrderPrice(_marketPrice, _sell);\n  }\n\n  /*\n    @notice Returns true if the orders should match taking into account its prices\n    false otherwise\n    @dev It is identical to shouldMatchStorage but it receives its params as memory\n    It was done this way to save some gas\n    @param _marketPrice The market price\n    @param _buy Struct of buy order to be checked\n    @param _sell Struct of sell order to be checked\n  */\n  function shouldMatchMemory(uint256 _marketPrice, Order memory _buy, Order memory _sell) private pure returns (bool) {\n    return _sell.id != 0 && _buy.id != 0 && getOrderPrice(_marketPrice, _buy) >= getOrderPrice(_marketPrice, _sell);\n  }\n\n  /*\n    @notice Returns the price on an order\n    @dev Checks the OrderType to compute the current price\n    @param _marketPrice Market price\n    @param _order The order with price\n  */\n  function getOrderPrice(uint256 _marketPrice, Order memory _order) private pure returns (uint256) {\n    return (_order.orderType == OrderType.LIMIT_ORDER) ? _order.price : marketOrderSpotPrice(_marketPrice, _order.multiplyFactor);\n  }\n  /*\n    @notice Operates the buy order, doing modifications in the orderbook and the respecting transfers\n    @param _commissionManager contract responsible for resolving commissions\n    @param _pair the pair where the order exist\n    @param _buy the buy order to operate\n    @param _limitingAmount the amount in secondary token to be exchanged\n    @param _price the emergent price to use when doing the calculuses\n  */\n  function executeBuyerMatch(\n    bool _fillsBuy,\n    CommissionManager _commissionManager,\n    Pair storage _pair,\n    Order storage _buy,\n    uint256 _limitingAmount,\n    uint256 _price\n  ) private {\n    // calculates the amouts to exchange, the one to sent to the seller and the change that its going back to the buyer\n    (uint256 buyerExpectedSend, uint256 buyerSent) = calculateAmountToExchange(_pair, _buy, _limitingAmount, _price);\n\n    // Send the whole order if we are filling to avoid dust\n    buyerExpectedSend = _fillsBuy ? _buy.exchangeableAmount : buyerExpectedSend;\n\n    // calculates and retains the propotional commission for the exchange\n    uint256 exchangeCommission = _commissionManager.chargeCommissionForMatch(\n      _buy.exchangeableAmount,\n      buyerSent,\n      _buy.reservedCommission,\n      address(_pair.baseToken.token)\n    );\n\n    // transfer the change back to the buyer, has the commission change in it\n    // change created by the price difference favorable to the customer\n    uint256 changeTransferred = transferChange(_pair, _buy, buyerSent, buyerExpectedSend, exchangeCommission);\n\n    // edits the order according to the exchanged amount\n    subtractAmount(_buy, buyerExpectedSend);\n\n    emit BuyerMatch(\n      _buy.id,\n      buyerSent,\n      exchangeCommission,\n      changeTransferred,\n      // transfer the buyed amount, 0 if the transfer failed\n      SafeTransfer.doTransfer(_pair.secondaryToken.token, _buy.owner, _limitingAmount) ? _limitingAmount : 0,\n      _buy.exchangeableAmount,\n      _price,\n      _pair.tickState.number\n    );\n  }\n\n  /*\n    @notice Calculate the two amounts in the process of exchanging a buy order\n    @param _pair the pair where the order exist\n    @param _buy the buy order to operate\n    @param _limitingAmount the amount in secondary token to be exchanged\n    @param _price the emergent price to use when doing the calculuses\n    @return buyerSent, the amount to send to the seller\n    @return change, the amount to send back to the buyer\n  */\n  function calculateAmountToExchange(Pair storage _pair, Order storage _buy, uint256 _limitingAmount, uint256 _price)\n    private\n    view\n    returns (uint256, uint256)\n  {\n    uint256 buyerExpectedSend = convertToBase(\n      _limitingAmount,\n      getOrderPrice(_pair.pageMemory.marketPrice, _buy),\n      _pair.priceComparisonPrecision\n    );\n    uint256 buyerSent = convertToBase(_limitingAmount, _price, _pair.priceComparisonPrecision);\n    return (buyerExpectedSend, buyerSent);\n  }\n\n  /*\n    @notice Transfers the change of the buyers transaction. It is the surplus that it is resent to the\n    buyer but in base token currency\n    @param _pair Struct of the pair that it is being exchanged\n    @param _order Order that should have the change transfered\n    @param _amountSent Amount already sent to the buyer[seconady]\n    @param _expectedSend Amount expected from the buyer[secondary]\n    @param _commission Charged commission[secondary]\n  */\n  function transferChange(Pair storage _pair, Order storage _order, uint256 _amountSent, uint256 _expectedSend, uint256 _commission)\n    private\n    returns (uint256)\n  {\n    // adding to the change the reserved commission to be returned proportional to the change\n    uint256 buyerExpectedCommission = _expectedSend.mul(_order.reservedCommission).div(_order.exchangeableAmount);\n    uint256 changeToTransfer = _expectedSend.sub(_amountSent).add(buyerExpectedCommission.sub(_commission));\n    // For Token transfer, we use SafeTransfer to protect loop against individual reverts\n    return SafeTransfer.doTransfer(_pair.baseToken.token, _order.owner, changeToTransfer) ? changeToTransfer : 0;\n  }\n\n  /*\n    @notice Calculate the different amounts in the process of exchanging a sell order\n    @param _commissionManager contract responsible for resolving commissions\n    @param _pair the pair where the order exist\n    @param _sell the sell order to operate\n    @param _limitingAmount the amount in secondary token to be exchanged\n    @param _price the emergent price to use when doing the calculuses\n  */\n  function executeSellerMatch(\n    CommissionManager _commissionManager,\n    Pair storage _pair,\n    Order storage _sell,\n    uint256 _limitingAmount,\n    uint256 _price\n  ) private {\n    uint256 exchangeCommission = _commissionManager.chargeCommissionForMatch(\n      _sell.exchangeableAmount,\n      _limitingAmount,\n      _sell.reservedCommission,\n      address(_pair.secondaryToken.token)\n    );\n\n\n    uint256 sellerExpectedReturn = convertToBase(\n      _limitingAmount,\n      getOrderPrice(_pair.pageMemory.marketPrice, _sell),\n      _pair.priceComparisonPrecision\n    );\n    uint256 buyerSent = convertToBase(_limitingAmount, _price, _pair.priceComparisonPrecision);\n\n    uint256 surplus = buyerSent.sub(sellerExpectedReturn);\n\n    // For Token transfer, we use SafeTransfer to protect loop against individual reverts\n    if (!SafeTransfer.doTransfer(_pair.baseToken.token, _sell.owner, buyerSent)) buyerSent = 0;\n\n    subtractAmount(_sell, _limitingAmount);\n\n    emit SellerMatch(\n      _sell.id,\n      _limitingAmount,\n      exchangeCommission,\n      buyerSent,\n      surplus,\n      _sell.exchangeableAmount,\n      _price,\n      _pair.tickState.number\n    );\n  }\n\n  /*\n    @notice Reduce Order amount by amount and the reservedCommission proportionally\n    @param _order The order to reduce amount of\n    @param _sent amount to be substracted. Must be smaller than order's current amount\n   */\n  function subtractAmount(MoCExchangeLib.Order storage _order, uint256 _sent) private {\n    uint256 expectedCommission = _sent.mul(_order.reservedCommission).div(_order.exchangeableAmount);\n    _order.reservedCommission = _order.reservedCommission.sub(expectedCommission);\n    _order.exchangeableAmount = _order.exchangeableAmount.sub(_sent);\n  }\n\n  /*\n@notice Process expired Orders for the given orderbook, returning funds to the owner while applying commission\n@dev iterates _steps times over the orderbook starting from _orderId and process any encountered expired order\n@param _pair Pair of tokens\n@param _commissionManager CommisionManager from MocDecentralizedExchange\n@param _isBuy true if buy order, needed to identify the orderbook\n@param _orderId Order id to start expiring process. If zero, will start from ordebook top.\n@param _previousOrderIdHint previous order id hint in the orderbook to _orderId, used as on optimization to search for.\nIf zero, will start from ordebook top.\n@param _steps Number of iterations to look for expired orders to process. Use one, if just looking to process _orderId only\n@param _orderType Order type to expire\n*/\n  function processExpired(\n    Pair storage _pair,\n    CommissionManager _commissionManager,\n    bool _isBuy,\n    uint256 _orderId,\n    uint256 _previousOrderIdHint,\n    uint256 _steps,\n    OrderType _orderType\n  ) public {\n    require(_orderType == OrderType.LIMIT_ORDER || _orderType == OrderType.MARKET_ORDER, \"Invalid order type to expire\");\n    MoCExchangeLib.Token storage token = _isBuy ? _pair.baseToken : _pair.secondaryToken;\n    MoCExchangeLib.Order storage toEvaluate = _orderId == 0 ?\n      getFirstOrderToExpire(token.orderbook, _orderType) :\n      get(token.orderbook, _orderId);\n    if (toEvaluate.id != 0) {\n      require(toEvaluate.orderType == _orderType, \"The order to expire does not correspond to the specified OrderType\");\n    }\n    uint256 nextOrderId = toEvaluate.next;\n    uint256 previousOrderId = _previousOrderIdHint;\n    uint256 currStep = 0;\n    bool hasProcess = false;\n    while (currStep < _steps && toEvaluate.id != 0) {\n      currStep++;\n      if (isExpired(toEvaluate, _pair.tickState.number)) {\n        // Event if process expiring could return fail as transaction fails, the behaviour is the same,\n        // order needs to be removed and the process must continue.\n        processExpiredOrder(\n          _commissionManager,\n          token,\n          toEvaluate.id,\n          toEvaluate.exchangeableAmount,\n          toEvaluate.reservedCommission,\n          toEvaluate.owner\n        );\n        nextOrderId = toEvaluate.next;\n        // TODO: Given this is a loop, we could track the actual prev instead of just the id\n        removeOrder(token.orderbook, toEvaluate, previousOrderId);\n        hasProcess = true;\n      } else {\n        previousOrderId = toEvaluate.id;\n        nextOrderId = toEvaluate.next;\n      }\n      toEvaluate = get(token.orderbook, nextOrderId);\n    }\n    require(hasProcess, \"No expired order found\");\n  }\n\n   /*\n    @notice Checks if there is any order to expire in an orderbook of a pair\n    @dev iterates _steps times over the orderbook starting from _orderId and process any encountered expired order\n    @param _pair Pair of tokens to be evaluated\n    @param _evaluateBuyOrders true if buy orders have to be evaluated, false if sell orderrs have to\n    */\n  function areOrdersToExpire(\n    Pair storage _pair,\n    bool _evaluateBuyOrders\n  ) public view returns (bool) {\n    MoCExchangeLib.Token storage token = _evaluateBuyOrders ? _pair.baseToken : _pair.secondaryToken;\n    return\n      areOrdersToExpire(_pair.tickState.number, token.orderbook, first(token.orderbook)) ||\n      areOrdersToExpire(_pair.tickState.number, token.orderbook, firstMarketOrder(token.orderbook));\n  }\n\n\n   /*\n    @notice Checks if there is any order to expire in any orderbook given an initial order\n    @dev iterates _steps times over the orderbook starting from _firstOrderToEvaluate and returns true on the first expired order\n    @param _tickNumber Number of the current tick\n    @param _orderbook Orderbook where the tokens\n    @param _firstOrderToEvaluate the initial order that will be evaluated, all of the following will be evaluated too\n    */\n  function areOrdersToExpire(\n    uint128 _tickNumber,\n    MoCExchangeLib.Data storage _orderbook,\n    MoCExchangeLib.Order storage _firstOrderToEvaluate\n  ) internal view returns (bool) {\n    MoCExchangeLib.Order storage toEvaluate = _firstOrderToEvaluate;\n\n    uint256 nextOrderId;\n    while (toEvaluate.id != 0) {\n      if (isExpired(toEvaluate, _tickNumber))\n        return true;\n      nextOrderId = toEvaluate.next;\n      toEvaluate = get(_orderbook, nextOrderId);\n    }\n    return false;\n  }\n\n  /*\n    @notice returns funds to the owner, paying commission in the process and emits ExpiredOrderProcessed event\n    @param _commissionManager commission manager.\n    @param _token order Token data\n    @param _orderId expired order's id\n    @param _exchangeableAmount order's remainin exchangeable amount\n    @param _reservedCommission order's reserved commission\n    @param _owner order's owner\n    @return _transferResult, true if the transfer to _account was successful\n   */\n  function processExpiredOrder(\n    CommissionManager _commissionManager,\n    Token storage _token,\n    uint256 _orderId,\n    uint256 _exchangeableAmount,\n    uint256 _reservedCommission,\n    address _owner\n  ) public returns (bool) {\n    (bool transferResult, uint256 returnedAmount, uint256 commission, uint256 returnedCommission) = refundOrder(\n      _commissionManager,\n      _token.token,\n      _exchangeableAmount,\n      _reservedCommission,\n      _owner,\n      true\n    );\n    // If transfer fails, the order needs to be processed anyway. Just record that no funds where actually returned.\n    if (!transferResult) returnedAmount = 0;\n    emit ExpiredOrderProcessed(_orderId, _owner, returnedAmount, commission, returnedCommission);\n    return transferResult;\n  }\n  /*\n    @notice Hook called when the simulation of the matching of orders starts; marks as so the tick stage\n    Initializes the pageMemory with the first valid orders\n    Has one discarded param; kept to have a fixed signature\n    @dev The initialization of lastBuyMatch/lastSellMatch without checking if they should match can cause\n    some inconsistency but it is covered by the matchesAmount attribute in the pageMemory\n    @param _pair The pair of tokens\n  */\n  function onSimulationStart(Pair storage _pair) public {\n    _pair.tickStage = TickStage.RUNNING_SIMULATION;\n    _pair.pageMemory.marketPrice = getMarketPrice(_pair);\n    (\n      _pair.pageMemory.lastBuyMatch,\n      _pair.pageMemory.lastBuyLimitOrderId,\n      _pair.pageMemory.lastBuyMarketOrderId) = getNextValidOrder(_pair, true);\n    (\n      _pair.pageMemory.lastSellMatch,\n      _pair.pageMemory.lastSellLimitOrderId,\n      _pair.pageMemory.lastSellMarketOrderId) = getNextValidOrder(_pair, false);\n  }\n\n  /*\n    @notice Hook called when the simulation of the matching of orders finish; marks as so the tick stage\n    Has one discarded param; kept to have a fixed signature\n    @param _pair the pair to finish simulation\n  */\n  function onSimulationFinish(Pair storage _pair) public {\n    uint256 factorPrecision = 10**18; // FIXME how do i access this constant from another file?\n    assert(_pair.tickStage == MoCExchangeLib.TickStage.RUNNING_SIMULATION);\n\n    if (_pair.pageMemory.matchesAmount > 0) {\n      _pair.pageMemory.emergentPrice = Math.average(getOrderPrice(_pair.pageMemory.marketPrice, _pair.pageMemory.lastBuyMatch), getOrderPrice(_pair.pageMemory.marketPrice, _pair.pageMemory.lastSellMatch));\n      _pair.lastClosingPrice = _pair.pageMemory.emergentPrice;\n      _pair.emaPrice = calculateNewEMA(_pair.emaPrice, _pair.lastClosingPrice, _pair.smoothingFactor, factorPrecision);\n    }\n\n  }\n\n  /*\n    @notice Match the next two orders to be matched\n    @param _self Pair being matched\n    @param _commissionManager Commission manager of the MoC Exchange\n    @return True if there are more orders to be matched, false otherwise\n   */\n  function matchOrders(Pair storage _self, CommissionManager _commissionManager) public returns (bool) {\n    // If there are no matches, skip everything\n\n    if (_self.pageMemory.matchesAmount == 0) {\n      return false;\n    }\n\n    /* We're assigning the next order to match (in the case of a complete fill)\n     * in these variables, but the new value is never used.\n     * It's possible to delete some code and make the execution cheaper by\n     * only having the getFirstForMatching functionality, but we believe\n     * the stepFunction'll receive the number of steps to run in the near future\n     * and then we'll need the next order to match again.\n     */\n    Order storage buy = getFirstForMatching(_self, _commissionManager, _self.baseToken, _self.tickState.number);\n    Order storage sell = getFirstForMatching(_self, _commissionManager, _self.secondaryToken, _self.tickState.number);\n\n    bool isLastMatch = buy.id == _self.pageMemory.lastBuyMatch.id && sell.id == _self.pageMemory.lastSellMatch.id;\n    // As last matching orders are known from the simulation, we could use them as loop exit condition\n    (uint256 limitingAmount, MatchType matchType) = compareIntents(\n      buy.exchangeableAmount,\n      getOrderPrice(_self.pageMemory.marketPrice, buy),\n      sell.exchangeableAmount,\n      _self.priceComparisonPrecision\n    );\n\n\n    executeMatch(_commissionManager, _self, buy, sell, limitingAmount, _self.pageMemory.emergentPrice, matchType != MatchType.SELLER_FILL);\n    if (matchType == MatchType.DOUBLE_FILL) {\n      onOrderFullMatched(_self, _self.baseToken);\n      onOrderFullMatched(_self, _self.secondaryToken);\n    } else if (matchType == MatchType.BUYER_FILL) {\n      onOrderFullMatched(_self, _self.baseToken);\n    } else if (matchType == MatchType.SELLER_FILL) {\n      onOrderFullMatched(_self, _self.secondaryToken);\n    } else {\n      // TODO\n      require(false, \"Unknown type\");\n    }\n    return !isLastMatch;\n  }\n\n  /*\n    @notice Simulates a matching step i.e. making one step to make the emergent price\n    @param _self Struct that represents the pair\n    @return True if there are more orders to be matched, i.e. if the tick should\n    call simulateMatchingStep again\n   */\n  function simulateMatchingStep(Pair storage _self) public returns (bool) {\n    assert(_self.tickStage == TickStage.RUNNING_SIMULATION);\n\n    // keep in mind, this is a reference to a struct member, so by modifying it\n    // we're not modifying the \"real\" orders\n    Order storage buy = _self.pageMemory.lastBuyMatch;\n    Order storage sell = _self.pageMemory.lastSellMatch;\n    uint256 pricePrecision = _self.priceComparisonPrecision;\n    uint256 marketPrice = _self.pageMemory.marketPrice;\n\n    uint256 lastBuyLimitOrderId = _self.pageMemory.lastBuyLimitOrderId;\n    uint256 lastBuyMarketOrderId = _self.pageMemory.lastBuyMarketOrderId;\n    uint256 lastSellLimitOrderId = _self.pageMemory.lastSellLimitOrderId;\n    uint256 lastSellMarketOrderId = _self.pageMemory.lastSellMarketOrderId;\n\n    if (!shouldMatchStorage(marketPrice, buy, sell)) {\n      return false;\n    }\n\n    uint256 orderPrice = getOrderPrice(marketPrice, buy);\n    (uint256 limitingAmount, MatchType matchType) = compareIntents(\n      buy.exchangeableAmount,\n      orderPrice,\n      sell.exchangeableAmount,\n      pricePrecision\n    );\n\n    if (matchType == MatchType.DOUBLE_FILL) {\n      // the asignments from getNextValidOrder set the references\n      // to point to the \"real\" orders\n      (buy, lastBuyLimitOrderId, lastBuyMarketOrderId) = getNextValidOrder(_self, true);\n      (sell, lastSellLimitOrderId, lastSellMarketOrderId) = getNextValidOrder(_self, false);\n    } else if (matchType == MatchType.BUYER_FILL) {\n      (buy, lastBuyLimitOrderId, lastBuyMarketOrderId) = getNextValidOrder(_self, true);\n      sell.exchangeableAmount = sell.exchangeableAmount.sub(limitingAmount);\n\n    } else if (matchType == MatchType.SELLER_FILL) {\n      uint256 buyerExpectedSend = convertToBase(limitingAmount, orderPrice, pricePrecision);\n      (sell, lastSellLimitOrderId, lastSellMarketOrderId) = getNextValidOrder(_self, false);\n      buy.exchangeableAmount = buy.exchangeableAmount.sub(buyerExpectedSend);\n    } else {\n      assert(false);\n    }\n    uint256 matchToAdd = matchType == MatchType.DOUBLE_FILL ? 2 : 1;\n    _self.pageMemory.matchesAmount = _self.pageMemory.matchesAmount.add(matchToAdd);\n    if (shouldMatchStorage(marketPrice, buy, sell)) {\n      // this assignments copy:\n      // https://solidity.readthedocs.io/en/v0.5.11/types.html#reference-types\n      _self.pageMemory.lastBuyMatch = buy;\n      _self.pageMemory.lastSellMatch = sell;\n      _self.pageMemory.lastBuyLimitOrderId = lastBuyLimitOrderId;\n      _self.pageMemory.lastBuyMarketOrderId = lastBuyMarketOrderId;\n      _self.pageMemory.lastSellLimitOrderId = lastSellLimitOrderId;\n      _self.pageMemory.lastSellMarketOrderId = lastSellMarketOrderId;\n\n      return true;\n    } else {\n      return false;\n    }\n  }\n\n  /*\n    @notice gets the first not expired order of the orderbook, processing expired ones\n    @param _pair Token pair\n    @param _commissionManager commission manager.\n    @param _token order Token data\n    @param _tickNumber current tick Number\n    @return the first valid order in the orderbook\n  */\n  function getFirstForMatching(\n    Pair storage _pair,\n    CommissionManager _commissionManager,\n    Token storage _token,\n    uint64 _tickNumber\n    ) private returns (Order storage) {\n    Order storage order = mostCompetitiveOrder(\n      _pair.pageMemory.marketPrice,\n      _token.orderbook,\n      first(_token.orderbook),\n      firstMarketOrder(_token.orderbook)\n    );\n    if (isExpired(order, _tickNumber)) {\n      processExpiredOrder(_commissionManager, _token, order.id, order.exchangeableAmount, order.reservedCommission, order.owner);\n      return getNextValidOrderForMatching(_pair, _commissionManager, _token, _tickNumber);\n    }\n    return order;\n  }\n\n  /*\n    @notice Return the first order to expire.\n    @param _orderbook the orderbook with the orders\n    @param _orderType Order type to expire\n   */\n  function getFirstOrderToExpire(Data storage _orderbook, OrderType _orderType) private view returns (Order storage){\n    if (_orderType == OrderType.MARKET_ORDER){\n      return firstMarketOrder(_orderbook);\n    }\n    return first(_orderbook);\n  }\n\n  /*\n    @notice Searchs for the following valid Order\n    @param _pair Token pair\n    @param _commissionManager commission manager.\n    @param _token order Token data\n    @param _tickNumber current tick Number\n    @return the following valid order in the orderbook\n  */\n  function getNextValidOrderForMatching(Pair storage _pair, CommissionManager _commissionManager, Token storage _token, uint64 _tickNumber)\n    private\n    returns (Order storage)\n  {\n    Order storage order = popAndGetNewTop(_pair, _token.orderbook);\n    if (order.id == 0 || !isExpired(order, _tickNumber)) {\n      return order;\n    } else {\n      processExpiredOrder(_commissionManager, _token, order.id, order.exchangeableAmount, order.reservedCommission, order.owner);\n      return getNextValidOrderForMatching(_pair, _commissionManager, _token, _tickNumber);\n    }\n  }\n\n  /*\n    @notice emits OrderFullMatch for the given _order and searchs for the following valid one\n    @param _pair Token Pair\n    @param _token token with the orderbook where the order is placed\n    @return the following valid order in the orderbook\n  */\n  function onOrderFullMatched(\n    Pair storage _pair,\n    Token storage _token\n  ) private {\n    // TODO refactor; this code is repeated in popAndGetNewTop\n\n    //just pop the most competitive order\n\n    Order storage orderToPop = mostCompetitiveOrder(\n      _pair.pageMemory.marketPrice,\n      _token.orderbook,\n      first(_token.orderbook),\n      firstMarketOrder(_token.orderbook)\n    );\n    Order storage newTop = get(_token.orderbook, orderToPop.next);\n\n    if (orderToPop.orderType == OrderType.LIMIT_ORDER){\n      _token.orderbook.firstId = newTop.id;\n      decreaseQueuesLength(_token.orderbook, false);\n    }\n    else{\n      _token.orderbook.firstMarketOrderId = newTop.id;\n      decreaseQueuesLength(_token.orderbook, true);\n    }\n    delete (_token.orderbook.orders[orderToPop.id]);\n  }\n\n  /*\n    @notice Gives back the corresponding order value to the given _account\n    @param _commissionManager commission manager.\n    @param _token ERC20 token to transfer from.\n    @param _exchangeableAmount Exchangeable amount of the order\n    @param _reservedCommission Reserved amount to be potentially used in a commission\n    @param _account address of the order funds beneficiary\n    @param _isExpiration if true, uses the commission rate for expirations, otherwise uses the cancelation one\n    @return transferResult True if the transfer to _account was successful\n    @return exchangeableAmount Amount tried to be transfered from the orders to the user\n    @return chargedCommission Commission charged as penalization\n    @return commissionToReturn Amount tried to be trasfered from the commissions to the user\n  */\n  function refundOrder(\n    CommissionManager _commissionManager,\n    IERC20 _token,\n    uint256 _exchangeableAmount,\n    uint256 _reservedCommission,\n    address _account,\n    bool _isExpiration\n  ) public returns (bool, uint256, uint256, uint256) {\n    uint256 chargedCommission = _commissionManager.chargeExceptionalCommission(_reservedCommission, address(_token), _isExpiration);\n    uint256 commissionToReturn = _reservedCommission.sub(chargedCommission);\n    bool transferResult = SafeTransfer.doTransfer(_token, _account, _exchangeableAmount.add(commissionToReturn));\n    return (transferResult, _exchangeableAmount, chargedCommission, commissionToReturn);\n  }\n\n  /*\n    @notice Moves an order from the pending queue to the orderbook\n    Has two discarded param; kept to have a fixed signature\n    @dev First it tries to move everything in the buy queue and then goes to the selling queue\n    Nevertheless always checks the buy order, no mather if we finished it already in case there is\n    a new buy order while we process the sell order.\n    It is important that this is the absolute LAST task of the ticks group\n    @param _pair The pair of tokens\n    @return True if there are still pending orders to move; false otherwise\n  */\n  function movePendingMarketOrdersStepFunction(Pair storage _pair) public {\n    assert(_pair.tickStage == MoCExchangeLib.TickStage.MOVING_PENDING_ORDERS);\n    // Cannot return shouldKeepGoing based on movedBuyOrder to avoid DOS attacks where someone\n    // inserts new pending orders as soon as we finished inserting the other orders\n    bool movedBuyOrder = movePendingMarketOrderFrom(\n      _pair.baseToken,\n      _pair.pageMemory,\n      address(_pair.baseToken.token),\n      address(_pair.secondaryToken.token),\n      true\n    );\n    if (!movedBuyOrder) {\n      movePendingMarketOrderFrom(\n        _pair.secondaryToken,\n        _pair.pageMemory,\n        address(_pair.baseToken.token),\n        address(_pair.secondaryToken.token),\n        false\n      );\n    }\n  }\n\n/*\n@notice Moves an order from the pending queue to the orderbook\nHas two discarded param; kept to have a fixed signature\n@dev First it tries to move everything in the buy queue and then goes to the selling queue\nNevertheless always checks the buy order, no mather if we finished it already in case there is\na new buy order while we process the sell order.\nIt is important that this is the absolute LAST task of the ticks group\n@param _pair The pair of tokens\nfor the execution of a tick of a given pair\n@return True if there are still pending orders to move; false otherwise\n*/\n  function movePendingOrdersStepFunction(Pair storage _pair) public returns (bool shouldKeepGoing) {\n    movePendingLimitOrdersStepFunction(_pair);\n    bool pendingOrders = _pair.baseToken.orderbook.amountOfPendingOrders != 0 || _pair.secondaryToken.orderbook.amountOfPendingOrders != 0;\n    if (!pendingOrders){\n      movePendingMarketOrdersStepFunction(_pair);\n      pendingOrders = _pair.baseToken.orderbook.amountOfPendingMarketOrders != 0 || _pair.secondaryToken.orderbook.amountOfPendingMarketOrders != 0;\n    }\n\n    return pendingOrders;\n  }\n\n  /*\n    @notice Moves a limit order from the pending queue to the orderbook\n    Has two discarded param; kept to have a fixed signature\n    @dev First it tries to move everything in the buy queue and then goes to the selling queue\n    Nevertheless always checks the buy order, no mather if we finished it already in case there is\n    a new buy order while we process the sell order.\n    It is important that this is the absolute LAST task of the ticks group\n    @param _pair The pair of tokens\n    @return True if there are still pending orders to move; false otherwise\n  */\n  function movePendingLimitOrdersStepFunction(Pair storage _pair) public {\n    assert(_pair.tickStage == MoCExchangeLib.TickStage.MOVING_PENDING_ORDERS);\n    // Cannot return shouldKeepGoing based on movedBuyOrder to avoid DOS attacks where someone\n    // inserts new pending orders as soon as we finished inserting the other orders\n    bool movedBuyOrder = movePendingLimitOrderFrom(\n      _pair.baseToken,\n      _pair.pageMemory,\n      address(_pair.baseToken.token),\n      address(_pair.secondaryToken.token),\n      true\n    );\n    if (!movedBuyOrder) {\n      movePendingLimitOrderFrom(\n        _pair.secondaryToken,\n        _pair.pageMemory,\n        address(_pair.baseToken.token),\n        address(_pair.secondaryToken.token),\n        false\n      );\n    }\n  }\n\n  /*\n    @notice Moves a market order from the pending queue to the corresponding orderbook\n    @param _token Struct that containts the orderbook and pendingQueue data structures\n    @param pageMemory Page memory of this tick, has auxiliar info to make it run. Hints are useful in this fn\n    @param baseTokenAddress Address of the base token of the pair this order belongs to\n    @param secondaryTokenAddress Address of the secondary token of the pair this order belongs to\n    @param isBuy True if the _token and orderbook/pendingQueue in it are related to buy orders\n    False otherwise\n   */\n  function movePendingMarketOrderFrom(\n    Token storage _token,\n    TickPaginationMemory storage pageMemory,\n    address baseTokenAddress,\n    address secondaryTokenAddress,\n    bool isBuy\n  ) public returns (bool doneWork) {\n    if (_token.orderbook.amountOfPendingMarketOrders == 0) return false;\n    Order storage orderToMove = firstPendingMarketOrder(_token.orderbook);\n    _token.orderbook.firstPendingMarketOrderToPopId = orderToMove.next;\n    _token.orderbook.amountOfPendingMarketOrders = _token.orderbook.amountOfPendingMarketOrders.sub(1);\n\n    // position orderToMove\n    uint256 previousOrderId;\n    //TODO: DAM: Check this\n    if (pageMemory.hintIdsIndex < pageMemory.hintIds.length) {\n      previousOrderId = pageMemory.hintIds[pageMemory.hintIdsIndex++];\n      validatePreviousMarketOrder(_token.orderbook, orderToMove.multiplyFactor, previousOrderId);\n    } else {\n      previousOrderId = findPreviousMarketOrderToMultiplyFactor(_token.orderbook, orderToMove.multiplyFactor);\n    }\n\n    emit NewOrderInserted(\n      orderToMove.id,\n      orderToMove.owner,\n      baseTokenAddress,\n      secondaryTokenAddress,\n      orderToMove.exchangeableAmount,\n      orderToMove.reservedCommission,\n      0,\n      orderToMove.multiplyFactor,\n      orderToMove.expiresInTick,\n      isBuy,\n      OrderType.MARKET_ORDER\n    );\n\n    positionMarketOrder(_token.orderbook, orderToMove.id, previousOrderId);\n    return true;\n  }\n\n  /*\n    @notice Moves an order from the pending queue to the corresponding orderbook\n    @param _token Struct that containts the orderbook and pendingQueue data structures\n    @param pageMemory Page memory of this tick, has auxiliar info to make it run. Hints are useful in this fn\n    @param baseTokenAddress Address of the base token of the pair this order belongs to\n    @param secondaryTokenAddress Address of the secondary token of the pair this order belongs to\n    @param isBuy True if the _token and orderbook/pendingQueue in it are related to buy orders\n    False otherwise\n   */\n  function movePendingLimitOrderFrom(\n    Token storage _token,\n    TickPaginationMemory storage pageMemory,\n    address baseTokenAddress,\n    address secondaryTokenAddress,\n    bool isBuy\n  ) public returns (bool doneWork) {\n    if (_token.orderbook.amountOfPendingOrders == 0) return false;\n    // pop from queue\n    Order storage orderToMove = firstPending(_token.orderbook);\n    _token.orderbook.firstPendingToPopId = orderToMove.next;\n    _token.orderbook.amountOfPendingOrders = _token.orderbook.amountOfPendingOrders.sub(1);\n\n    // position orderToMove\n    uint256 previousOrderId;\n    if (pageMemory.hintIdsIndex < pageMemory.hintIds.length) {\n      previousOrderId = pageMemory.hintIds[pageMemory.hintIdsIndex++];\n      validatePreviousOrder(_token.orderbook, orderToMove.price, previousOrderId);\n    } else {\n      previousOrderId = findPreviousOrderToPrice(_token.orderbook, orderToMove.price);\n    }\n\n    emit NewOrderInserted(\n      orderToMove.id,\n      orderToMove.owner,\n      baseTokenAddress,\n      secondaryTokenAddress,\n      orderToMove.exchangeableAmount,\n      orderToMove.reservedCommission,\n      orderToMove.price,\n      0,\n      orderToMove.expiresInTick,\n      isBuy,\n      OrderType.LIMIT_ORDER // TODO This is correct for now; but we might have to change it soon\n    );\n\n    positionOrder(_token.orderbook, orderToMove.id, previousOrderId);\n    return true;\n  }\n\n  /*\n   * @notice Get the current market price calling PriceProvider\n   * @param _pair The pair of tokens\n   */\n  function getMarketPrice(Pair storage _pair) public view returns(uint256) {\n    (bytes32 binaryPrice, bool success) = _pair.priceProvider.peek();\n    require(success, \"Price not available\");\n    return uint256(binaryPrice);\n  }\n}\n\n// File: contracts/ConfigurableTick.sol\n\npragma solidity 0.5.8;\n\n\n\n\ncontract ConfigurableTick is Governed {\n  TickState.Config public tickConfig;\n\n  /*\n    @notice Sets the expected orders for tick, it must be higher or equal than two\n    @param _expectedOrdersForTick The new expectedOrdersForTick\n   */\n  function setExpectedOrdersForTick(uint64 _expectedOrdersForTick) external onlyAuthorizedChanger {\n    require(_expectedOrdersForTick >= 2, \"Expected orders for tick too low\");\n    tickConfig.expectedOrdersForTick = _expectedOrdersForTick;\n  }\n\n  /*\n    @notice Sets a new maxBlocksForTick, it must be higher or equal than the minimum\n    @param _maxBlocksForTick The new maxBlocksForTick\n   */\n  function setMaxBlocksForTick(uint64 _maxBlocksForTick) external onlyAuthorizedChanger {\n    require(_maxBlocksForTick >= tickConfig.minBlocksForTick, \"min BlockForTick should be lower than max\");\n    tickConfig.maxBlocksForTick = _maxBlocksForTick;\n  }\n\n  /*\n    @notice Sets a new minBlocksForTick, it must be lower or equal than the maximum\n    @param _minBlocksForTick The new minBlocksForTick\n   */\n  function setMinBlocksForTick(uint64 _minBlocksForTick) external onlyAuthorizedChanger {\n    require(_minBlocksForTick <= tickConfig.maxBlocksForTick, \"min BlockForTick should be lower than max\");\n    tickConfig.minBlocksForTick = _minBlocksForTick;\n  }\n\n  /*\n    @notice Initialize the contract, kind of like a constructor, but able to be used in a proxy-pattern\n    contract\n    @param _expectedOrdersForTick amount of orders expected to match in each tick\n    @param _maxBlocksForTick the max amount of blocks to wait until allowing to run the tick\n    @param _minBlocksForTick the min amount of blocks to wait until allowing to run the tick\n    @param _governor Address in charge of determining who is authorized and who is not\n */\n  function initialize(uint64 _expectedOrdersForTick, uint64 _maxBlocksForTick, uint64 _minBlocksForTick, address _governor)\n    internal\n    initializer\n  {\n    require(_expectedOrdersForTick >= 2, \"Expected orders for tick too low\");\n    require(_maxBlocksForTick >= _minBlocksForTick, \"min BlockForTick should be lower than max\");\n    tickConfig = TickState.Config(_expectedOrdersForTick, _maxBlocksForTick, _minBlocksForTick);\n    Governed.initialize(_governor);\n  }\n\n  // Leave a gap betweeen inherited contracts variables in order to be\n  // able to add more variables in them later\n  uint256[50] private upgradeGap;\n}\n\n// File: contracts/TokenPairListing.sol\n\npragma solidity 0.5.8;\n\n\n\n\n\n\n\n\ncontract EventfulTokenPairListing {\n  event TokenPairDisabled(address baseToken, address secondaryToken);\n  event TokenPairEnabled(address baseToken, address secondaryToken);\n}\n\ncontract TokenPairListing is ConfigurableTick, EventfulTokenPairListing {\n  using MoCExchangeLib for MoCExchangeLib.Data;\n  using TickState for TickState.Data;\n  using MoCExchangeLib for MoCExchangeLib.Pair;\n  using MoCExchangeLib for MoCExchangeLib.OrderType;\n  using SafeMath for uint256;\n\n  // tokenPairAddresses stores the addresses of every listed pair\n  // tokenPairs stores the Pair structures, indexed by\n  // the hash of both addresses:\n  // pairHash = sha256(abi.encodePacked(baseAddress, secondarAddress))\n  // this is necessary to be able to know how many pairs there are\n  // and which token pairs are listed.\n  mapping(bytes32 => MoCExchangeLib.Pair) tokenPairs;\n  address[2][] public tokenPairAddresses;\n\n  uint256 public constant PRECISION_SMOOTHING_FACTOR = 10**18;\n  uint256 public constant SMOOTHING_FACTOR = 16530000000000000;\n\n  /*\n@notice Check if the new pair is valid; i.e. it or its inverse is not listed already, and\nthat the tokens are different; fails otherwise\n\n@param _baseToken Address of the base token of the pair\n@param _secondaryToken Address of the secondary token of the pair\n*/\n  modifier isNewPairValid(address _baseToken, address _secondaryToken) {\n    require(!validPair(_baseToken, _secondaryToken), \"Existent pair\");\n    require(!validPair(_secondaryToken, _baseToken), \"Existent inverse pair\");\n    require(_baseToken != _secondaryToken, \"Base equal to secondary\");\n    _;\n  }\n\n  /*\n@notice Disable the insertion of orders in a pair; the pair must have been added before and must not be disabled currently\nEmits an event\n@param _baseToken Address of the base token of the pair\n@param _secondaryToken Address of the secondary token of the pair\n*/\n  function disableTokenPair(address _baseToken, address _secondaryToken) public onlyAuthorizedChanger {\n    MoCExchangeLib.Pair storage pair = getTokenPair(_baseToken, _secondaryToken);\n    require(!pair.disabled, \"Pair already disabled\");\n    pair.disabled = true;\n    emit TokenPairDisabled(_baseToken, _secondaryToken);\n  }\n\n  /*\n@notice Re-enable the insertion of orders in a pair; the pair must have been added\nand disabled first\nEmits an event\n@param _baseToken Address of the base token of the pair\n@param _secondaryToken Address of the secondary token of the pair\n*/\n  function enableTokenPair(address _baseToken, address _secondaryToken) public onlyAuthorizedChanger {\n    MoCExchangeLib.Pair storage pair = getTokenPair(_baseToken, _secondaryToken);\n    require(pair.disabled, \"Pair already enabled\");\n    pair.disabled = false;\n    emit TokenPairEnabled(_baseToken, _secondaryToken);\n  }\n\n  /*\n@dev Sets the smoothing factor for a specific token pair\n@param _baseToken Address of the base token of the pair\n@param _secondaryToken Address of the secondary token of the pair\n@param _smoothingFactor wad from 0 to 1 that represents the smoothing factor for EMA calculation\n*/\n  function setTokenPairSmoothingFactor(\n    address _baseToken,\n    address _secondaryToken,\n    uint256 _smoothingFactor\n  ) public onlyAuthorizedChanger {\n    MoCExchangeLib.Pair storage pair = getTokenPair(_baseToken, _secondaryToken);\n    require(_smoothingFactor <= PRECISION_SMOOTHING_FACTOR, \"Smoothing factor should be in relation to 1\");\n    pair.smoothingFactor = _smoothingFactor;\n  }\n\n  /*\n  @dev Sets the EMA Price for a specific token pair\n  @param _baseToken Address of the base token of the pair\n  @param _secondaryToken Address of the secondary token of the pair\n  @param _emaPrice The new EMA price for the token pair\n  */\n  function setTokenPairEmaPrice(\n    address _baseToken,\n    address _secondaryToken,\n    uint256 _emaPrice\n  ) public onlyAuthorizedChanger {\n    MoCExchangeLib.Pair storage pair = getTokenPair(_baseToken, _secondaryToken);\n    pair.emaPrice = _emaPrice;\n  }\n\n  /*\n  @dev Sets a price provider for a specific token pair\n  @param _baseToken Address of the base token of the pair\n  @param _secondaryToken Address of the secondary token of the pair\n  @param _priceProvider Address of the price provider\n  */\n  function setPriceProvider(\n    address _baseToken,\n    address _secondaryToken,\n    address _priceProvider\n  ) public onlyAuthorizedChanger() {\n    require(validPair(_baseToken, _secondaryToken), \"The pair does not exist\");\n    require(_priceProvider != address(0), \"Price provider address can not be 0x\");\n    MoCExchangeLib.Pair storage pair = getTokenPair(_baseToken, _secondaryToken);\n    pair.priceProvider = IPriceProvider(_priceProvider);\n  }\n\n  /*\n@notice Adds a token pair to be listed; the base token must be the commonBaseToken or be listed against it; the pair\nor its inverse must not be listed already\n\n@param _baseToken Address of the base token of the pair\n@param _secondaryToken Address of the secondary token of the pair\n@param _priceComparisonPrecision Precision to be used in the pair price\n@param _initialPrice Price used initially until a new tick with matching orders is run\n*/\n  function addTokenPair(\n    address _baseToken,\n    address _secondaryToken,\n    address _priceProvider,\n    uint256 _priceComparisonPrecision,\n    uint256 _initialPrice\n  ) public onlyAuthorizedChanger() isNewPairValid(_baseToken, _secondaryToken) {\n    require(_initialPrice > 0, \"initialPrice no zero\");\n    bytes32 pairIndex = hashAddresses(_baseToken, _secondaryToken);\n    tokenPairAddresses.push([_baseToken, _secondaryToken]);\n    tokenPairs[pairIndex] = MoCExchangeLib.Pair(\n      MoCExchangeLib.Token(MoCExchangeLib.Data(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, true), IERC20(_baseToken)),\n      MoCExchangeLib.Token(MoCExchangeLib.Data(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, false), IERC20(_secondaryToken)),\n      IPriceProvider(_priceProvider),\n      // initialize TickState with the given Tick number and an nextTickBlock of blocksForTick after the current one\n      TickState.Data(SafeMath.add(block.number, tickConfig.minBlocksForTick), 0, 0, 1),\n      MoCExchangeLib.TickPaginationMemory(\n        0,\n        0,\n        new uint256[](0),\n        0,\n        MoCExchangeLib.Order(MoCExchangeLib.OrderType.LIMIT_ORDER, 0, 0, 0, 0, 0, 0, address(0), 0),\n        MoCExchangeLib.Order(MoCExchangeLib.OrderType.LIMIT_ORDER, 0, 0, 0, 0, 0, 0, address(0), 0),\n        0,\n        0,\n        0,\n        0,\n        0\n      ),\n      MoCExchangeLib.TickStage.RECEIVING_ORDERS,\n      _priceComparisonPrecision,\n      _initialPrice,\n      false,\n      _initialPrice,\n      SMOOTHING_FACTOR\n    );\n  }\n\n  /*\n@notice Returns the tick context of a given pair\n@param _baseToken Address of the base token of the pair\n@param _secondaryToken Address of the secondary token of the pair\n@return tickNumber Current tick number\n@return nextTickBlock The first block on which the next tick will be runnable\n@return lastTickBlock The first block on which the last tick was run\n*/\n  function getNextTick(address _baseToken, address _secondaryToken)\n    public\n    view\n    returns (\n      uint64 tickNumber,\n      uint256 nextTickBlock,\n      uint256 lastTickBlock\n    )\n  {\n    MoCExchangeLib.Pair storage pair = tokenPair(_baseToken, _secondaryToken);\n    return (pair.tickState.number, pair.tickState.nextTickBlock, pair.tickState.lastTickBlock);\n  }\n\n  /*\n@notice Returns the amount of pairs that have been added\n*/\n  function tokenPairCount() public view returns (uint256) {\n    return tokenPairAddresses.length;\n  }\n\n  /*\n@notice Returns all the pairs that have been added\n*/\n  function getTokenPairs() public view returns (address[2][] memory) {\n    return tokenPairAddresses;\n  }\n\n  /*\n@notice Hashes a pair of tokens\n@param _baseToken Address of the base token of the pair\n@param _secondaryToken Address of the secondary token of the pair\n@return Returns an id that can be used to identify the pair\n*/\n  function hashAddresses(address _baseToken, address _secondaryToken) public pure returns (bytes32) {\n    return keccak256(abi.encodePacked(_baseToken, _secondaryToken));\n  }\n\n  /*\n@notice Sets last closing price of a pair\n@dev Intended to keep a price updated if the pair is no longer enabled or not sufficiently active\nand it affects negatively other pairs that depend on this\n@param _baseToken Address of the base token of the pair\n@param _secondaryToken Address of the secondary token of the pair\n@param _price New price to set[base/secondary]\n*/\n  function setLastClosingPrice(\n    address _baseToken,\n    address _secondaryToken,\n    uint256 _price\n  ) public onlyAuthorizedChanger {\n    require(_price > 0, \"The given initial price should be greater than 0\");\n    MoCExchangeLib.Pair storage pair = getTokenPair(_baseToken, _secondaryToken);\n    pair.lastClosingPrice = _price;\n  }\n\n  /*\n@notice Returns the status of a pair\n@param _baseToken Address of the base token of the pair\n@param _secondaryToken Address of the secondary token of the pair\n@return tickNumber Number of the current tick\n@return nextTickBlock Block in which the next tick will be able to run\n@return lastTickBlock Block in which the last tick started to run\n@return lastClosingPrice Emergent price of the last tick\n@return disabled True if the pair is disabled(it can not be inserted any orders); false otherwise\n*/\n  function getStatus(address _baseToken, address _secondaryToken)\n    internal\n    view\n    returns (\n      uint64 tickNumber,\n      uint256 nextTickBlock,\n      uint256 lastTickBlock,\n      uint256 lastClosingPrice,\n      bool disabled,\n      uint256 emaPrice,\n      uint256 smoothingFactor\n    )\n  {\n    return tokenPair(_baseToken, _secondaryToken).getStatus();\n  }\n\n  /*\n@notice returns the struct for the given pair, reverts if the pair does not exist\n@param _baseToken Address of the base token of the pair\n@param _secondaryToken Address of the secondary token of the pair\n*/\n  function getTokenPair(address _baseToken, address _secondaryToken) internal view returns (MoCExchangeLib.Pair storage pair) {\n    pair = tokenPair(_baseToken, _secondaryToken);\n    require(pair.isValid(), \"Token pair does not exist\");\n    return pair;\n  }\n\n  /*\n@notice returns the TokenPair struct for the given id, reverts if the pair does not exist\n@param _id Id of the pair\n*/\n  function getTokenPair(bytes32 _id) internal view returns (MoCExchangeLib.Pair storage pair) {\n    pair = tokenPairs[_id];\n    require(pair.isValid(), \"Token pair does not exist\");\n    return pair;\n  }\n\n  /*\n@notice returns the TokenPair struct for the given pair, the returned struct is empty if the pair does not exist\n@param _baseToken Address of the base token of the pair\n@param _secondaryToken Address of the secondary token of the pair\n*/\n  function tokenPair(address _baseToken, address _secondaryToken) internal view returns (MoCExchangeLib.Pair storage) {\n    return tokenPairs[hashAddresses(_baseToken, _secondaryToken)];\n  }\n\n  /*\n@notice Returns true if the given pair has been added previously. It does not affect if the pair has been disabled\nReturns true if not\n*/\n  function validPair(address _baseToken, address _secondaryToken) internal view returns (bool) {\n    return tokenPair(_baseToken, _secondaryToken).isValid();\n  }\n\n  // Leave a gap betweeen inherited contracts variables in order to be\n  // able to add more variables in them later\n  uint256[50] private upgradeGap;\n}\n\n// File: contracts/TokenPairConverter.sol\n\npragma solidity 0.5.8;\n\n\n\ncontract TokenPairConverter is TokenPairListing {\n  using SafeMath for uint256;\n\n  address private commonBaseTokenAddress;\n\n  /*\n    @notice Adds a token pair to be listed; the base token must be the commonBaseToken or be listed against it; the pair\n    or its inverse must not be listed already\n\n    @param _baseToken Address of the base token of the pair\n    @param _secondaryToken Address of the secondary token of the pair\n    @param _priceProvider Address of the oracle price provider\n    @param _priceComparisonPrecision Precision to be used in the pair price\n    @param _initialPrice Price used initially until a new tick with matching orders is run\n  */\n  function addTokenPair(\n    address _baseToken,\n    address _secondaryToken,\n    address _priceProvider,\n    uint256 _priceComparisonPrecision,\n    uint256 _initialPrice\n  ) public {\n    // The TokenPairListing validates the caller is an authorized changer\n    require(_baseToken == commonBaseTokenAddress || validPair(commonBaseTokenAddress, _baseToken), \"Invalid Pair\");\n    TokenPairListing.addTokenPair(_baseToken, _secondaryToken, _priceProvider, _priceComparisonPrecision, _initialPrice);\n  }\n\n  /*\n    @dev simple converter from the given token to a common base, in this case, Dollar on Chain\n    @param _tokenAddress the token address of token to convert into the common base token\n    @param _amount the amount to convert\n    @param _baseAddress the address of the base of the pair in witch the token its going to operate.\n    if the the token it is allready the base of the pair, this parameter it is unimportant\n    @return convertedAmount the amount converted into the common base token\n  */\n  function convertTokenToCommonBase(\n    address _tokenAddress,\n    uint256 _amount,\n    address _baseAddress\n  ) public view returns (uint256 convertedAmount) {\n    if (_tokenAddress == commonBaseTokenAddress) {\n      return _amount;\n    }\n    MoCExchangeLib.Pair storage pair = tokenPair(commonBaseTokenAddress, _tokenAddress);\n    if (pair.isValid()) {\n      return MoCExchangeLib.convertToBase(_amount, pair.emaPrice, pair.priceComparisonPrecision);\n    }\n\n    pair = tokenPair(commonBaseTokenAddress, _baseAddress);\n    if (pair.isValid()) {\n      uint256 intermediaryAmount = MoCExchangeLib.convertToBase(_amount, pair.emaPrice, pair.priceComparisonPrecision);\n      pair = tokenPair(_baseAddress, _tokenAddress);\n      if (pair.isValid()) {\n        return MoCExchangeLib.convertToBase(intermediaryAmount, pair.emaPrice, pair.priceComparisonPrecision);\n      }\n    }\n\n    /* There was no possible conversion from the given token to the common base */\n    return ~uint256(0);\n  }\n\n  /*\n    @param _commonBaseTokenAddress address of the common base token, necessary to convert amounts to a known scale\n    @param _expectedOrdersForTick amount of orders expected to match in each tick\n    @param _maxBlocksForTick the max amount of blocks to wait until allowing to run the tick\n    @param _minBlocksForTick the min amount of blocks to wait until allowing to run the tick\n    @param _governor Address in charge of determining who is authorized and who is not\n */\n  function initialize(\n    address _commonBaseTokenAddress,\n    uint64 _expectedOrdersForTick,\n    uint64 _maxBlocksForTick,\n    uint64 _minBlocksForTick,\n    address _governor\n  ) internal initializer {\n    require(_commonBaseTokenAddress != address(0), \"commoBaseTokenAddress cannot be null\");\n    commonBaseTokenAddress = _commonBaseTokenAddress;\n    ConfigurableTick.initialize(_expectedOrdersForTick, _maxBlocksForTick, _minBlocksForTick, _governor);\n  }\n\n  // Leave a gap betweeen inherited contracts variables in order to be\n  // able to add more variables in them later\n  uint256[50] private upgradeGap;\n}\n\n// File: contracts/OrderListing.sol\n\npragma solidity 0.5.8;\n\n\n\n\n\n\ncontract EventfulOrderListing {\n  /*\n    @dev Cloned from MoCExchangeLib.sol or the event it is not recognized and emitted from that lib\n  */\n  event NewOrderInserted(\n    uint256 indexed id,\n    address indexed sender,\n    address baseTokenAddress,\n    address secondaryTokenAddress,\n    uint256 exchangeableAmount,\n    uint256 reservedCommission,\n    uint256 price,\n    uint256 multiplyFactor,\n    uint64 expiresInTick,\n    bool isBuy,\n    MoCExchangeLib.OrderType orderType\n  );\n\n  /*\n    @notice Order cancelled event\n    @param id order's id\n    @param sender cancel executor address\n    @param returnedAmount the amount transfered back to the order' owner\n    @param commission the commission applied as penalization for the cancel\n    @param returnedCommission the commission returned as the cancelation does not consume the whole commission\n    @param isBuy true, if it's a buy Order. Meaning the returned amount is a Base Token transfer.\n */\n  event OrderCancelled(\n    uint256 indexed id,\n    address indexed sender,\n    uint256 returnedAmount,\n    uint256 commission,\n    uint256 returnedCommission,\n    bool isBuy\n  );\n\n  /*\n    @dev Cloned from SafeTransfer.sol or the event it is not recogniced and emited from that lib\n  */\n  event TransferFailed(address indexed _tokenAddress, address indexed _to, uint256 _amount, bool _isRevert);\n}\n\ncontract OrderListing is EventfulOrderListing, TokenPairConverter, OrderIdGenerator, Stoppable, ReentrancyGuard {\n  // intentionally using the biggest possible uint256\n  // so it doesn't conflict with valid ids\n  uint256 private constant NO_HINT = ~uint256(0);\n\n  CommissionManager public commissionManager;\n\n  /*\n    @notice Returns the amount of sell orders(not including the pending ones) that are in the orderbook of this pair\n    @param _baseToken the base token of the pair\n    @param _secondaryToken the secondary token of the pair\n   */\n  function sellOrdersLength(address _baseToken, address _secondaryToken) external view returns (uint256) {\n    return tokenPair(_baseToken, _secondaryToken).secondaryToken.orderbook.length;\n  }\n\n  /*\n    @notice Returns the amount of buy orders(not including the pending ones) that are in the orderbook of this pair\n    @param _baseToken the base token of the pair\n    @param _secondaryToken the secondary token of the pair\n   */\n  function buyOrdersLength(address _baseToken, address _secondaryToken) external view returns (uint256) {\n    return tokenPair(_baseToken, _secondaryToken).baseToken.orderbook.length;\n  }\n\n  /*\n    @notice Returns the amount of pending sell orders that are in the orderbook of this pair\n    @param _baseToken the base token of the pair\n    @param _secondaryToken the secondary token of the pair\n   */\n  function pendingSellOrdersLength(address _baseToken, address _secondaryToken) external view returns (uint256) {\n    return pendingSellOrdersLength(tokenPair(_baseToken, _secondaryToken));\n  }\n\n  /*\n    @notice Returns the amount of pending market orders that are in the orderbook of this pair\n    @param _baseToken the base token of the pair\n    @param _secondaryToken the secondary token of the pair\n    @param _isBuy true to get buy market orders amount, false to get sell market orders amount.\n   */\n  function pendingMarketOrdersLength(address _baseToken, address _secondaryToken, bool _isBuy) external view returns (uint256) {\n    return pendingMarketOrdersLength(tokenPair(_baseToken, _secondaryToken), _isBuy);\n  }\n\n  /*\n    @notice Returns the amount of pending buy orders that are in the orderbook of this pair\n    @param _baseToken the base token of the pair\n    @param _secondaryToken the secondary token of the pair\n   */\n  function pendingBuyOrdersLength(address _baseToken, address _secondaryToken) external view returns (uint256) {\n    return pendingBuyOrdersLength(tokenPair(_baseToken, _secondaryToken));\n  }\n\n  /*\n    @notice Returns the price provider of a given pair\n    @param _baseToken the base token of the pair\n    @param _secondaryToken the secondary token of the pair\n   */\n  function getPriceProvider(address _baseToken, address _secondaryToken) external view returns (address) {\n    MoCExchangeLib.Pair storage pair = tokenPair(_baseToken, _secondaryToken);\n    return address(pair.priceProvider);\n  }\n\n  /*\n    @notice Withdraws all the already charged(because of a matching, a cancellation or an expiration)\n    commissions of a given token\n    @param token Address of the token to withdraw the commissions from\n   */\n  function withdrawCommissions(address token) external nonReentrant {\n    MoCExchangeLib.withdrawCommissions(token, commissionManager);\n  }\n\n  /*\n    @notice Inserts an order in the buy orderbook of a given pair without a hint\n    the pair should not be disabled; the contract should not be paused. Takes the funds\n    with a transferFrom\n    @param _baseToken the base token of the pair\n    @param _secondaryToken the secondary token of the pair\n    @param _amount Amount to be locked[base]; should have enough allowance\n    @param _price Maximum price to be paid [base/secondary]\n    @param _lifespan After _lifespan ticks the order will be expired and no longer matched, must be lower or equal than the maximum\n   */\n  function insertBuyLimitOrder(\n    address _baseToken,\n    address _secondaryToken,\n    uint256 _amount,\n    uint256 _price,\n    uint64 _lifespan\n  ) public {\n    insertBuyLimitOrderAfter(_baseToken, _secondaryToken, _amount, _price, _lifespan, NO_HINT);\n  }\n\n  /*\n    @notice Inserts an order in the sell orderbook of a given pair without a hint\n    the pair should not be disabled; the contract should not be paused. Takes the funds\n    with a transferFrom\n    @param _baseToken the base token of the pair\n    @param _secondaryToken the secondary token of the pair\n    @param _amount Amount to be locked[secondary]; should have enough allowance; must be greater or equal\n    than a minimum in commonBaseToken currency\n    @param _price Minimum price to charge [base/secondary]\n    @param _lifespan After _lifespan ticks the order will be expired and no longer matched, must be lower or equal than the maximum\n   */\n  function insertSellLimitOrder(\n    address _baseToken,\n    address _secondaryToken,\n    uint256 _amount,\n    uint256 _price,\n    uint64 _lifespan\n  ) public {\n    insertSellLimitOrderAfter(_baseToken, _secondaryToken, _amount, _price, _lifespan, NO_HINT);\n  }\n\n  /*\n    @notice Inserts an order in the buy orderbook of a given pair with a hint;\n    the pair should not be disabled; the contract should not be paused. Takes the funds\n    with a transferFrom\n    @param _baseToken the base token of the pair\n    @param _secondaryToken the secondary token of the pair\n    @param _amount Amount to be locked[base]; should have enough allowance\n    @param _price Maximum price to be paid [base/secondary]\n    @param _lifespan After _lifespan ticks the order will be expired and no longer matched, must be lower or equal than the maximum\n    @param _previousOrderIdHint Order that comes immediately before the new order;\n    NO_HINT is considered as no hint and the smart contract must iterate from the beginning\n    0 is considered to be a hint to put it at the start\n  */\n  function insertBuyLimitOrderAfter(\n    address _baseToken,\n    address _secondaryToken,\n    uint256 _amount,\n    uint256 _price,\n    uint64 _lifespan,\n    uint256 _previousOrderIdHint\n  ) public whenNotPaused {\n    insertBuyLimitOrderAfter(getTokenPair(_baseToken, _secondaryToken), _amount, _price, _lifespan, _previousOrderIdHint);\n  }\n\n  /*\n    @notice Inserts an order in the sell orderbook of a given pair with a hint\n    the pair should not be disabled; the contract should not be paused. Takes the funds\n    with a transferFrom\n    @param _baseToken the base token of the pair\n    @param _secondaryToken the secondary token of the pair\n    @param _amount Amount to be locked[secondary]; should have enough allowance; must be greater or equal\n    than a minimum in commonBaseToken currency\n    @param _price Minimum price to charge [base/secondary]\n    @param _lifespan After _lifespan ticks the order will be expired and no longer matched, must be lower or equal than the maximum\n    @param _previousOrderIdHint Order that comes immediately before the new order;\n    NO_HINT is considered as no hint and the smart contract must iterate from the beginning\n    0 is considered to be a hint to put it at the start\n  */\n  function insertSellLimitOrderAfter(\n    address _baseToken,\n    address _secondaryToken,\n    uint256 _amount,\n    uint256 _price,\n    uint64 _lifespan,\n    uint256 _previousOrderIdHint\n  ) public whenNotPaused {\n    insertSellLimitOrderAfter(getTokenPair(_baseToken, _secondaryToken), _amount, _price, _lifespan, _previousOrderIdHint);\n  }\n\n  /*\n    @notice cancels the buy _orderId order.\n    The contract must not be paused; the caller should be the order owner\n    @param _baseToken Base Token involved in the canceled Order pair\n    @param _secondaryToken Secondary Token involved in the canceled Order pair\n    @param _orderId Order id to cancel\n    @param _previousOrderIdHint previous order in the orderbook, used as on optimization to search for.\n  */\n  function cancelBuyOrder(\n    address _baseToken,\n    address _secondaryToken,\n    uint256 _orderId,\n    uint256 _previousOrderIdHint\n  ) public whenNotPaused {\n    doCancelOrder(getTokenPair(_baseToken, _secondaryToken), _orderId, _previousOrderIdHint, true);\n  }\n\n  /*\n    @notice cancels the sell _orderId order.\n    the contract must not be paused; the caller should be the order owner\n    @param _baseToken Base Token involved in the canceled Order pair\n    @param _secondaryToken Secondary Token involved in the canceled Order pair\n    @param _orderId Order id to cancel\n    @param _previousOrderIdHint previous order in the orderbook, used as on optimization to search for.\n  */\n  function cancelSellOrder(\n    address _baseToken,\n    address _secondaryToken,\n    uint256 _orderId,\n    uint256 _previousOrderIdHint\n  ) public whenNotPaused {\n    doCancelOrder(getTokenPair(_baseToken, _secondaryToken), _orderId, _previousOrderIdHint, false);\n  }\n\n  /*\n    @notice Inserts a market order at start in the buy orderbook of a given pair with a hint;\n    the pair should not be disabled; the contract should not be paused. Takes the funds\n    with a transferFrom\n    @param _baseToken the base token of the pair\n    @param _secondaryToken the secondary token of the pair\n    @param _amount The quantity of tokens sent\n    @param _multiplyFactor Maximum price to be paid [base/secondary]\n    @param _lifespan After _lifespan ticks the order will be expired and no longer matched, must be lower or equal than the maximum\n    @param _isBuy true if it is a buy market order\n  */\n  function insertMarketOrder(\n    address _baseToken,\n    address _secondaryToken,\n    uint256 _amount,\n    uint256 _multiplyFactor,\n    uint64 _lifespan,\n    bool _isBuy\n  ) public whenNotPaused {\n    insertMarketOrderAfter(_baseToken, _secondaryToken, _amount, _multiplyFactor, NO_HINT, _lifespan, _isBuy);\n  }\n\n  /*\n    @notice Inserts a market order in the buy orderbook of a given pair with a hint;\n    the pair should not be disabled; the contract should not be paused. Takes the funds\n    with a transferFrom\n    @param _baseToken the base token of the pair\n    @param _secondaryToken the secondary token of the pair\n    @param _amount The quantity of tokens sent\n    @param _multiplyFactor Maximum price to be paid [base/secondary]\n    @param _previousOrderIdHint Order that comes immediately before the new order;\n    NO_HINT is considered as no hint and the smart contract must iterate from the beginning\n    0 is considered to be a hint to put it at the start\n    @param _lifespan After _lifespan ticks the order will be expired and no longer matched, must be lower or equal than the maximum\n    @param _isBuy true if it is a buy market order\n  */\n  function insertMarketOrderAfter(\n    address _baseToken,\n    address _secondaryToken,\n    uint256 _amount,\n    uint256 _multiplyFactor,\n    uint256 _previousOrderIdHint,\n    uint64 _lifespan,\n    bool _isBuy\n  ) public whenNotPaused {\n    MoCExchangeLib.Pair storage pair = getTokenPair(_baseToken, _secondaryToken);\n    uint256 _priceCommonBase = TokenPairConverter.convertTokenToCommonBase(\n      _isBuy ? address(_baseToken) : address(_secondaryToken),\n      uint256(10**18),\n      _isBuy ? address(_secondaryToken) : address(_baseToken)\n    );\n    uint256 initialFee = commissionManager.calculateInitialFee(_amount, _priceCommonBase);\n    require(initialFee <= _amount, \"Amount is greater than Fee\");\n    pair.doInsertMarketOrder(\n      nextId(),\n      _amount.sub(initialFee),\n      initialFee,\n      _multiplyFactor,\n      _lifespan,\n      _previousOrderIdHint,\n      msg.sender,\n      _isBuy\n    );\n  }\n\n  /*\n    @notice returns the corresponding user amount. Emits the CancelOrder event\n    @param _pair Token Pair involved in the canceled Order\n    @param _orderId Order id to cancel\n    @param _previousOrderIdHint previous order in the orderbook, used as on optimization to search for.\n    @param _isBuy true if it's a buy order, meaning the funds should be from base Token\n  */\n  function doCancelOrder(\n    MoCExchangeLib.Pair storage _pair,\n    uint256 _orderId,\n    uint256 _previousOrderIdHint,\n    bool _isBuy\n  ) internal {\n    MoCExchangeLib.Token storage token = _isBuy ? _pair.baseToken : _pair.secondaryToken;\n    (uint256 exchangeableAmount, uint256 reservedCommission) = MoCExchangeLib.doCancelOrder(_pair, _orderId, _previousOrderIdHint, _isBuy);\n\n    (bool transferResult, uint256 returnedAmount, uint256 commission, uint256 returnedCommission) = MoCExchangeLib.refundOrder(\n      commissionManager,\n      token.token,\n      exchangeableAmount,\n      reservedCommission,\n      msg.sender,\n      false\n    );\n    require(transferResult, \"Token transfer failed\");\n    emit OrderCancelled(_orderId, msg.sender, returnedAmount, commission, returnedCommission, _isBuy);\n  }\n\n  /*\n    @dev This function must initialize every variable in storage, this is necessary because of the proxy\n    pattern we are using. The initializer modifier disables this function once its called so it prevents\n    that someone else calls it without the deployer noticing. Of course they may block your deploys but that\n    would be an extremely unlucky scenario. onlyAuthorizedChanger cannot be used here since the governor is not set yet\n    @param _commonBaseTokenAddress address of the common base token, necessary to convert amounts to a known scale\n    @param _commissionManager Address of the contract that manages all the fee related things\n    @param _expectedOrdersForTick amount of orders expected to match in each tick\n    @param _maxBlocksForTick the max amount of blocks to wait until allowing to run the tick\n    @param _minBlocksForTick the min amount of blocks to wait until allowing to run the tick\n    @param _governor Address in charge of determining who is authorized and who is not\n    @param _stopper Address that is authorized to pause the contract\n */\n  function initialize(\n    address _commonBaseTokenAddress,\n    CommissionManager _commissionManager,\n    uint64 _expectedOrdersForTick,\n    uint64 _maxBlocksForTick,\n    uint64 _minBlocksForTick,\n    address _governor,\n    address _stopper\n  ) internal initializer {\n    TokenPairConverter.initialize(_commonBaseTokenAddress, _expectedOrdersForTick, _maxBlocksForTick, _minBlocksForTick, _governor);\n    OrderIdGenerator.initialize(0);\n    commissionManager = _commissionManager;\n    Stoppable.initialize(_stopper, _governor);\n  }\n\n  /*\n    @notice Returns the amount of pending sell orders that are in the orderbook of this pair\n    @param _pair Storage structure that represents the pair\n   */\n  function pendingSellOrdersLength(MoCExchangeLib.Pair storage _pair) internal view returns (uint256) {\n    return _pair.secondaryToken.orderbook.amountOfPendingOrders;\n  }\n\n  /*\n    @notice Returns the amount of pending market orders that are in the orderbook of this pair\n    @param _pair Storage structure that represents the pair\n    @param _isBuy true to get the length of buy pending market orders, false to get the length of sell market orders\n   */\n  function pendingMarketOrdersLength(MoCExchangeLib.Pair storage _pair, bool _isBuy) internal view returns (uint256) {\n    return _isBuy ? _pair.baseToken.orderbook.amountOfPendingMarketOrders : _pair.secondaryToken.orderbook.amountOfPendingMarketOrders;\n  }\n\n  /*\n    @notice Returns the amount of pending buy orders that are in the orderbook of this pair\n    @param _pair Storage structure that represents the pair\n   */\n  function pendingBuyOrdersLength(MoCExchangeLib.Pair storage _pair) internal view returns (uint256) {\n    return _pair.baseToken.orderbook.amountOfPendingOrders;\n  }\n\n  /*\n    @notice Inserts an order in the buy orderbook of a given pair with a hint;\n    the pair should not be disabled; the contract should not be paused. Takes the funds\n    with a transferFrom\n\n    @param _pair Storage structure that represents the pair\n    @param _amount Amount to be locked[base]; should have enough allowance\n    @param _price Maximum price to be paid [base/secondary]\n    @param _lifespan After _lifespan ticks the order will be expired and no longer matched, must be lower or equal than the maximum\n    @param _previousOrderIdHint Order that comes immediately before the new order;\n    NO_HINT is considered as no hint and the smart contract must iterate from the beginning\n    0 is considered to be a hint to put it at the start\n  */\n  function insertBuyLimitOrderAfter(\n    MoCExchangeLib.Pair storage _pair,\n    uint256 _amount,\n    uint256 _price,\n    uint64 _lifespan,\n    uint256 _previousOrderIdHint\n  ) private {\n    uint256 _priceCommonBase = TokenPairConverter.convertTokenToCommonBase(\n      address(_pair.baseToken.token),\n      uint256(10**18),\n      address(_pair.secondaryToken.token)\n    );\n    uint256 initialFee = commissionManager.calculateInitialFee(_amount, _priceCommonBase);\n    require(initialFee <= _amount, \"Amount is greater than Fee\");\n    _pair.doInsertLimitOrder(\n      nextId(),\n      _amount.sub(initialFee),\n      initialFee,\n      _price,\n      _lifespan,\n      _previousOrderIdHint,\n      msg.sender,\n      address(this),\n      true\n    );\n  }\n\n  /*\n    @notice Inserts an order in the sell orderbook of a given pair with a hint;\n    the pair should not be disabled; the contract should not be paused. Takes the funds\n    with a transferFrom\n    @param _pair Storage structure that represents the pair\n    @param _amount Amount to be locked[secondary]; should have enough allowance\n    @param _price Maximum price to be paid [base/secondary]\n    @param _lifespan After _lifespan ticks the order will be expired and no longer matched, must be lower or equal than the maximum\n    @param _previousOrderIdHint Order that comes immediately before the new order;\n    NO_HINT is considered as no hint and the smart contract must iterate from the beginning\n    0 is considered to be a hint to put it at the start\n   */\n  function insertSellLimitOrderAfter(\n    MoCExchangeLib.Pair storage _pair,\n    uint256 _amount,\n    uint256 _price,\n    uint64 _lifespan,\n    uint256 _previousOrderIdHint\n  ) private {\n    uint256 _priceCommonBase = TokenPairConverter.convertTokenToCommonBase(\n      address(_pair.secondaryToken.token),\n      uint256(10**18),\n      address(_pair.baseToken.token)\n    );\n    uint256 initialFee = commissionManager.calculateInitialFee(_amount, _priceCommonBase);\n    require(initialFee <= _amount, \"Amount is greater than Fee\");\n    _pair.doInsertLimitOrder(\n      nextId(),\n      _amount.sub(initialFee),\n      initialFee,\n      _price,\n      _lifespan,\n      _previousOrderIdHint,\n      msg.sender,\n      address(this),\n      false\n    );\n  }\n\n  // Leave a gap betweeen inherited contracts variables in order to be\n  // able to add more variables in them later\n  uint256[50] private upgradeGap;\n}\n\n// File: contracts/RestrictiveOrderListing.sol\n\npragma solidity 0.5.8;\n\n\ncontract RestrictiveOrderListing is OrderListing {\n  uint256 public minOrderAmount;\n  uint256 public minMultiplyFactor;\n  uint256 public maxMultiplyFactor;\n  uint64 public maxOrderLifespan;\n\n  /*\n    @notice Checks if the amount is valid given a maximum in commonBaseToken currency; reverts if not\n    @param _tokenAddress Address of the token the amount is in\n    @param _amount Amount to be checked\n    @param _baseToken Address of the base token in the pair being exchanged\n   */\n  modifier isValidAmount(\n    address _tokenAddress,\n    uint256 _amount,\n    address _baseToken\n  ) {\n    validateAmount(_tokenAddress, _amount, _baseToken);\n    _;\n  }\n\n  /*\n    @notice Checks if the amount is valid given a minimum; reverts if not\n    @param _lifespan Lifespan to be checked\n   */\n  modifier isValidLifespan(uint64 _lifespan) {\n    require(_lifespan <= maxOrderLifespan, \"Lifespan too high\");\n    _;\n  }\n\n  /*\n    @notice Checks if the _pri a minimum; reverts if not\n    @param _price Price to be checked\n   */\n  modifier isValidPrice(uint256 _price) {\n    require(_price != 0, \"Price cannot be zero\");\n    _;\n  }\n\n  /*\n    @notice Checks if the _multiplyFactor is in a given range; reverts if not\n    @param _multiplyFactor MultiplyFactor to be checked\n  */\n  modifier isValidMultiplyFactor(uint256 _multiplyFactor) {\n    validateMultiplyFactor(_multiplyFactor);\n    _;\n  }\n\n  /*\n    @notice Sets the minimum order amount in commonBaseToken currency; only callable through governance\n    @param _minOrderAmount New minimum\n   */\n  function setMinOrderAmount(uint256 _minOrderAmount) external onlyAuthorizedChanger {\n    minOrderAmount = _minOrderAmount;\n  }\n\n  /*\n    @notice Sets the maximum lifespan for an order; only callable through governance\n    @param _maxOrderLifespan New maximum\n   */\n\n  function setMaxOrderLifespan(uint64 _maxOrderLifespan) external onlyAuthorizedChanger {\n    maxOrderLifespan = _maxOrderLifespan;\n  }\n\n  function setMinMultiplyFactor(uint256 _minMultiplyFactor) external onlyAuthorizedChanger {\n    minMultiplyFactor = _minMultiplyFactor;\n  }\n\n  function setMaxMultiplyFactor(uint256 _maxMultiplyFactor) external onlyAuthorizedChanger {\n    maxMultiplyFactor = _maxMultiplyFactor;\n  }\n\n  /*\n    @dev This function must initialize every variable in storage, this is necessary because of the proxy\n    pattern we are using. The initializer modifier disables this function once its called so it prevents\n    that someone else calls it without the deployer noticing. Of course they may block your deploys but that\n    would be an extremely unlucky scenario. onlyAuthorizedChanger cannot be used here since the governor is not set yet\n    @param _commonBaseTokenAddress address of the common base token, necessary to convert amounts to a known scale\n    @param _commissionManager Address of the contract that manages all the fee related things\n    @param _expectedOrdersForTick amount of orders expected to match in each tick\n    @param _maxBlocksForTick the max amount of blocks to wait until allowing to run the tick\n    @param _minBlocksForTick the min amount of blocks to wait until allowing to run the tick\n    @param _minOrderAmount the minimal amount in common base that every order should cover\n    @param _maxOrderLifespan the maximal lifespan in ticks for an order\n    @param _governor Address in charge of determining who is authorized and who is not\n    @param _stopper Address that is authorized to pause the contract\n */\n  function initialize(\n    address _commonBaseTokenAddress,\n    CommissionManager _commissionManager,\n    uint64 _expectedOrdersForTick,\n    uint64 _maxBlocksForTick,\n    uint64 _minBlocksForTick,\n    uint256 _minOrderAmount,\n    uint256 _minMultiplyFactor,\n    uint256 _maxMultiplyFactor,\n    uint64 _maxOrderLifespan,\n    address _governor,\n    address _stopper\n  ) public initializer {\n    OrderListing.initialize(\n      _commonBaseTokenAddress,\n      _commissionManager,\n      _expectedOrdersForTick,\n      _maxBlocksForTick,\n      _minBlocksForTick,\n      _governor,\n      _stopper\n    );\n    minOrderAmount = _minOrderAmount;\n    maxOrderLifespan = _maxOrderLifespan;\n    minMultiplyFactor = _minMultiplyFactor;\n    maxMultiplyFactor = _maxMultiplyFactor;\n  }\n\n  /*\n    @notice Inserts an order in the buy orderbook of a given pair with a hint;\n    the contract should not be paused. Takes the funds with a transferFrom\n    @param _baseToken the base token of the pair\n    @param _secondaryToken the secondary token of the pair\n    @param _amount Amount to be locked[base]; should have enough allowance\n    @param _price Maximum price to be paid [base/secondary]\n    @param _lifespan After _lifespan ticks the order will be expired and no longer matched, must be lower or equal than the maximum\n    @param _previousOrderIdHint Order that comes immediately before the new order;\n    NO_HINT is considered as no hint and the smart contract must iterate from the beginning\n    0 is considered to be a hint to put it at the start\n  */\n  function insertBuyLimitOrderAfter(\n    address _baseToken,\n    address _secondaryToken,\n    uint256 _amount,\n    uint256 _price,\n    uint64 _lifespan,\n    uint256 _previousOrderIdHint\n  ) public isValidAmount(_baseToken, _amount, _baseToken) isValidLifespan(_lifespan) isValidPrice(_price) {\n    OrderListing.insertBuyLimitOrderAfter(_baseToken, _secondaryToken, _amount, _price, _lifespan, _previousOrderIdHint);\n  }\n\n  /*\n    @notice Inserts a market order at start in the buy orderbook of a given pair with a hint;\n    the pair should not be disabled; the contract should not be paused. Takes the funds\n    with a transferFrom\n    @param _baseToken the base token of the pair\n    @param _secondaryToken the secondary token of the pair\n    @param _amount The quantity of tokens sent\n    @param _multiplyFactor Maximum price to be paid [base/secondary]\n    @param _lifespan After _lifespan ticks the order will be expired and no longer matched, must be lower or equal than the maximum\n    @param _isBuy true if it is a buy market order\n    0 is considered as no hint and the smart contract must iterate\n  */\n  function insertMarketOrder(\n    address _baseToken,\n    address _secondaryToken,\n    uint256 _amount,\n    uint256 _multiplyFactor,\n    uint64 _lifespan,\n    bool _isBuy\n  )\n    public\n    isValidLifespan(_lifespan)\n    isValidMultiplyFactor(_multiplyFactor)\n    isValidAmount(_isBuy ? _baseToken : _secondaryToken, _amount, _baseToken)\n  {\n    OrderListing.insertMarketOrder(_baseToken, _secondaryToken, _amount, _multiplyFactor, _lifespan, _isBuy);\n  }\n\n  /*\n    @notice Inserts a market order in the buy orderbook of a given pair with a hint;\n    the pair should not be disabled; the contract should not be paused. Takes the funds\n    with a transferFrom\n    @param _baseToken the base token of the pair\n    @param _secondaryToken the secondary token of the pair\n    @param _amount The quantity of tokens sent\n    @param _multiplyFactor Maximum price to be paid [base/secondary]\n    @param _previousOrderIdHint Order that comes immediately before the new order;\n    NO_HINT is considered as no hint and the smart contract must iterate from the beginning\n    0 is considered to be a hint to put it at the start\n    @param _lifespan After _lifespan ticks the order will be expired and no longer matched, must be lower or equal than the maximum\n    @param _isBuy true if it is a buy market order\n  */\n  function insertMarketOrderAfter(\n    address _baseToken,\n    address _secondaryToken,\n    uint256 _amount,\n    uint256 _multiplyFactor,\n    uint256 _previousOrderIdHint,\n    uint64 _lifespan,\n    bool _isBuy\n  )\n    public\n    isValidLifespan(_lifespan)\n    isValidMultiplyFactor(_multiplyFactor)\n    isValidAmount(_isBuy ? _baseToken : _secondaryToken, _amount, _baseToken)\n  {\n    OrderListing.insertMarketOrderAfter(_baseToken, _secondaryToken, _amount, _multiplyFactor, _previousOrderIdHint, _lifespan, _isBuy);\n  }\n\n  /*\n    @notice Inserts an order in the sell orderbook of a given pair with a hint;\n    the contract should not be paused. Takes the funds with a transferFrom\n    @param _baseToken the base token of the pair\n    @param _secondaryToken the secondary token of the pair\n    @param _amount Amount to be locked[secondary]; should have enough allowance\n    @param _price Maximum price to be paid [base/secondary]\n    @param _lifespan After _lifespan ticks the order will be expired and no longer matched, must be lower or equal than the maximum\n    @param _previousOrderIdHint Order that comes immediately before the new order;\n    NO_HINT is considered as no hint and the smart contract must iterate from the beginning\n    0 is considered to be a hint to put it at the start\n   */\n  function insertSellLimitOrderAfter(\n    address _baseToken,\n    address _secondaryToken,\n    uint256 _amount,\n    uint256 _price,\n    uint64 _lifespan,\n    uint256 _previousOrderIdHint\n  ) public isValidAmount(_secondaryToken, _amount, _baseToken) isValidLifespan(_lifespan) isValidPrice(_price) {\n    OrderListing.insertSellLimitOrderAfter(_baseToken, _secondaryToken, _amount, _price, _lifespan, _previousOrderIdHint);\n  }\n\n  /*\n    @notice Checks if the amount is valid given a maximum in commonBaseToken currency; reverts if not\n    @param _tokenAddress Address of the token the amount is in\n    @param _amount Amount to be checked\n    @param _baseToken Address of the base token in the pair being exchanged\n   */\n  function validateAmount(\n    address _tokenAddress,\n    uint256 _amount,\n    address _baseToken\n  ) internal view {\n    uint256 convertedAmount = convertTokenToCommonBase(_tokenAddress, _amount, _baseToken);\n    require(convertedAmount >= minOrderAmount, \"Amount too low\");\n  }\n\n  /*\n    @notice Checks if the _multiplyFactor is in a given range; reverts if not\n    @param _multiplyFactor MultiplyFactor to be checked\n  */\n  function validateMultiplyFactor(uint256 _multiplyFactor) internal view {\n    require(_multiplyFactor != 0, \"MultiplyFactor is zero\");\n    require(_multiplyFactor >= minMultiplyFactor, \"Low MultiplyFactor\");\n    require(_multiplyFactor <= maxMultiplyFactor, \"High MultiplyFactor\");\n  }\n\n  // Leave a gap betweeen inherited contracts variables in order to be\n  // able to add more variables in them later\n  uint256[50] private upgradeGap;\n}\n\n// File: partial-execution/contracts/PartialExecutionLibrary.sol\n\npragma solidity 0.5.8;\n\n\n/*\n  @dev Brings basic data structures and functions for partial execution.\n  The main data structures are:\n    Task: Represents a function that needs to be executed by steps.\n    TaskGroup: Represents a group that contains several functions that needs to be executed by steps.\n  Tasks and Tasks groups can be executed specifying the amount of steps to run.\n  Since this contract is a library, it must receive the mappings where to store/get the Tasks and TaskGroups.\n  It is a responsability of the user to consistently pass the same mappings.\n*/\nlibrary PartialExecutionLibrary {\n  using SafeMath for uint256;\n  bytes32 constant NULL_TASK = bytes32(0);\n  bytes32 constant NULL_GROUP = bytes32(0);\n\n  enum ExecutionState {\n    Ready,\n    Running,\n    Finished\n  }\n\n  struct TaskGroup {\n    bytes32 id;\n    ExecutionState state;\n    bytes32[] subTasks;\n    function(bytes32) internal onStart;\n    function(bytes32) internal onFinish;\n    bool autoRestart;\n  }\n\n  struct Task {\n    bytes32 id;\n    function(bytes32, bytes32, uint256) internal returns(bool) stepFunction;\n    function(bytes32, bytes32) internal onStart;\n    function(bytes32, bytes32) internal onFinish;\n    uint256 currentStep;\n    ExecutionState state;\n  }\n\n  /*\n     @dev Creates a task group\n     @param _taskGroups mapping where to store the task group\n     @param _tasks mapping where to get the substasks from\n     @param _id Id of the task group\n     @param _subtasksIds Ids of the Tasks to execute when executing the task group\n     @param _onStart Function to execute before running the first task\n     @param _onFinish Function to execute when all tasks of the group are completed\n     @param _autoRestart wether to set everything in the group as ready to run when finishing\n       Next execution of the group will NOT start in the same transation that the current one finishes.\n   */\n  function createTaskGroup(\n    mapping (bytes32 => TaskGroup) storage _taskGroups,\n    mapping (bytes32 => Task) storage _tasks,\n    bytes32 _id,\n    bytes32[] memory _subtasksIds,\n    function(bytes32) _onStart,\n    function(bytes32) _onFinish,\n    bool _autoRestart\n  ) internal {\n    require(_id != NULL_GROUP, \"a group cannot have a null id\");\n    TaskGroup storage group = _taskGroups[_id];\n    require(group.id == NULL_GROUP, \"a group with that id already exists\");\n    group.id = _id;\n    for (uint256 i = 0; i < _subtasksIds.length; ++i){\n      bytes32 taskId = _subtasksIds[i];\n      Task storage task = _tasks[taskId];\n      require(task.id != NULL_TASK, \"one of the specified tasks is invalid\");\n      group.subTasks.push(taskId);\n    }\n    group.onStart = _onStart;\n    group.onFinish = _onFinish;\n    group.state = ExecutionState.Ready;\n    group.autoRestart = _autoRestart;\n  }\n\n  /*\n   @dev Creates a task\n   @param _tasks mapping where to save the task\n   @param _id Id of the task\n   Should return the step count of the execution\n   @param _stepFunction Function to execute at each step.\n     It receives:\n       the GroupId to which the task is associated.\n         It will be NULL_GROUP if the task is executed outside a group.\n       the TaskId which is executing.\n       the step number which is executing.\n     It MUST return false when there is nothing left to do, true otherwise.\n     it MUST gracefully handle being called with an invalid step number.\n   @param _onStart Function to execute before task execution\n     It receives:\n       the GroupId to which the task is associated.\n         It will be NULL_GROUP if the task is executed outside a group.\n       the TaskId which is executing.\n   @param _onFinish Function to execute when all steps are completed\n     It receives:\n       the GroupId to which the task is associated.\n         It will be NULL_GROUP if the task is executed outside a group.\n       the TaskId which is executing.\n */\n  function createTask(\n    mapping (bytes32 => Task) storage _tasks,\n    bytes32 _id,\n    function(bytes32, bytes32, uint256) internal returns(bool) _stepFunction,\n    function(bytes32, bytes32) internal _onStart,\n    function(bytes32, bytes32) internal _onFinish\n  ) internal {\n    require(_id != NULL_TASK, \"a task cannot have a null id\");\n    Task storage task = _tasks[_id];\n    require(task.id == NULL_TASK, \"a task with that id already exists\");\n    task.id = _id;\n    task.onStart = _onStart;\n    task.onFinish = _onFinish;\n    task.state = ExecutionState.Ready;\n    task.stepFunction = _stepFunction;\n    task.currentStep = 0;\n  }\n\n  /*\n     @dev Executes all tasks of the group in order using the step count passed as parameter\n     @param _taskGroups mapping where to get the group\n     @param _tasks mapping where to get the groups' subtasks\n     @param _id the group's id\n     @param _stepCount Step count to execute\n   */\n  function executeGroup(\n    mapping (bytes32 => TaskGroup) storage _taskGroups,\n    mapping (bytes32 => Task) storage _tasks,\n    bytes32 _id,\n    uint256 _stepCount\n  ) internal {\n    TaskGroup storage group = _taskGroups[_id];\n    require(_stepCount > 0, \"it does not make sense to execute a group of tasks with zero steps\");\n    require(group.id != NULL_GROUP, \"the group does not exist\");\n\n    if (group.state == ExecutionState.Ready) {\n      group.onStart(group.id);\n      group.state = ExecutionState.Running;\n    }\n    // skip everything if the group is finished\n    if (group.state == ExecutionState.Running){\n      uint256 leftSteps = _stepCount;\n\n      for (uint256 i = 0; leftSteps > 0 && i < group.subTasks.length; i++) {\n        Task storage task = _tasks[group.subTasks[i]];\n        uint256 consumed = executeTask(task, group.id, leftSteps);\n        leftSteps = leftSteps.sub(consumed);\n      }\n\n      if (lastTaskCompleted(group, _tasks)) {\n        group.state = ExecutionState.Finished;\n        group.onFinish(group.id);\n        if (group.autoRestart) {\n          resetGroup(group, _tasks);\n        }\n      }\n    }\n  }\n\n  /*\n     @dev Creates a task\n     @param _self task to execute\n     @param steps Step count to execute\n     @return The amount of steps consumed in the execution\n   */\n  function executeTask(Task storage _self, uint256 steps) internal returns(uint256){\n    executeTask(_self, NULL_GROUP, steps);\n  }\n\n  /*\n    @dev Set if a Group should be automatically set to Ready state\n    after Finnished State is reached\n    @param _self the task group\n    @param _autoRestart value to set.\n  */\n  function setAutoRestart(TaskGroup storage _self, bool _autoRestart) internal {\n    _self.autoRestart = _autoRestart;\n  }\n\n  /*\n     @dev Returns true if the group is currently un Running state\n     @param _self the task group to execute\n     @return boolean\n   */\n  function isGroupRunning(TaskGroup storage _self) internal view returns(bool) {\n    return _self.state == ExecutionState.Running;\n  }\n\n  /*\n     @dev Returns true if the group is currently in Ready state\n     @param _self the task group to execute\n     @return boolean\n   */\n  function isGroupReady(TaskGroup storage _self) internal view returns(bool) {\n    return _self.state == ExecutionState.Ready;\n  }\n\n  /*\n     @dev Returns true if the task is currently un Running state\n     @param _self task see if it is running\n     @return boolean\n   */\n  function isTaskRunning(Task storage _self) internal view returns(bool) {\n    return _self.state == ExecutionState.Running;\n  }\n\n  /*\n     @dev Creates a task\n     @param _self the task to execute\n     @param groupId Id of the group the task runs in\n     @param steps Step count to execute\n     @return The amount of steps consumed in the execution\n   */\n  function executeTask(Task storage _self, bytes32 groupId, uint256 steps) private returns(uint256){\n    require(steps > 0, \"it does not make sense to execute a task with 0 steps\");\n    // TODO: there are no tests for this.\n    require(_self.id != NULL_TASK, \"it is invalid to execute a null task\");\n    uint256 initialStep = _self.currentStep;\n\n    if (_self.state == ExecutionState.Finished) {\n      // No execution\n      return 0;\n    }\n    if (_self.state == ExecutionState.Ready) {\n      _self.onStart(groupId, _self.id);\n      _self.state = ExecutionState.Running;\n    }\n    if (_self.state == ExecutionState.Running) {\n      uint256 currentStep;\n      bool keepGoing = true;\n      uint256 endStep = _self.currentStep.add(steps);\n\n      for (currentStep = _self.currentStep; keepGoing && currentStep < endStep; currentStep++) {\n        keepGoing = _self.stepFunction(groupId, _self.id, currentStep);\n      }\n      _self.currentStep = currentStep;\n\n      if (!keepGoing) {\n        _self.state = ExecutionState.Finished;\n        _self.onFinish(groupId, _self.id);\n      }\n    }\n\n    return _self.currentStep.sub(initialStep);\n  }\n\n  /*\n     @dev Returns true if the last task of the group was completed\n     @param _self the task group to execute\n     @param _tasks mapping where to get the group's subtasks.\n     @return boolean\n   */\n  function lastTaskCompleted(\n    TaskGroup storage _self,\n    mapping (bytes32 => Task) storage _tasks\n  ) private view returns(bool){\n    Task storage lastTask = _tasks[_self.subTasks[_self.subTasks.length.sub(1)]];\n\n    return lastTask.state == ExecutionState.Finished;\n  }\n\n  /*\n    @dev Set Group in Ready state. Reset all sub-task.\n    @param _self the task group to reset\n    @param _tasks the mapping where to get the tasks from\n  */\n  function resetGroup(\n    TaskGroup storage _self,\n    mapping (bytes32 => Task) storage _tasks\n    ) private {\n    _self.state = ExecutionState.Ready;\n\n    resetTasks(_self, _tasks);\n  }\n\n  /*\n    @dev Reset all tasks in a group. Used at the completion of a task group execution\n    @param _self the task group to reset\n    @param _tasks the mapping where to get the tasks from\n  */\n  function resetTasks(TaskGroup storage _self, mapping (bytes32 => Task) storage _tasks) private {\n    for (uint256 i = 0; i < _self.subTasks.length; i++) {\n      resetTask(_tasks[_self.subTasks[i]]);\n    }\n  }\n\n  /*\n     @dev Put task in Ready to run state and reset currentStep value\n     @param _self the task to reset\n   */\n  function resetTask(Task storage _self) private {\n    _self.state = ExecutionState.Ready;\n    _self.currentStep = 0;\n  }\n}\n\n// File: partial-execution/contracts/PartialExecution.sol\n\npragma solidity 0.5.8;\n\n\n/*\n  @dev wraps the PartialExecutionLibrary to ensure the library is always\n  called on the same data.\n*/\ncontract PartialExecution {\n  // this is copied from PartialExecutionGroup, since values cant be exported\n  mapping (bytes32 => PartialExecutionLibrary.Task) private tasks;\n  mapping (bytes32 => PartialExecutionLibrary.TaskGroup) private groups;\n  /*\n     @dev Creates a task group\n     @param _id Id of the task group\n     @param _subtasksIds Ids of the Tasks to execute when executing the task group\n     @param _onStart Function to execute before running the first task\n     @param _onFinish Function to execute when all tasks of the group are completed\n     @param _autoRestart wether to set everything in the group as ready to run when finishing\n       Next execution of the group will NOT start in the same transation that the current one finishes.\n   */\n  function createTaskGroup(\n    bytes32 _id,\n    bytes32[] memory _subtasksIds,\n    function(bytes32) _onStart,\n    function(bytes32) _onFinish,\n    bool _autoRestart\n  ) internal {\n    PartialExecutionLibrary.createTaskGroup(\n      groups,\n      tasks,\n      _id,\n      _subtasksIds,\n      _onStart,\n      _onFinish,\n      _autoRestart\n    );\n  }\n\n  /*\n   @dev Creates a task\n   @param _id Id of the task\n   Should return the step count of the execution\n   @param _stepFunction Function to execute at each step.\n     It receives:\n       the GroupId to which the task is associated.\n         It will be NULL_GROUP if the task is executed outside a group.\n       the TaskId which is executing.\n       the step number which is executing.\n     It MUST return false when there is nothing left to do, true otherwise.\n     it MUST gracefully handle being called with an invalid step number.\n   @param _onStart Function to execute before task execution\n     It receives:\n       the GroupId to which the task is associated.\n         It will be NULL_GROUP if the task is executed outside a group.\n       the TaskId which is executing.\n   @param _onFinish Function to execute when all steps are completed\n     It receives:\n       the GroupId to which the task is associated.\n         It will be NULL_GROUP if the task is executed outside a group.\n       the TaskId which is executing.\n */\n  function createTask(\n    bytes32 _id,\n    function(bytes32, bytes32, uint256) internal returns(bool) _stepFunction,\n    function(bytes32, bytes32) internal _onStart,\n    function(bytes32, bytes32) internal _onFinish\n  ) internal {\n    PartialExecutionLibrary.createTask(\n      tasks,\n      _id,\n      _stepFunction,\n      _onStart,\n      _onFinish\n    );\n  }\n\n  /*\n     @dev Executes all tasks of the group in order using the step count passed as parameter\n     @param _id the group's id\n     @param _stepCount Step count to execute\n   */\n  function executeGroup(\n    bytes32 _id,\n    uint256 _stepCount\n  ) internal {\n    PartialExecutionLibrary.executeGroup(groups, tasks, _id, _stepCount);\n  }\n\n  /*\n     @dev Creates a task\n     @param _id id of the task to execute\n     @param steps Step count to execute\n     @return The amount of steps consumed in the execution\n   */\n  function executeTask(bytes32 _id, uint256 steps) internal returns(uint256){\n    PartialExecutionLibrary.executeTask(tasks[_id], steps);\n  }\n\n  /*\n    @dev Set if a Group should be automatically set to Ready state\n    after Finished State is reached\n    @param _id the task group id\n    @param _autoRestart value to set.\n  */\n  function setAutoRestart(bytes32 _id, bool _autoRestart) internal {\n    PartialExecutionLibrary.setAutoRestart(groups[_id], _autoRestart);\n  }\n\n\n  /*\n     @dev Returns true if the group is currently un Running state\n     @param _id the task group to execute\n     @return boolean\n   */\n  function isGroupRunning(bytes32 _id) internal view returns(bool) {\n    PartialExecutionLibrary.isGroupRunning(groups[_id]);\n  }\n\n  /*\n     @dev Returns true if the group is currently in Ready state\n     @param _id the task group to execute\n     @return boolean\n   */\n  function isGroupReady(bytes32 _id) internal view returns(bool) {\n    PartialExecutionLibrary.isGroupReady(groups[_id]);\n  }\n\n  /*\n     @dev Returns true if the task is currently un Running state\n     @param _id task to see if it is running\n     @return boolean\n   */\n  function isTaskRunning(bytes32 _id) internal view returns(bool) {\n    PartialExecutionLibrary.isTaskRunning(tasks[_id]);\n  }\n\n  /*\n     @dev Auxiliar function for tasks with no on{Finish,Start} function\n   */\n  function nullHookForTask(bytes32, bytes32) internal {\n\n  }\n\n  /*\n     @dev Auxiliar function for groups with no on{Finish,Start} function\n   */\n  function nullHookForTaskGroup(bytes32) internal {\n\n  }\n  // Leave a gap betweeen inherited contracts variables in order to be\n  // able to add more variables in them later\n  uint256[50] private upgradeGap;\n}\n\n// File: contracts/MoCDecentralizedExchange.sol\n\npragma solidity 0.5.8;\n\n\n\n\n\ncontract EventfulExchange {\n  /*\n@dev Cloned from MoCExchangeLib.sol or the event it is not recognized and emitted from that lib\n*/\n  event NewOrderAddedToPendingQueue(\n    uint256 indexed id,\n    // On the RSK network, having an event with only one parameter\n    // which is indexed breaks the web3 importer, so a dummy\n    // argument is added.\n    uint256 notIndexedArgumentSoTheThingDoesntBreak\n  );\n\n  /*\n@notice notifies the buyer that their order matched\n@dev Cloned from MoCExchangeLib.sol or the event it is not recognized and emitted from that lib\n@param orderId the buyer's order\n@param amountSent the amount of baseToken [using baseTokenDecimals] sent to the seller\n@param commission the amount of baseToken [using baseTokenDecimals] that was charged as commission\n@param change the amount of baseToken [using baseTokenDecimals] sent back to the buyer\n@param received the amount of secondaryToken [using secondaryTokenDecimals] received in exchange\n@param remainingAmount = totalOrderAmount - (amountSent + change), if remainingAmount is 0, the order is filled and removed from the orderbook.\n@param matchPrice the price [using priceComparisonPrecision] at which the order matched\n@param tickNumber the tick's number in witch the order matched\n*/\n  event BuyerMatch(\n    uint256 indexed orderId,\n    uint256 amountSent,\n    uint256 commission,\n    uint256 change,\n    uint256 received,\n    uint256 remainingAmount,\n    uint256 matchPrice,\n    uint64 tickNumber\n  );\n\n  /*\n@notice notifies the seller that their order matched\n@dev Cloned from MoCExchangeLib.sol or the event it is not recognized and emitted from that lib\n@param orderId the seller's order\n@param amountSent the amount of secondaryToken [using secondaryTokenDecimals] sent to the buyer\n@param commission the amount of secondaryToken [using baseTokenDecimals] that was charged as commission\n@param received the total amount the seller recieved == expected + surplus.\n@param surplus the amount of baseToken [using baseTokenDecimals] the seller recieved additional to the expected.\n@param remainingAmount = totalOrderAmount - amountSent, if remainingAmount is 0, the order is filled and removed from the orderbook.\n@param matchPrice the price [using priceComparisonPrecision] at which the order matched\n@param tickNumber the tick's number in witch the order matched\n*/\n  event SellerMatch(\n    uint256 indexed orderId,\n    uint256 amountSent,\n    uint256 commission,\n    uint256 received,\n    uint256 surplus,\n    uint256 remainingAmount,\n    uint256 matchPrice,\n    uint64 tickNumber\n  );\n\n  /*\n@dev Cloned from MoCExchangeLib.sol or the event it is not recognized and emitted from that lib\n@notice emitted when and expired Order has been process and it funds returned\n@param orderId id of the expired order processed\n@param owner the secondary token of the pair\n@param returnedAmount actual token amount returned to the owner\n@param commission applied as penalizacion for the expiration\n@param returnedCommission the commission returned as the expiration does not consume the whole commission\n*/\n  event ExpiredOrderProcessed(\n    uint256 indexed orderId,\n    address indexed owner,\n    uint256 returnedAmount,\n    uint256 commission,\n    uint256 returnedCommission\n  );\n\n  /*\n@dev Cloned from MoCExchangeLib.sol or the event it is not recognized and emitted from that lib\n@notice notifies the start of the tick\n@param baseTokenAddress the base token of the pair\n@param secondaryTokenAddress the secondary token of the pair\n@param number the tick number that just started\n*/\n  event TickStart(address indexed baseTokenAddress, address indexed secondaryTokenAddress, uint64 number);\n\n  /*\n@dev Cloned from TickState.sol or the event it is not recogniced and emited from that lib\n@notice notifies the end of the tick and its result\n@param baseTokenAddress the base token of the pair\n@param secondaryTokenAddress the secondary token of the pair\n@param number the tick number that just finished\n@param nextTickBlock the block number after wich one it can be excecuted the next tick\n@param closingPrice the price [using priceComparisonPrecision] used to match the orders this tick\n*/\n  event TickEnd(\n    address indexed baseTokenAddress,\n    address indexed secondaryTokenAddress,\n    uint64 indexed number,\n    uint256 nextTickBlock,\n    uint256 closingPrice\n  );\n}\n\ncontract MoCDecentralizedExchange is EventfulExchange, RestrictiveOrderListing, PartialExecution {\n  using SafeMath for uint256;\n  using MoCExchangeLib for MoCExchangeLib.Pair;\n\n  /*\n@notice Checks that the tick of the pair is not running, fails otherwise\n@param _baseToken Address of the base token of the pair\n@param _secondaryToken Address of the secondary token of the pair\n*/\n  modifier whenTickIsNotRunning(address _baseToken, address _secondaryToken) {\n    require(!tickIsRunning(_baseToken, _secondaryToken), \"Tick is running\");\n    _;\n  }\n\n  enum TaskTypes {SIMULATION, MATCHING, MOVING_OUT_PENDINGS, length}\n\n  /*\n@notice Start or continue the execution of a tick for the given pair\n@param _baseToken Address of the base token of the pair\n@param _secondaryToken Address of the secondary token of the pair\n@param steps Maximum steps to be done\n*/\n  function matchOrders(\n    address _baseToken,\n    address _secondaryToken,\n    uint256 steps\n  ) external whenNotPaused {\n    executeGroup(getGroupIdForPair(_baseToken, _secondaryToken), steps);\n  }\n\n  /*\n@notice Start or continue the execution of a tick for the given pair with hints\n@param _baseToken Address of the base token of the pair\n@param _secondaryToken Address of the secondary token of the pair\n@param steps Maximum steps to be done\n@param hintIds Array that help internal functions, at the moment only using in\nthe moving of pending orders, pointing succesively to the orders that should be\nthe previous to the one moved\n*/\n  function matchOrdersWithHints(\n    address _baseToken,\n    address _secondaryToken,\n    uint256 steps,\n    uint256[] calldata hintIds\n  ) external whenNotPaused {\n    MoCExchangeLib.TickPaginationMemory storage pageMemory = getTokenPair(_baseToken, _secondaryToken).pageMemory;\n    pageMemory.hintIds = hintIds;\n\n    executeGroup(getGroupIdForPair(_baseToken, _secondaryToken), steps);\n    delete pageMemory.hintIds;\n    delete pageMemory.hintIdsIndex;\n  }\n\n  /*\n    @notice Process expired Orders for the given orderbook, returning funds to the owner while applying commission\n    @dev iterates _steps times over the orderbook starting from _orderId and process any encountered expired order\n    @param _baseToken Base token to identify the orderbook\n    @param _secondaryToken Secondary token to identify the orderbook\n    @param _evaluateBuyOrders true if buy orders have to be processed, false if sell orders have to\n    @param _orderId Order id to start expiring process. If zero, will start from ordebook top.\n    @param _previousOrderIdHint previous order id hint in the orderbook to _orderId, used as on optimization to search for.\n    If zero, will start from ordebook top.\n    @param _steps Number of iterations to look for expired orders to process. Use one, if just looking to process _orderId only\n    @param _orderType Order type to expire\n    */\n  function processExpired(\n    address _baseToken,\n    address _secondaryToken,\n    bool _evaluateBuyOrders,\n    uint256 _orderId,\n    uint256 _previousOrderIdHint,\n    uint256 _steps,\n    MoCExchangeLib.OrderType _orderType\n  ) external whenNotPaused {\n    MoCExchangeLib.Pair storage pair = getTokenPair(_baseToken, _secondaryToken);\n    MoCExchangeLib.processExpired(pair, commissionManager, _evaluateBuyOrders, _orderId, _previousOrderIdHint, _steps, _orderType);\n  }\n\n  /*\n    @notice Process expired Orders for the given orderbook, returning funds to the owner while applying commission\n    @dev iterates _steps times over the orderbook starting from _orderId and process any encountered expired order\n    @param _baseToken Base token to identify the orderbook\n    @param _secondaryToken Secondary token to identify the orderbook\n    @param _evaluateBuyOrders true if buy orders have to be evaluated, false if sell orders have to\n  */\n  function areOrdersToExpire(\n    address _baseToken,\n    address _secondaryToken,\n    bool _evaluateBuyOrders\n  ) external view returns (bool) {\n    MoCExchangeLib.Pair storage pair = getTokenPair(_baseToken, _secondaryToken);\n    return MoCExchangeLib.areOrdersToExpire(pair, _evaluateBuyOrders);\n  }\n\n  /*\n@notice Getter for every value related to a pair\n@param _baseToken Address of the base token of the pair\n@param _secondaryToken Address of the secondary token of the pair\n@return tickNumber - the current tick number\n@return nextTickBlock - the block number after wich one it can be excecuted the next tick\n@return lastTickBlock - the block number in which one the last tick was executed\n@return lastClosingPrice - the last price from a successful matching\n@return emergentPrice: AVG price of the last matched Orders\n@return lastBuyMatchId Id of the last Buy order to match\n@return lastSellMatchId Id of the last Sell order to match\n@return disabled False if orders can be inserted, true otherwise\n*/\n  function getTokenPairStatus(address _baseToken, address _secondaryToken)\n    external\n    view\n    returns (\n      uint256 emergentPrice,\n      uint256 lastBuyMatchId,\n      uint256 lastBuyMatchAmount,\n      uint256 lastSellMatchId,\n      uint64 tickNumber,\n      uint256 nextTickBlock,\n      uint256 lastTickBlock,\n      uint256 lastClosingPrice,\n      bool disabled,\n      uint256 emaPrice,\n      uint256 smoothingFactor,\n      uint256 marketPrice\n    )\n  {\n    (tickNumber, nextTickBlock, lastTickBlock, lastClosingPrice, disabled, emaPrice, smoothingFactor) = getStatus(_baseToken, _secondaryToken);\n    (emergentPrice, lastBuyMatchId, lastBuyMatchAmount, lastSellMatchId) = getEmergentPrice(_baseToken, _secondaryToken);\n    marketPrice = getMarketPrice(_baseToken, _secondaryToken);\n  }\n\n  /*\n    @notice Getter for every value related to a pair\n    @param _baseToken Address of the base token of the pair\n    @param _secondaryToken Address of the secondary token of the pair\n    @return lastClosingPrice - the last price from a successful matching\n  */\n  function getLastClosingPrice(address _baseToken, address _secondaryToken) external view returns (uint256 lastClosingPrice) {\n    (, , , lastClosingPrice, , , ) = getStatus(_baseToken, _secondaryToken);\n  }\n\n  /*\n@notice Cancel a buy order;\ntick must not be running; the contract must not be paused; the caller should be the order owner\n@param _baseToken Address of the base token of the pair\n@param _secondaryToken Address of the secondary token of the pair\n@param _orderId Id of the order to be cancelled\n@param _previousOrderIdHint Order that comes immediately before the newly cancelled order;\n0 is considered as a hint to look from the beggining\n*/\n  function cancelBuyOrder(\n    address _baseToken,\n    address _secondaryToken,\n    uint256 _orderId,\n    uint256 _previousOrderIdHint\n  ) public whenTickIsNotRunning(_baseToken, _secondaryToken) {\n    OrderListing.cancelBuyOrder(_baseToken, _secondaryToken, _orderId, _previousOrderIdHint);\n  }\n\n  /*\n@notice Cancel a sell order;\ntick must not be running; the contract must not be paused; the caller should be the order owner\n@param _baseToken Address of the base token of the pair\n@param _secondaryToken Address of the secondary token of the pair\n@param _orderId Id of the order to be cancelled\n@param _previousOrderIdHint Order that comes immediately before the newly cancelled order;\n0 is considered as a hint to look from the beggining\n*/\n  function cancelSellOrder(\n    address _baseToken,\n    address _secondaryToken,\n    uint256 _orderId,\n    uint256 _previousOrderIdHint\n  ) public whenTickIsNotRunning(_baseToken, _secondaryToken) {\n    OrderListing.cancelSellOrder(_baseToken, _secondaryToken, _orderId, _previousOrderIdHint);\n  }\n\n  /*\n@notice Disable the insertion of orders in a pair; the pair must have been added before\n@param _baseToken Address of the base token of the pair\n@param _secondaryToken Address of the secondary token of the pair\n*/\n  function disableTokenPair(address _baseToken, address _secondaryToken) public whenTickIsNotRunning(_baseToken, _secondaryToken) {\n    TokenPairListing.disableTokenPair(_baseToken, _secondaryToken);\n  }\n\n  /*\n@notice Re-enable the insertion of orders in a pair; the pair must have been added\nand disabled first\n@param _baseToken Address of the base token of the pair\n@param _secondaryToken Address of the secondary token of the pair\n*/\n  function enableTokenPair(address _baseToken, address _secondaryToken) public whenTickIsNotRunning(_baseToken, _secondaryToken) {\n    TokenPairListing.enableTokenPair(_baseToken, _secondaryToken);\n  }\n\n  /*\n@notice Returns true if the pair is running a tick\n@param _baseToken Address of the base token of the pair\n@param _secondaryToken Address of the secondary token of the pair\n*/\n  function tickIsRunning(address _baseToken, address _secondaryToken) public view returns (bool) {\n    return getTickStage(_baseToken, _secondaryToken) != MoCExchangeLib.TickStage.RECEIVING_ORDERS;\n  }\n\n  /*\n@notice Calculates closing price as if the tick closes at this moment\n@return emergentPrice: AVG price of the last matched Orders\n@return lastBuyMatchId Id of the last Buy order to match\n@return lastBuyMatchAmount Amount of the last Buy order to match\n@return lastSellMatchId Id of the last Sell order to match\n*/\n  function getEmergentPrice(address _baseToken, address _secondaryToken)\n    public\n    view\n    returns (\n      uint256 emergentPrice,\n      uint256 lastBuyMatchId,\n      uint256 lastBuyMatchAmount,\n      uint256 lastSellMatchId\n    )\n  {\n    MoCExchangeLib.Pair storage pair = tokenPair(_baseToken, _secondaryToken);\n    if (!pair.isValid()) return (0, 0, 0, 0);\n\n    return pair.getEmergentPrice();\n  }\n\n  /*\n  @notice Get the current market price\n  @param _baseToken Address of the base token of the pair\n  @param _secondaryToken Address of the secondary token of the pair\n  */\n  function getMarketPrice(address _baseToken, address _secondaryToken) public view returns (uint256) {\n    MoCExchangeLib.Pair storage pair = tokenPair(_baseToken, _secondaryToken);\n    return MoCExchangeLib.getMarketPrice(pair);\n  }\n\n  /*\n@notice Returns the tick stage for a given pair\n@param _baseToken Address of the base token of the pair\n@param _secondaryToken Address of the secondary token of the pair\n@return Enum representing the tick stage\n*/\n  function getTickStage(address _baseToken, address _secondaryToken) public view returns (MoCExchangeLib.TickStage stage) {\n    return getTokenPair(_baseToken, _secondaryToken).tickStage;\n  }\n\n  /*\n@notice Adds a token pair to be listed; the base token must be the commonBaseToken or be listed against it\n@dev\nWe add the group tasks here so\nit's necessary to have the addTokenPair functionality here since\nhere is where we add the PartialExecution Tasks and TaskGroup for the\npaginated tick execution. Since tasks receive their TaskId and\nGroupId, we use the same id for the group and the token pair,\nand the functions passed to the pagination library retrieve their\nassociated pair with the groupId.\n\n@param _baseToken Address of the base token of the pair\n@param _secondaryToken Address of the secondary token of the pair\n@param _priceProvider Address of the oracle price provider\n@param _priceComparisonPrecision Precision to be used in the pair price\n@param _initialPrice Price used initially until a new tick with matching orders is run\n*/\n  function addTokenPair(\n    address _baseToken,\n    address _secondaryToken,\n    address _priceProvider,\n    uint256 _priceComparisonPrecision,\n    uint256 _initialPrice\n  ) public {\n    // The TokenPairListing, called by TokenPairConverter, validates the caller is an\n    // authorized changer\n    TokenPairConverter.addTokenPair(_baseToken, _secondaryToken, _priceProvider, _priceComparisonPrecision, _initialPrice);\n    bytes32 groupId = getGroupIdForPair(_baseToken, _secondaryToken);\n    bytes32[] memory taskList = new bytes32[](uint256(TaskTypes.length));\n    taskList[uint256(TaskTypes.SIMULATION)] = getTaskId(groupId, TaskTypes.SIMULATION);\n    taskList[uint256(TaskTypes.MATCHING)] = getTaskId(groupId, TaskTypes.MATCHING);\n    taskList[uint256(TaskTypes.MOVING_OUT_PENDINGS)] = getTaskId(groupId, TaskTypes.MOVING_OUT_PENDINGS);\n    createTask(taskList[uint256(TaskTypes.SIMULATION)], simulationStepFunction, onSimulationStart, onSimulationFinish);\n    createTask(taskList[uint256(TaskTypes.MATCHING)], matchOrdersStepFunction, onMatchOrdersStart, nullHookForTask);\n    createTask(taskList[uint256(TaskTypes.MOVING_OUT_PENDINGS)], movePendingOrdersStepFunction, onMovePendingsStart, nullHookForTask);\n\n    createTaskGroup(groupId, taskList, onTickStart, onTickFinish, true);\n  }\n\n  /*\n@notice Hook called when the simulation of the matching of orders starts; marks as so the tick stage\nInitializes the pageMemory with the first valid orders\nHas one discarded param; kept to have a fixed signature\n@dev The initialization of lastBuyMatch/lastSellMatch without checking if they should match can cause\nsome inconsistency but it is covered by the matchesAmount attribute in the pageMemory\n@param _groupId Id that represent the group of tasks which should be done\nfor the execution of a tick of a given pair\n*/\n  function onSimulationStart(bytes32 _groupId, bytes32) private {\n    MoCExchangeLib.Pair storage pair = getTokenPair(_groupId);\n    assert(pair.tickStage == MoCExchangeLib.TickStage.RECEIVING_ORDERS);\n    MoCExchangeLib.onSimulationStart(pair);\n  }\n\n  /*\n@notice Hook called when the simulation of the matching of orders finish; marks as so the tick stage\nHas one discarded param; kept to have a fixed signature\n@param _groupId Id that represent the group of tasks which should be done\nfor the execution of a tick of a given pair\n*/\n  function simulationStepFunction(\n    bytes32 _groupId,\n    bytes32,\n    uint256\n  ) private returns (bool) {\n    MoCExchangeLib.Pair storage pair = getTokenPair(_groupId);\n    assert(pair.tickStage == MoCExchangeLib.TickStage.RUNNING_SIMULATION);\n\n    bool keepGoing = pair.simulateMatchingStep();\n\n    return keepGoing;\n  }\n\n  /*\n@notice Hook called when the simulation of the matching of orders finish; marks as so the tick stage\nHas one discarded param; kept to have a fixed signature\n@param _groupId Id that represent the group of tasks which should be done\nfor the execution of a tick of a given pair\n*/\n  function onSimulationFinish(bytes32 _groupId, bytes32) private {\n    MoCExchangeLib.Pair storage pair = getTokenPair(_groupId);\n    MoCExchangeLib.onSimulationFinish(pair);\n  }\n\n  /*\n@notice Hook called when the actual matching of orders starts; marks as so the tick stage\nHas one discarded param; kept to have a fixed signature\n@param _groupId Id that represent the group of tasks which should be done\nfor the execution of a tick of a given pair\n*/\n  function onMatchOrdersStart(bytes32 _groupId, bytes32) private {\n    MoCExchangeLib.Pair storage pair = getTokenPair(_groupId);\n    assert(pair.tickStage == MoCExchangeLib.TickStage.RUNNING_SIMULATION);\n    pair.tickStage = MoCExchangeLib.TickStage.RUNNING_MATCHING;\n  }\n\n  /*\n@notice Matches a single pair of orders; partially or completely\nHas two discarded param; kept to have a fixed signature\n@dev This function can be blocked with a block gas limit DoS if there are enough continous\nexpired orders; to overcome this you should call processExpired and the continue with the tick\n@return True if there are still orders to match\n*/\n  function matchOrdersStepFunction(\n    bytes32 _groupId,\n    bytes32,\n    uint256\n  ) private returns (bool) {\n    MoCExchangeLib.Pair storage pair = getTokenPair(_groupId);\n    return MoCExchangeLib.matchOrders(pair, commissionManager);\n  }\n\n  /*\n@notice Hook called when the moving of pending orders starts; marks as so the tick stage\nHas one discarded param; kept to have a fixed signature\n@param _groupId Id that represent the group of tasks which should be done\nfor the execution of a tick of a given pair\n*/\n  function onMovePendingsStart(bytes32 _groupId, bytes32) private {\n    MoCExchangeLib.Pair storage pair = getTokenPair(_groupId);\n    assert(pair.tickStage == MoCExchangeLib.TickStage.RUNNING_MATCHING);\n    pair.tickStage = MoCExchangeLib.TickStage.MOVING_PENDING_ORDERS;\n  }\n\n  /*\n@notice Moves an order from the pending queue to the orderbook\nHas two discarded param; kept to have a fixed signature\n@dev First it tries to move everything in the buy queue and then goes to the selling queue\nNevertheless always checks the buy order, no mather if we finished it already in case there is\na new buy order while we process the sell order.\nIt is important that this is the absolute LAST task of the ticks group\n@param _groupId Id that represent the group of tasks which should be done\nfor the execution of a tick of a given pair\n@return True if there are still pending orders to move; false otherwise\n*/\n  function movePendingOrdersStepFunction(\n    bytes32 _groupId,\n    bytes32,\n    uint256\n  ) private returns (bool shouldKeepGoing) {\n    MoCExchangeLib.Pair storage pair = getTokenPair(_groupId);\n    return MoCExchangeLib.movePendingOrdersStepFunction(pair);\n  }\n\n/*\n@notice Hook that gets triggered when the tick of a given pair starts.\n@dev Emits an event that marks the start of a tick\n@param _groupId Id that represent the group of tasks which should be done\nfor the execution of a tick of a given pair\n*/\n  function onTickStart(bytes32 _groupId) private {\n    MoCExchangeLib.Pair storage pair = getTokenPair(_groupId);\n    assert(pair.tickStage == MoCExchangeLib.TickStage.RECEIVING_ORDERS);\n    pair.tickState.startTick(address(pair.baseToken.token), address(pair.secondaryToken.token));\n  }\n\n  /*\n  @notice Hook that gets triggered when the tick of a given pair finishes.\n  @dev Marks the state of the tick as finished(it is receiving orders again),\n  sets the nextTick configs and cleans the pageMemory\n  @param _groupId Id that represent the group of tasks which should be done\n  for the execution of a tick of a given pair\n  */\n  function onTickFinish(bytes32 _groupId) private {\n    MoCExchangeLib.Pair storage pair = getTokenPair(_groupId);\n    MoCExchangeLib.onTickFinish(pair, tickConfig);\n  }\n\n  /*\n@notice Returns the id used in the partial execution library to identify a task\n@param _groupId Id of the task's group\n@param _taskType Type of task\n@return Task id\n*/\n  function getTaskId(bytes32 _groupId, TaskTypes _taskType) private pure returns (bytes32) {\n    return keccak256(abi.encodePacked(_groupId, _taskType));\n  }\n\n  /*\n@notice Returns the id using in the mappings to identify the group of tasks for the execution\nof a tick of a given pair\n@param _baseToken Address of the base token of the pair\n@param _secondaryToken Address of the secondary token of the pair\n@return Group id\n*/\n  function getGroupIdForPair(address _baseToken, address _secondaryToken) private pure returns (bytes32) {\n    return hashAddresses(_baseToken, _secondaryToken);\n  }\n\n  // Leave a gap betweeen inherited contracts variables in order to be\n  // able to add more variables in them later\n  uint256[50] private upgradeGap;\n}\n",
  "version": "0.5.8+commit.23d335f2",
  "imports": [],
  "settings": {
    "optimizer": {
      "enabled": true,
      "runs": "100"
    },
    "evmVersion": "byzantium"
  },
  "libraries": {
    "MoCExchangeLib": "0x12ede3eebf9e3fd6317cfbcb3ebfc762db954d68"
  },
  "bytecode": "0x608060405234801561001057600080fd5b50615b9f80620000216000396000f3fe608060405234801561001057600080fd5b50600436106103805760003560e060020a9004806379c5827c116101d9578063b6e0833011610109578063df318d1b116100ac578063df318d1b14610e1c578063e24e4fdb14610e52578063e3204b2214610ecb578063e4bbb5a814610ef1578063ec62d9ef14610f29578063f2b24da314610f7a578063f5b5f6cb14610fa8578063fc3a496214610fde578063ff0e4bac1461100c57610380565b8063b6e0833014610cee578063bb4872de14610d14578063bbc92f5014610d1c578063c227b51c14610d39578063c4d66de814610d8f578063c4e82c1a14610db5578063c520bc9214610dd2578063d1a7671414610e1457610380565b806395b6f0d41161017c57806395b6f0d414610b7b5780639c27ee4c14610bcd5780639df64e1e14610bf3578063a268e21214610c21578063a3b8ef0414610c6d578063ae06785414610c8a578063afac413f14610c92578063b232634c14610c9a578063b5febde014610ce657610380565b806379c5827c1461099657806380446d87146109c45780638129fc1c146109fc5780638456cb5914610a0457806389f1b1e314610a0c5780638dfc043914610a3257806391988cb814610aaf5780639221ffa614610aeb57610380565b80633f4ba83a116102b457806351f7a8541161025757806351f7a854146108275780635210570c1461084d57806352826184146108555780635394e8e61461088b5780635a3970b1146108b95780635c975abb146108e757806364ce594c1461090357806368274357146109565780636bf5de4d1461095e57610380565b80633f4ba83a146106e857806341f3844d146106f057806342872a021461071e57806346b62c4a1461074c578063485cc955146107545780634a272132146107825780634e420fd4146107a857806350090c6b146107f957610380565b80631c5129e9116103275780631c5129e91461058757806320aab073146105b557806320ad3f01146105cf578063237d9c8e146105f2578063324773801461061657806333ccf3401461064c578063340f965a1461068257806337db0273146106a85780633991dfe8146106e057610380565b8063030fe436146103855780630a2c1470146103e05780630a58f47a146104345780630c340a241461045a5780630ef51d0d1461047e57806314fced94146104865780631617b922146104b457806316dedc84146104f0575b600080fd5b6103de600480360360e081101561039b57600080fd5b50600160a060020a0381358116916020810135909116906040810135906060810135906080810135906001604060020a0360a0820135169060c001351515611060565b005b6103de600480360360e08110156103f657600080fd5b508035600160a060020a0390811691602081013590911690604081013515159060608101359060808101359060a08101359060c0013560ff166110f9565b6103de6004803603602081101561044a57600080fd5b5035600160a060020a0316611299565b6104626112d9565b60408051600160a060020a039092168252519081900360200190f35b6104626112e8565b6103de6004803603604081101561049c57600080fd5b50600160a060020a03813581169160200135166112f8565b6103de600480360360808110156104ca57600080fd5b50600160a060020a03813581169160208101359091169060408101359060600135611357565b61051e6004803603604081101561050657600080fd5b50600160a060020a03813581169160200135166113ba565b604080519c8d5260208d019b909b528b8b019990995260608b01979097526001604060020a0390951660808a015260a089019390935260c088019190915260e0870152151561010086015261012085015261014084015261016083015251908190036101800190f35b6103de6004803603604081101561059d57600080fd5b50600160a060020a0381358116916020013516611417565b6105bd611470565b60408051918252519081900360200190f35b610462600480360360408110156105e557600080fd5b508035906020013561147c565b6105fa6114b4565b604080516001604060020a039092168252519081900360200190f35b6103de6004803603606081101561062c57600080fd5b50600160a060020a038135811691602081013590911690604001356114c4565b6103de6004803603606081101561066257600080fd5b50600160a060020a0381358116916020810135909116906040013561152c565b6103de6004803603602081101561069857600080fd5b50356001604060020a031661154c565b6103de600480360360608110156106be57600080fd5b50600160a060020a0381358116916020810135821691604090910135166115c4565b6105bd6116a5565b6103de6116ac565b6105bd6004803603604081101561070657600080fd5b50600160a060020a0381358116916020013516611816565b6105bd6004803603604081101561073457600080fd5b50600160a060020a038135811691602001351661182f565b6105bd6118c4565b6103de6004803603604081101561076a57600080fd5b50600160a060020a03813581169160200135166118cb565b6103de6004803603602081101561079857600080fd5b50356001604060020a031661197e565b6103de600480360360c08110156107be57600080fd5b50600160a060020a0381358116916020810135909116906040810135906060810135906001604060020a036080820135169060a001356119e1565b6105bd6004803603604081101561080f57600080fd5b50600160a060020a0381358116916020013516611ab8565b6103de6004803603602081101561083d57600080fd5b5035600160a060020a0316611ad2565b6103de611b88565b6103de6004803603606081101561086b57600080fd5b50600160a060020a03813581169160208101359091169060400135611b9d565b6105bd600480360360408110156108a157600080fd5b50600160a060020a0381358116916020013516611bff565b610462600480360360408110156108cf57600080fd5b50600160a060020a0381358116916020013516611c1a565b6108ef611c3c565b604080519115158252519081900360200190f35b6103de600480360360c081101561091957600080fd5b50600160a060020a0381358116916020810135909116906040810135906060810135906001604060020a036080820135169060a001351515611c4b565b6103de611cd5565b6108ef6004803603606081101561097457600080fd5b50600160a060020a038135811691602081013590911690604001351515611ced565b6108ef600480360360408110156109ac57600080fd5b50600160a060020a0381358116916020013516611d8f565b6105bd600480360360608110156109da57600080fd5b50600160a060020a038135811691602081013590911690604001351515611db0565b6103de611dcd565b6103de611e78565b6103de60048036036020811015610a2257600080fd5b50356001604060020a0316612060565b6103de6004803603610160811015610a4957600080fd5b50600160a060020a03813581169160208101358216916001604060020a0360408301358116926060810135821692608082013583169260a08301359260c08101359260e0820135926101008301351691610120810135821691610140909101351661208c565b6103de60048036036080811015610ac557600080fd5b50600160a060020a03813581169160208101359091169060408101359060600135612179565b6103de60048036036080811015610b0157600080fd5b600160a060020a03823581169260208101359091169160408201359190810190608081016060820135640100000000811115610b3c57600080fd5b820183602082011115610b4e57600080fd5b80359060200191846020830284011164010000000083111715610b7057600080fd5b5090925090506121d4565b610ba960048036036040811015610b9157600080fd5b50600160a060020a03813581169160200135166122a4565b60405180826003811115610bb957fe5b60ff16815260200191505060405180910390f35b610bd56122be565b60408051938452602084019290925282820152519081900360600190f35b6105bd60048036036040811015610c0957600080fd5b50600160a060020a03813581169160200135166122ca565b6103de600480360360a0811015610c3757600080fd5b508035600160a060020a0390811691602081013590911690604081013590606081013590608001356001604060020a03166122e1565b6103de60048036036020811015610c8357600080fd5b50356122f8565b6105bd612306565b6105bd612311565b6103de600480360360a0811015610cb057600080fd5b508035600160a060020a0390811691602081013590911690604081013590606081013590608001356001604060020a0316612318565b6105bd612328565b6103de60048036036020811015610d0457600080fd5b5035600160a060020a031661232f565b6108ef612359565b6103de60048036036020811015610d3257600080fd5b5035612363565b610d6760048036036040811015610d4f57600080fd5b50600160a060020a0381358116916020013516612371565b604080516001604060020a039094168452602084019290925282820152519081900360600190f35b6103de60048036036020811015610da557600080fd5b5035600160a060020a03166123a9565b6103de60048036036020811015610dcb57600080fd5b5035612469565b6103de600480360360a0811015610de857600080fd5b50600160a060020a03813581169160208101358216916040820135169060608101359060800135612477565b6104626125ae565b6105bd60048036036060811015610e3257600080fd5b50600160a060020a038135811691602081013591604090910135166125c4565b610e5a6126a9565b60405180806020018281038252838181518152602001915080516000925b81841015610eba57602080850284010151604080838360005b83811015610ea9578181015183820152602001610e91565b505050509050019260010192610e78565b925050509250505060405180910390f35b6103de60048036036020811015610ee157600080fd5b50356001604060020a0316612730565b6103de60048036036060811015610f0757600080fd5b50600160a060020a038135811691602081013590911690604001351515612793565b6103de600480360360c0811015610f3f57600080fd5b50600160a060020a0381358116916020810135909116906040810135906060810135906001604060020a036080820135169060a0013561287b565b6105bd60048036036040811015610f9057600080fd5b50600160a060020a0381358116916020013516612945565b6103de60048036036060811015610fbe57600080fd5b50600160a060020a03813581169160208101359091169060400135612992565b6105bd60048036036040811015610ff457600080fd5b50600160a060020a0381358116916020013516612a24565b61103a6004803603604081101561102257600080fd5b50600160a060020a0381358116916020013516612a38565b604080519485526020850193909352838301919091526060830152519081900360800190f35b6101d15482906001604060020a0390811690821611156110b8576040805160e560020a62461bcd0281526020600482015260116024820152600080516020615ab9833981519152604482015290519081900360640190fd5b846110c281612b12565b826110cd57876110cf565b885b878a6110dc838383612c1d565b6110eb8c8c8c8c8c8c8c612c87565b505050505050505050505050565b610135546040805180820190915260128152600080516020615a23833981519152602082015290610100900460ff16156111b45760405160e560020a62461bcd0281526004018080602001828103825283818151815260200191508051906020019080838360005b83811015611179578181015183820152602001611161565b50505050905090810190601f1680156111a65780820380516001836020036101000a031916815260200191505b509250505060405180910390fd5b5060006111c18888612eeb565b61019b546040517fd34e59d800000000000000000000000000000000000000000000000000000000815260048101838152600160a060020a03909216602482018190528915156044830152606482018990526084820188905260a482018790529293507312ede3eebf9e3fd6317cfbcb3ebfc762db954d689263d34e59d89285928b918b918b918b918b919060c40182600181111561125c57fe5b60ff16815260200197505050505050505060006040518083038186803b15801561128557600080fd5b505af41580156110eb573d6000803e3d6000fd5b6112a1612f56565b6101358054600160a060020a03909216620100000275ffffffffffffffffffffffffffffffffffffffff000019909216919091179055565b603354600160a060020a031681565b61019b54600160a060020a031681565b81816113048282611d8f565b15611347576040805160e560020a62461bcd02815260206004820152600f60248201526000805160206159de833981519152604482015290519081900360640190fd5b6113518484613069565b50505050565b83836113638282611d8f565b156113a6576040805160e560020a62461bcd02815260206004820152600f60248201526000805160206159de833981519152604482015290519081900360640190fd5b6113b286868686613136565b505050505050565b6000806000806000806000806000806000806113d68e8e6131cb565b959d50939b5091995097509550935091506113f18e8e612a38565b929e50909c509a5098506114058e8e61182f565b90509295989b509295989b509295989b565b81816114238282611d8f565b15611466576040805160e560020a62461bcd02815260206004820152600f60248201526000805160206159de833981519152604482015290519081900360640190fd5b6113518484613200565b670de0b6b3a764000081565b609c828154811061148957fe5b906000526020600020906002020181600281106114a257fe5b0154600160a060020a03169150829050565b6101d1546001604060020a031681565b6114cc612f56565b60006114d88484612eeb565b9050670de0b6b3a76400008211156115245760405160e560020a62461bcd02815260040180806020018281038252602b815260200180615b49602b913960400191505060405180910390fd5b603f01555050565b611534612f56565b60006115408484612eeb565b603e0191909155505050565b611554612f56565b6002816001604060020a031610156115b6576040805160e560020a62461bcd02815260206004820181905260248201527f4578706563746564206f726465727320666f72207469636b20746f6f206c6f77604482015290519081900360640190fd5b6001604060020a0316606655565b6115cc612f56565b6115d683836132c9565b61162a576040805160e560020a62461bcd02815260206004820152601760248201527f546865207061697220646f6573206e6f74206578697374000000000000000000604482015290519081900360640190fd5b600160a060020a0381166116725760405160e560020a62461bcd028152600401808060200182810382526024815260200180615a716024913960400191505060405180910390fd5b600061167e8484612eeb565b601c018054600160a060020a031916600160a060020a039390931692909217909155505050565b609c545b90565b6101355460408051808201909152600b81527f6e6f745f73746f70706572000000000000000000000000000000000000000000602082015290620100009004600160a060020a031633146117445760405160e560020a62461bcd028152602060048201818152835160248401528351909283926044909101919085019080838360008315611179578181015183820152602001611161565b506101355460408051808201909152601281527f636f6e74726163745f69735f6163746976650000000000000000000000000000602082015290610100900460ff166117d45760405160e560020a62461bcd028152602060048201818152835160248401528351909283926044909101919085019080838360008315611179578181015183820152602001611161565b50610135805461ff00191690556040805133815290517f5db9ee0a495bf2e6ff9c91a7834c1ba4fdd244a5e8aa4e537bd38aeae4b073aa9181900360200190a1565b600061182283836132dd565b6003015490505b92915050565b60008061183c84846132dd565b90507312ede3eebf9e3fd6317cfbcb3ebfc762db954d6863323bfe21826040518263ffffffff1660e060020a0281526004018082815260200191505060206040518083038186803b15801561189057600080fd5b505af41580156118a4573d6000803e3d6000fd5b505050506040513d60208110156118ba57600080fd5b5051949350505050565b6101ce5481565b600054610100900460ff16806118e457506118e4613303565b806118f2575060005460ff16155b6119305760405160e560020a62461bcd02815260040180806020018281038252602e815260200180615a43602e913960400191505060405180910390fd5b600054610100900460ff1615801561195b576000805460ff1961ff0019909116610100171660011790555b61196783836001612793565b8015611979576000805461ff00191690555b505050565b611986612f56565b6068546001604060020a03821610156119d35760405160e560020a62461bcd028152600401808060200182810382526029815260200180615b206029913960400191505060405180910390fd5b6001604060020a0316606755565b8484876119ef838383612c1d565b6101d15485906001604060020a039081169082161115611a47576040805160e560020a62461bcd0281526020600482015260116024820152600080516020615ab9833981519152604482015290519081900360640190fd5b8680611a9d576040805160e560020a62461bcd02815260206004820152601460248201527f50726963652063616e6e6f74206265207a65726f000000000000000000000000604482015290519081900360640190fd5b611aab8b8b8b8b8b8b613309565b5050505050505050505050565b6000611ac483836131cb565b509198975050505050505050565b61016880546001019081905561019b54604080517fa82a5759000000000000000000000000000000000000000000000000000000008152600160a060020a0380861660048301529092166024830152517312ede3eebf9e3fd6317cfbcb3ebfc762db954d689163a82a5759916044808301926000929190829003018186803b158015611b5d57600080fd5b505af4158015611b71573d6000803e3d6000fd5b50505050610168548114611b8457600080fd5b5050565b611b90612f56565b610135805460ff19169055565b611ba5612f56565b60008111611be75760405160e560020a62461bcd02815260040180806020018281038252603081526020018061596c6030913960400191505060405180910390fd5b6000611bf38484612eeb565b603c0191909155505050565b6000611c13611c0e84846132dd565b61339e565b9392505050565b600080611c2784846132dd565b601c0154600160a060020a0316949350505050565b61013554610100900460ff1690565b6101d15482906001604060020a039081169082161115611ca3576040805160e560020a62461bcd0281526020600482015260116024820152600080516020615ab9833981519152604482015290519081900360640190fd5b83611cad81612b12565b82611cb85786611cba565b875b8689611cc7838383612c1d565b611aab8b8b8b8b8b8b6133a5565b611cdd612f56565b610135805460ff19166001179055565b600080611cfa8585612eeb565b90507312ede3eebf9e3fd6317cfbcb3ebfc762db954d6863e71df42882856040518363ffffffff1660e060020a02815260040180838152602001821515151581526020019250505060206040518083038186803b158015611d5a57600080fd5b505af4158015611d6e573d6000803e3d6000fd5b505050506040513d6020811015611d8457600080fd5b505195945050505050565b600080611d9c84846122a4565b6003811115611da757fe5b14159392505050565b6000611dc5611dbf85856132dd565b83613435565b949350505050565b600054610100900460ff1680611de65750611de6613303565b80611df4575060005460ff16155b611e325760405160e560020a62461bcd02815260040180806020018281038252602e815260200180615a43602e913960400191505060405180910390fd5b600054610100900460ff16158015611e5d576000805460ff1961ff0019909116610100171660011790555b6001610168558015611e75576000805461ff00191690555b50565b6101355460408051808201909152600b81527f756e73746f707061626c6500000000000000000000000000000000000000000060208201529060ff16611f025760405160e560020a62461bcd028152602060048201818152835160248401528351909283926044909101919085019080838360008315611179578181015183820152602001611161565b506101355460408051808201909152600b81527f6e6f745f73746f70706572000000000000000000000000000000000000000000602082015290620100009004600160a060020a03163314611f9b5760405160e560020a62461bcd028152602060048201818152835160248401528351909283926044909101919085019080838360008315611179578181015183820152602001611161565b50610135546040805180820190915260128152600080516020615a23833981519152602082015290610100900460ff161561201a5760405160e560020a62461bcd028152602060048201818152835160248401528351909283926044909101919085019080838360008315611179578181015183820152602001611161565b50610135805461ff0019166101001790556040805133815290517f62e78cea01bee320cd4e420270b5ea74000d11b0c9f74754ebdbfc544b05a2589181900360200190a1565b612068612f56565b6101d1805467ffffffffffffffff19166001604060020a0392909216919091179055565b600054610100900460ff16806120a557506120a5613303565b806120b3575060005460ff16155b6120f15760405160e560020a62461bcd02815260040180806020018281038252602e815260200180615a43602e913960400191505060405180910390fd5b600054610100900460ff1615801561211c576000805460ff1961ff0019909116610100171660011790555b61212b8c8c8c8c8c888861344f565b6101ce8790556101d1805467ffffffffffffffff19166001604060020a0386161790556101cf8690556101d085905580156110eb576000805461ff0019169055505050505050505050505050565b83836121858282611d8f565b156121c8576040805160e560020a62461bcd02815260206004820152600f60248201526000805160206159de833981519152604482015290519081900360640190fd5b6113b286868686613538565b610135546040805180820190915260128152600080516020615a23833981519152602082015290610100900460ff16156122525760405160e560020a62461bcd028152602060048201818152835160248401528351909283926044909101919085019080838360008315611179578181015183820152602001611161565b50600061225f8686612eeb565b6021810191506122739060230184846157be565b5061228761228187876135cd565b856135d9565b612295600282016000615809565b60006003909101555050505050565b60006122b08383612eeb565b603a015460ff169392505050565b60665460675460685483565b60006122d683836132dd565b601101549392505050565b6122f1858585858560001961287b565b5050505050565b612300612f56565b6101ce55565b663ab9f28a23200081565b6101d05481565b6122f185858585856000196119e1565b6101cf5481565b612337612f56565b60338054600160a060020a031916600160a060020a0392909216919091179055565b6101355460ff1681565b61236b612f56565b6101cf55565b60008060008061238186866132dd565b6020810154601d820154601e909201546001604060020a039091169891975095509350505050565b600054610100900460ff16806123c257506123c2613303565b806123d0575060005460ff16155b61240e5760405160e560020a62461bcd02815260040180806020018281038252602e815260200180615a43602e913960400191505060405180910390fd5b600054610100900460ff16158015612439576000805460ff1961ff0019909116610100171660011790555b60338054600160a060020a031916600160a060020a0384161790558015611b84576000805461ff00191690555050565b612471612f56565b6101d055565b61248485858585856135e9565b600061249086866135cd565b60408051600380825260808201909252919250606091906020820183803883390190505090506124c1826000613677565b816000815181106124ce57fe5b6020026020010181815250506124e5826001613677565b816001815181106124f257fe5b602002602001018181525050612509826002613677565b8160028151811061251657fe5b60209081029190910101526125478160008151811061253157fe5b60200260200101516136e0613796613825613884565b61256d8160018151811061255757fe5b6020026020010151613893613921611b84613884565b6125938160028151811061257d57fe5b60200260200101516139666139c6611b84613884565b6125a58282613a05613a596001613ad5565b50505050505050565b61013554620100009004600160a060020a031681565b60cf54600090600160a060020a03858116911614156125e4575081611c13565b60cf546000906125fd90600160a060020a0316866132dd565b905061260881613ae8565b15612628576126208482603e015483603b0154613b24565b915050611c13565b60cf5461263e90600160a060020a0316846132dd565b905061264981613ae8565b1561269d5760006126638583603e015484603b0154613b24565b905061266f84876132dd565b915061267a82613ae8565b1561269b576126928183603e015484603b0154613b24565b92505050611c13565b505b50600019949350505050565b6060609c805480602002602001604051908101604052809291908181526020016000905b828210156127275760008481526020902060408051808201918290529160028581029091019182845b8154600160a060020a031681526001909101906020018083116126f6575050505050815260200190600101906126cd565b50505050905090565b612738612f56565b6067546001604060020a03821611156127855760405160e560020a62461bcd028152600401808060200182810382526029815260200180615b206029913960400191505060405180910390fd5b6001604060020a0316606855565b600054610100900460ff16806127ac57506127ac613303565b806127ba575060005460ff16155b6127f85760405160e560020a62461bcd02815260040180806020018281038252602e815260200180615a43602e913960400191505060405180910390fd5b600054610100900460ff16158015612823576000805460ff1961ff0019909116610100171660011790555b610135805460ff19168315151775ffffffffffffffffffffffffffffffffffffffff0000191662010000600160a060020a03871602179055612864836123a9565b8015611351576000805461ff001916905550505050565b858487612889838383612c1d565b6101d15485906001604060020a0390811690821611156128e1576040805160e560020a62461bcd0281526020600482015260116024820152600080516020615ab9833981519152604482015290519081900360640190fd5b8680612937576040805160e560020a62461bcd02815260206004820152601460248201527f50726963652063616e6e6f74206265207a65726f000000000000000000000000604482015290519081900360640190fd5b611aab8b8b8b8b8b8b613b46565b604080516c01000000000000000000000000600160a060020a0394851681026020808401919091529390941690930260348401528051602881850301815260489093019052815191012090565b610135546040805180820190915260128152600080516020615a23833981519152602082015290610100900460ff1615612a105760405160e560020a62461bcd028152602060048201818152835160248401528351909283926044909101919085019080838360008315611179578181015183820152602001611161565b50611979612a1e84846135cd565b826135d9565b6000611c13612a3384846132dd565b613bdb565b6000806000806000612a4a87876132dd565b9050612a5581613ae8565b612a6c575060009350839250829150819050612b09565b807312ede3eebf9e3fd6317cfbcb3ebfc762db954d6863f786a14090916040518263ffffffff1660e060020a0281526004018082815260200191505060806040518083038186803b158015612ac057600080fd5b505af4158015612ad4573d6000803e3d6000fd5b505050506040513d6080811015612aea57600080fd5b5080516020820151604083015160609093015191975095509093509150505b92959194509250565b80612b67576040805160e560020a62461bcd02815260206004820152601660248201527f4d756c7469706c79466163746f72206973207a65726f00000000000000000000604482015290519081900360640190fd5b6101cf54811015612bc2576040805160e560020a62461bcd02815260206004820152601260248201527f4c6f77204d756c7469706c79466163746f720000000000000000000000000000604482015290519081900360640190fd5b6101d054811115611e75576040805160e560020a62461bcd02815260206004820152601360248201527f48696768204d756c7469706c79466163746f7200000000000000000000000000604482015290519081900360640190fd5b6000612c2a8484846125c4565b90506101ce54811015611351576040805160e560020a62461bcd02815260206004820152600e60248201527f416d6f756e7420746f6f206c6f77000000000000000000000000000000000000604482015290519081900360640190fd5b610135546040805180820190915260128152600080516020615a23833981519152602082015290610100900460ff1615612d055760405160e560020a62461bcd028152602060048201818152835160248401528351909283926044909101919085019080838360008315611179578181015183820152602001611161565b506000612d128888612eeb565b90506000612d4183612d245788612d26565b895b670de0b6b3a764000085612d3a578b612d3c565b8a5b6125c4565b61019b546040805160e260020a631e2ca63d028152600481018b9052602481018490529051929350600092600160a060020a03909216916378b298f491604480820192602092909190829003018186803b158015612d9e57600080fd5b505afa158015612db2573d6000803e3d6000fd5b505050506040513d6020811015612dc857600080fd5b5051905087811115612e12576040805160e560020a62461bcd02815260206004820152601a602482015260008051602061594c833981519152604482015290519081900360640190fd5b7312ede3eebf9e3fd6317cfbcb3ebfc762db954d6863126fd5b484612e35613be2565b612e458c8663ffffffff613bf116565b6040805160e060020a63ffffffff871602815260048101949094526024840192909252604483015260648201859052608482018b90526001604060020a03891660a483015260c482018a90523360e483015287151561010483015251610124808301926020929190829003018186803b158015612ec157600080fd5b505af4158015612ed5573d6000803e3d6000fd5b505050506040513d60208110156110eb57600080fd5b6000612ef783836132dd565b9050612f0281613ae8565b611829576040805160e560020a62461bcd02815260206004820152601960248201527f546f6b656e207061697220646f6573206e6f7420657869737400000000000000604482015290519081900360640190fd5b603354604080517fd994d6d50000000000000000000000000000000000000000000000000000000081523360048201529051600160a060020a039092169163d994d6d591602480820192602092909190829003018186803b158015612fba57600080fd5b505afa158015612fce573d6000803e3d6000fd5b505050506040513d6020811015612fe457600080fd5b505160408051808201909152601681527f6e6f745f617574686f72697a65645f6368616e67657200000000000000000000602082015290611e755760405160e560020a62461bcd028152602060048201818152835160248401528351909283926044909101919085019080838360008315611179578181015183820152602001611161565b613071612f56565b600061307d8383612eeb565b603d81015490915060ff16156130dd576040805160e560020a62461bcd02815260206004820152601560248201527f5061697220616c72656164792064697361626c65640000000000000000000000604482015290519081900360640190fd5b603d8101805460ff1916600117905560408051600160a060020a0380861682528416602082015281517f71a055a513c927530cb6f44f826ef705d11b6b00e0912135c1f73796663138ed929181900390910190a1505050565b610135546040805180820190915260128152600080516020615a23833981519152602082015290610100900460ff16156131b45760405160e560020a62461bcd028152602060048201818152835160248401528351909283926044909101919085019080838360008315611179578181015183820152602001611161565b506113516131c28585612eeb565b83836001613c06565b60008060008060008060006131e86131e38a8a6132dd565b613e76565b959f949e50929c50909a509850965090945092505050565b613208612f56565b60006132148383612eeb565b603d81015490915060ff16613273576040805160e560020a62461bcd02815260206004820152601460248201527f5061697220616c726561647920656e61626c6564000000000000000000000000604482015290519081900360640190fd5b603d8101805460ff1916905560408051600160a060020a0380861682528416602082015281517f53affae818baf7c49a51b11722048f56b718a0eb3ea1e4e494915a852ead79b0929181900390910190a1505050565b6000611c136132d884846132dd565b613ae8565b6000609b60006132ed8585612945565b8152602001908152602001600020905092915050565b303b1590565b610135546040805180820190915260128152600080516020615a23833981519152602082015290610100900460ff16156133875760405160e560020a62461bcd028152602060048201818152835160248401528351909283926044909101919085019080838360008315611179578181015183820152602001611161565b506113b26133958787612eeb565b85858585613eb6565b6018015490565b610135546040805180820190915260128152600080516020615a23833981519152602082015290610100900460ff16156134235760405160e560020a62461bcd028152602060048201818152835160248401528351909283926044909101919085019080838360008315611179578181015183820152602001611161565b506113b2868686866000198787611060565b600081613446576019830154611c13565b5050600b015490565b600054610100900460ff16806134685750613468613303565b80613476575060005460ff16155b6134b45760405160e560020a62461bcd02815260040180806020018281038252602e815260200180615a43602e913960400191505060405180910390fd5b600054610100900460ff161580156134df576000805460ff1961ff0019909116610100171660011790555b6134ec888787878761409e565b6134f660006141b6565b61019b8054600160a060020a031916600160a060020a03891617905561351c82846118cb565b801561352e576000805461ff00191690555b5050505050505050565b610135546040805180820190915260128152600080516020615a23833981519152602082015290610100900460ff16156135b65760405160e560020a62461bcd028152602060048201818152835160248401528351909283926044909101919085019080838360008315611179578181015183820152602001611161565b506113516135c48585612eeb565b83836000613c06565b6000611c138383612945565b611b8461020561020484846141bc565b60cf54600160a060020a0386811691161480613616575060cf5461361690600160a060020a0316866132c9565b61366a576040805160e560020a62461bcd02815260206004820152600c60248201527f496e76616c696420506169720000000000000000000000000000000000000000604482015290519081900360640190fd5b6122f18585858585614391565b600082826040516020018083815260200182600381111561369457fe5b60ff167f01000000000000000000000000000000000000000000000000000000000000000281526001019250505060405160208183030381529060405280519060200120905092915050565b6000806136ec85614d47565b90506001603a82015460ff16600381111561370357fe5b1461370a57fe5b6000817312ede3eebf9e3fd6317cfbcb3ebfc762db954d68630f0ea5af90916040518263ffffffff1660e060020a0281526004018082815260200191505060206040518083038186803b15801561376057600080fd5b505af4158015613774573d6000803e3d6000fd5b505050506040513d602081101561378a57600080fd5b50519695505050505050565b60006137a183614d47565b90506000603a82015460ff1660038111156137b857fe5b146137bf57fe5b7312ede3eebf9e3fd6317cfbcb3ebfc762db954d6863d50d46a4826040518263ffffffff1660e060020a0281526004018082815260200191505060006040518083038186803b15801561381157600080fd5b505af41580156125a5573d6000803e3d6000fd5b600061383083614d47565b90507312ede3eebf9e3fd6317cfbcb3ebfc762db954d6863582e61a9826040518263ffffffff1660e060020a0281526004018082815260200191505060006040518083038186803b15801561381157600080fd5b61135161020485858585614db7565b60008061389f85614d47565b61019b54604080517fab62503200000000000000000000000000000000000000000000000000000000815260048101849052600160a060020a039092166024830152519192507312ede3eebf9e3fd6317cfbcb3ebfc762db954d689163ab62503291604480820192602092909190829003018186803b158015611d5a57600080fd5b600061392c83614d47565b90506001603a82015460ff16600381111561394357fe5b1461394a57fe5b603a810180546002919060ff19166001835b0217905550505050565b60008061397285614d47565b90507312ede3eebf9e3fd6317cfbcb3ebfc762db954d6863a433a92a826040518263ffffffff1660e060020a0281526004018082815260200191505060206040518083038186803b158015611d5a57600080fd5b60006139d183614d47565b90506002603a82015460ff1660038111156139e857fe5b146139ef57fe5b603a810180546003919060ff191660018361395c565b6000613a1082614d47565b90506000603a82015460ff166003811115613a2757fe5b14613a2e57fe5b600d810154601b820154611b8491601d840191600160a060020a03918216911663ffffffff614ee816565b6000613a6482614d47565b90507312ede3eebf9e3fd6317cfbcb3ebfc762db954d6863ef6d501c8260666040518363ffffffff1660e060020a028152600401808381526020018281526020019250505060006040518083038186803b158015613ac157600080fd5b505af41580156113b2573d6000803e3d6000fd5b6122f16102056102048787878787614f9d565b600d810154600090600160a060020a031615801590613b135750601b820154600160a060020a031615155b8015611829575050603b0154151590565b6000611dc582613b3a868663ffffffff61516116565b9063ffffffff61518816565b610135546040805180820190915260128152600080516020615a23833981519152602082015290610100900460ff1615613bc45760405160e560020a62461bcd028152602060048201818152835160248401528351909283926044909101919085019080838360008315611179578181015183820152602001611161565b506113b2613bd28787612eeb565b858585856151aa565b600a015490565b61010280546001019081905590565b600082821115613c0057600080fd5b50900390565b600081613c165784600e01613c18565b845b604080517fcf1ba0660000000000000000000000000000000000000000000000000000000081526004810188905260248101879052604481018690528415156064820152815192935060009283927312ede3eebf9e3fd6317cfbcb3ebfc762db954d689263cf1ba0669260848083019392829003018186803b158015613c9d57600080fd5b505af4158015613cb1573d6000803e3d6000fd5b505050506040513d6040811015613cc757600080fd5b50805160209091015161019b54600d860154604080517f332d3ca5000000000000000000000000000000000000000000000000000000008152600160a060020a0393841660048201529190921660248201526044810184905260648101839052336084820152600060a482018190529151939550919350918291829182917312ede3eebf9e3fd6317cfbcb3ebfc762db954d689163332d3ca59160c480820192608092909190829003018186803b158015613d8157600080fd5b505af4158015613d95573d6000803e3d6000fd5b505050506040513d6080811015613dab57600080fd5b508051602082015160408301516060909301519196509450909250905083613e1d576040805160e560020a62461bcd02815260206004820152601560248201527f546f6b656e207472616e73666572206661696c65640000000000000000000000604482015290519081900360640190fd5b60408051848152602081018490528082018390528915156060820152905133918c917fd975b60b6329c797ae584f3af10b37331736bff9e1e5c69342394824d8c19b819181900360800190a35050505050505050505050565b6020810154601d820154601e830154603c840154603d850154603e860154603f909601546001604060020a039095169693959294919360ff909116929190565b601b850154600d860154600091613ee391600160a060020a0391821691670de0b6b3a764000091166125c4565b61019b546040805160e260020a631e2ca63d02815260048101899052602481018490529051929350600092600160a060020a03909216916378b298f491604480820192602092909190829003018186803b158015613f4057600080fd5b505afa158015613f54573d6000803e3d6000fd5b505050506040513d6020811015613f6a57600080fd5b5051905085811115613fb4576040805160e560020a62461bcd02815260206004820152601a602482015260008051602061594c833981519152604482015290519081900360640190fd5b7312ede3eebf9e3fd6317cfbcb3ebfc762db954d6863e9322fe188613fd7613be2565b613fe78a8663ffffffff613bf116565b6040805160e060020a63ffffffff871602815260048101949094526024840192909252604483015260648201859052608482018990526001604060020a03881660a483015260c482018790523360e483015230610104830152600061012483015251610144808301926020929190829003018186803b15801561406957600080fd5b505af415801561407d573d6000803e3d6000fd5b505050506040513d602081101561409357600080fd5b505050505050505050565b600054610100900460ff16806140b757506140b7613303565b806140c5575060005460ff16155b6141035760405160e560020a62461bcd02815260040180806020018281038252602e815260200180615a43602e913960400191505060405180910390fd5b600054610100900460ff1615801561412e576000805460ff1961ff0019909116610100171660011790555b600160a060020a0386166141765760405160e560020a62461bcd028152600401808060200182810382526024815260200180615a956024913960400191505060405180910390fd5b60cf8054600160a060020a031916600160a060020a03881617905561419d8585858561535d565b80156113b2576000805461ff0019169055505050505050565b61010255565b6000828152602085905260409020816142095760405160e560020a62461bcd02815260040180806020018281038252604281526020018061599c6042913960600191505060405180910390fd5b805461425f576040805160e560020a62461bcd02815260206004820152601860248201527f7468652067726f757020646f6573206e6f742065786973740000000000000000604482015290519081900360640190fd5b6000600182015460ff16600281111561427457fe5b141561429f578054600382015461428e919063ffffffff16565b6001818101805460ff191690911790555b60018082015460ff1660028111156142b357fe5b14156122f1578160005b6000821180156142d05750600283015481105b156143335760008660008560020184815481106142e957fe5b9060005260206000200154815260200190815260200160002090506000614315828660000154866154ff565b9050614327848263ffffffff613bf116565b935050506001016142bd565b5061433e82866156c9565b156113b25760018201805460ff1916600217905581546003830154614373919063ffffffff6801000000000000000090910416565b6003820154608060020a900460ff16156113b2576113b28286615736565b614399612f56565b84846143a582826132c9565b156143fa576040805160e560020a62461bcd02815260206004820152600d60248201527f4578697374656e74207061697200000000000000000000000000000000000000604482015290519081900360640190fd5b61440481836132c9565b15614459576040805160e560020a62461bcd02815260206004820152601560248201527f4578697374656e7420696e766572736520706169720000000000000000000000604482015290519081900360640190fd5b80600160a060020a031682600160a060020a031614156144c3576040805160e560020a62461bcd02815260206004820152601760248201527f4261736520657175616c20746f207365636f6e64617279000000000000000000604482015290519081900360640190fd5b6000831161451b576040805160e560020a62461bcd02815260206004820152601460248201527f696e697469616c5072696365206e6f207a65726f000000000000000000000000604482015290519081900360640190fd5b60006145278888612945565b60408051808201909152600160a060020a03808b16825289166020820152609c8054600181018083556000929092529293509161458b9160029182027faf85b9071dfafeac1409d3f1d19bafc9bc7c37974cde8df0ee6168f0086e539c0191615827565b5050604051806101600160405280604051806040016040528060405180610180016040528060008152602001600081526020016000815260200160008152602001600081526020016000815260200160008152602001600081526020016000815260200160008152602001600081526020016001151581525081526020018b600160a060020a03168152508152602001604051806040016040528060405180610180016040528060008152602001600081526020016000815260200160008152602001600081526020016000815260200160008152602001600081526020016000815260200160008152602001600081526020016000151581525081526020018a600160a060020a0316815250815260200187600160a060020a0316815260200160405180608001604052806146c64360666002015461574c565b8152602001600081526020016000815260200160016001604060020a0316815250815260200160405180610160016040528060008152602001600081526020016000604051908082528060200260200182016040528015614731578160200160208202803883390190505b508152602001600081526020016040518061012001604052806000600181111561475757fe5b81526020016000815260200160008152602001600081526020016000815260200160008152602001600081526020016000600160a060020a0316815260200160006001604060020a03168152508152602001604051806101200160405280600060018111156147c257fe5b81526020016000815260200160008152602001600081526020016000815260200160008152602001600081526020016000600160a060020a0316815260200160006001604060020a0316815250815260200160008152602001600081526020016000815260200160008152602001600081525081526020016000600381111561484757fe5b8152602001868152602001858152602001600015158152602001858152602001663ab9f28a232000815250609b6000838152602001908152602001600020600082015181600001600082015181600001600082015181600101556020820151816002015560408201518160030155606082015181600401556080820151816005015560a0820151816006015560c0820151816007015560e08201518160080155610100820151816009015561012082015181600a015561014082015181600b015561016082015181600c0160006101000a81548160ff0219169083151502179055505050602082015181600d0160006101000a815481600160a060020a030219169083600160a060020a031602179055505050602082015181600e01600082015181600001600082015181600101556020820151816002015560408201518160030155606082015181600401556080820151816005015560a0820151816006015560c0820151816007015560e08201518160080155610100820151816009015561012082015181600a015561014082015181600b015561016082015181600c0160006101000a81548160ff0219169083151502179055505050602082015181600d0160006101000a815481600160a060020a030219169083600160a060020a031602179055505050604082015181601c0160006101000a815481600160a060020a030219169083600160a060020a03160217905550606082015181601d0160008201518160000155602082015181600101556040820151816002015560608201518160030160006101000a8154816001604060020a0302191690836001604060020a03160217905550505060808201518160210160008201518160000155602082015181600101556040820151816002019080519060200190614aeb92919061587b565b506060820151600382015560808201518051600483018054909190829060ff191660018381811115614b1957fe5b0217905550602082015160018083019190915560408301516002830155606083015160038301556080830151600483015560a080840151600584015560c0840151600684015560e084015160079093018054610100909501516001604060020a031674010000000000000000000000000000000000000000027bffffffffffffffff000000000000000000000000000000000000000019600160a060020a03909516600160a060020a0319909616959095179390931693909317909155908301518051600c8401805492939092839160ff19909116908381811115614bfa57fe5b02179055506020820151816001015560408201518160020155606082015181600301556080820151816004015560a0820151816005015560c0820151816006015560e08201518160070160006101000a815481600160a060020a030219169083600160a060020a031602179055506101008201518160070160146101000a8154816001604060020a0302191690836001604060020a03160217905550505060c0820151816014015560e08201518160150155610100820151816016015561012082015181601701556101408201518160180155505060a082015181603a0160006101000a81548160ff02191690836003811115614cf357fe5b021790555060c0820151603b82015560e0820151603c820155610100820151603d8201805460ff1916911515919091179055610120820151603e82015561014090910151603f909101555050505050505050565b6000818152609b60205260409020614d5e81613ae8565b614db2576040805160e560020a62461bcd02815260206004820152601960248201527f546f6b656e207061697220646f6573206e6f7420657869737400000000000000604482015290519081900360640190fd5b919050565b83614e0c576040805160e560020a62461bcd02815260206004820152601c60248201527f61207461736b2063616e6e6f7420686176652061206e756c6c20696400000000604482015290519081900360640190fd5b6000848152602086905260409020805415614e5b5760405160e560020a62461bcd02815260040180806020018281038252602281526020018061592a6022913960400191505060405180910390fd5b93845560018401805460038601805460ff191690556001604060020a03928316608060020a0277ffffffffffffffff000000000000000000000000000000001994841668010000000000000000026fffffffffffffffff00000000000000001990921691909117939093169290921767ffffffffffffffff19169216919091179055600060029091015550565b8254431015614f41576040805160e560020a62461bcd02815260206004820152601560248201527f4e657874207469636b206e6f7420726561636865640000000000000000000000604482015290519081900360640190fd5b4360028401556003830154604080516001604060020a03909216825251600160a060020a0380841692908516917fa87d06f354e4eb6a0b84a1931ddf2227694fff0707633220127d3e307bd5341c9181900360200190a3505050565b84614ff2576040805160e560020a62461bcd02815260206004820152601d60248201527f612067726f75702063616e6e6f7420686176652061206e756c6c206964000000604482015290519081900360640190fd5b60008581526020889052604090208054156150415760405160e560020a62461bcd028152600401808060200182810382526023815260200180615ad96023913960400191505060405180910390fd5b85815560005b85518110156150df57600086828151811061505e57fe5b6020908102919091018101516000818152918b905260409091208054919250906150bc5760405160e560020a62461bcd0281526004018080602001828103825260258152602001806159fe6025913960400191505060405180910390fd5b506002830180546001818101835560009283526020909220019190915501615047565b506003810180546001909201805460ff19169055911515608060020a026001604060020a0393841668010000000000000000026fffffffffffffffff0000000000000000199590941667ffffffffffffffff1990921691909117939093169190911770ff00000000000000000000000000000000191691909117905550505050565b60008261517057506000611829565b8282028284828161517d57fe5b0414611c1357600080fd5b600080821161519657600080fd5b60008284816151a157fe5b04949350505050565b600d850154601b8601546000916151d791600160a060020a0391821691670de0b6b3a764000091166125c4565b61019b546040805160e260020a631e2ca63d02815260048101899052602481018490529051929350600092600160a060020a03909216916378b298f491604480820192602092909190829003018186803b15801561523457600080fd5b505afa158015615248573d6000803e3d6000fd5b505050506040513d602081101561525e57600080fd5b50519050858111156152a8576040805160e560020a62461bcd02815260206004820152601a602482015260008051602061594c833981519152604482015290519081900360640190fd5b7312ede3eebf9e3fd6317cfbcb3ebfc762db954d6863e9322fe1886152cb613be2565b6152db8a8663ffffffff613bf116565b6040805160e060020a63ffffffff871602815260048101949094526024840192909252604483015260648201859052608482018990526001604060020a03881660a483015260c482018790523360e483015230610104830152600161012483015251610144808301926020929190829003018186803b15801561406957600080fd5b600054610100900460ff16806153765750615376613303565b80615384575060005460ff16155b6153c25760405160e560020a62461bcd02815260040180806020018281038252602e815260200180615a43602e913960400191505060405180910390fd5b600054610100900460ff161580156153ed576000805460ff1961ff0019909116610100171660011790555b6002856001604060020a0316101561544f576040805160e560020a62461bcd02815260206004820181905260248201527f4578706563746564206f726465727320666f72207469636b20746f6f206c6f77604482015290519081900360640190fd5b826001604060020a0316846001604060020a031610156154a35760405160e560020a62461bcd028152600401808060200182810382526029815260200180615b206029913960400191505060405180910390fd5b604080516060810182526001604060020a0380881680835287821660208401819052918716929093018290526066929092556067919091556068556154e7826123a9565b80156122f1576000805461ff00191690555050505050565b60008082116155425760405160e560020a62461bcd0281526004018080602001828103825260358152602001806158f56035913960400191505060405180910390fd5b83546155825760405160e560020a62461bcd028152600401808060200182810382526024815260200180615afc6024913960400191505060405180910390fd5b60028085015490600386015460ff16600281111561559c57fe5b14156155ac576000915050611c13565b6000600386015460ff1660028111156155c157fe5b14156155f857845460018601546155e891869168010000000000000000900463ffffffff16565b60038501805460ff191660011790555b6001600386015460ff16600281111561560d57fe5b14156156ab5760028501546000906001908290615630908763ffffffff61574c16565b9050876002015492505b81801561564657508083105b1561566f5787546001890154615662918991869063ffffffff16565b600190930192915061563a565b60028801839055816156a75760038801805460ff19166002179055875460018901546156a791899163ffffffff608060020a90910416565b5050505b60028501546156c0908263ffffffff613bf116565b95945050505050565b6002820180546000918291849183916156e990600163ffffffff613bf116565b815481106156f357fe5b90600052602060002001548152602001908152602001600020905060028081111561571a57fe5b600382015460ff16600281111561572d57fe5b14949350505050565b60018201805460ff19169055611b84828261575e565b600082820183811015611c1357600080fd5b60005b6002830154811015611979576157a082600085600201848154811061578257fe5b906000526020600020015481526020019081526020016000206157a8565b600101615761565b60038101805460ff191690556000600290910155565b8280548282559060005260206000209081019282156157f9579160200282015b828111156157f95782358255916020019190600101906157de565b506158059291506158b6565b5090565b5080546000825590600052602060002090810190611e7591906158b6565b826002810192821561586f579160200282015b8281111561586f5782518254600160a060020a031916600160a060020a0390911617825560209092019160019091019061583a565b506158059291506158d0565b8280548282559060005260206000209081019282156157f9579160200282015b828111156157f957825182559160200191906001019061589b565b6116a991905b8082111561580557600081556001016158bc565b6116a991905b80821115615805578054600160a060020a03191681556001016158d656fe697420646f6573206e6f74206d616b652073656e736520746f20657865637574652061207461736b2077697468203020737465707361207461736b2077697468207468617420696420616c726561647920657869737473416d6f756e742069732067726561746572207468616e2046656500000000000054686520676976656e20696e697469616c2070726963652073686f756c642062652067726561746572207468616e2030697420646f6573206e6f74206d616b652073656e736520746f206578656375746520612067726f7570206f66207461736b732077697468207a65726f2073746570735469636b2069732072756e6e696e6700000000000000000000000000000000006f6e65206f662074686520737065636966696564207461736b7320697320696e76616c6964636f6e74726163745f69735f7061757365640000000000000000000000000000436f6e747261637420696e7374616e63652068617320616c7265616479206265656e20696e697469616c697a656450726963652070726f766964657220616464726573732063616e206e6f74206265203078636f6d6d6f42617365546f6b656e416464726573732063616e6e6f74206265206e756c6c4c6966657370616e20746f6f2068696768000000000000000000000000000000612067726f75702077697468207468617420696420616c726561647920657869737473697420697320696e76616c696420746f20657865637574652061206e756c6c207461736b6d696e20426c6f636b466f725469636b2073686f756c64206265206c6f776572207468616e206d6178536d6f6f7468696e6720666163746f722073686f756c6420626520696e2072656c6174696f6e20746f2031a165627a7a72305820081ab525bc7edc12c5f45fbecff8a52365b00b2bc2a9ce3fb7bb381a06bd89850029",
  "deployedBytecode": "0x608060405234801561001057600080fd5b50600436106103805760003560e060020a9004806379c5827c116101d9578063b6e0833011610109578063df318d1b116100ac578063df318d1b14610e1c578063e24e4fdb14610e52578063e3204b2214610ecb578063e4bbb5a814610ef1578063ec62d9ef14610f29578063f2b24da314610f7a578063f5b5f6cb14610fa8578063fc3a496214610fde578063ff0e4bac1461100c57610380565b8063b6e0833014610cee578063bb4872de14610d14578063bbc92f5014610d1c578063c227b51c14610d39578063c4d66de814610d8f578063c4e82c1a14610db5578063c520bc9214610dd2578063d1a7671414610e1457610380565b806395b6f0d41161017c57806395b6f0d414610b7b5780639c27ee4c14610bcd5780639df64e1e14610bf3578063a268e21214610c21578063a3b8ef0414610c6d578063ae06785414610c8a578063afac413f14610c92578063b232634c14610c9a578063b5febde014610ce657610380565b806379c5827c1461099657806380446d87146109c45780638129fc1c146109fc5780638456cb5914610a0457806389f1b1e314610a0c5780638dfc043914610a3257806391988cb814610aaf5780639221ffa614610aeb57610380565b80633f4ba83a116102b457806351f7a8541161025757806351f7a854146108275780635210570c1461084d57806352826184146108555780635394e8e61461088b5780635a3970b1146108b95780635c975abb146108e757806364ce594c1461090357806368274357146109565780636bf5de4d1461095e57610380565b80633f4ba83a146106e857806341f3844d146106f057806342872a021461071e57806346b62c4a1461074c578063485cc955146107545780634a272132146107825780634e420fd4146107a857806350090c6b146107f957610380565b80631c5129e9116103275780631c5129e91461058757806320aab073146105b557806320ad3f01146105cf578063237d9c8e146105f2578063324773801461061657806333ccf3401461064c578063340f965a1461068257806337db0273146106a85780633991dfe8146106e057610380565b8063030fe436146103855780630a2c1470146103e05780630a58f47a146104345780630c340a241461045a5780630ef51d0d1461047e57806314fced94146104865780631617b922146104b457806316dedc84146104f0575b600080fd5b6103de600480360360e081101561039b57600080fd5b50600160a060020a0381358116916020810135909116906040810135906060810135906080810135906001604060020a0360a0820135169060c001351515611060565b005b6103de600480360360e08110156103f657600080fd5b508035600160a060020a0390811691602081013590911690604081013515159060608101359060808101359060a08101359060c0013560ff166110f9565b6103de6004803603602081101561044a57600080fd5b5035600160a060020a0316611299565b6104626112d9565b60408051600160a060020a039092168252519081900360200190f35b6104626112e8565b6103de6004803603604081101561049c57600080fd5b50600160a060020a03813581169160200135166112f8565b6103de600480360360808110156104ca57600080fd5b50600160a060020a03813581169160208101359091169060408101359060600135611357565b61051e6004803603604081101561050657600080fd5b50600160a060020a03813581169160200135166113ba565b604080519c8d5260208d019b909b528b8b019990995260608b01979097526001604060020a0390951660808a015260a089019390935260c088019190915260e0870152151561010086015261012085015261014084015261016083015251908190036101800190f35b6103de6004803603604081101561059d57600080fd5b50600160a060020a0381358116916020013516611417565b6105bd611470565b60408051918252519081900360200190f35b610462600480360360408110156105e557600080fd5b508035906020013561147c565b6105fa6114b4565b604080516001604060020a039092168252519081900360200190f35b6103de6004803603606081101561062c57600080fd5b50600160a060020a038135811691602081013590911690604001356114c4565b6103de6004803603606081101561066257600080fd5b50600160a060020a0381358116916020810135909116906040013561152c565b6103de6004803603602081101561069857600080fd5b50356001604060020a031661154c565b6103de600480360360608110156106be57600080fd5b50600160a060020a0381358116916020810135821691604090910135166115c4565b6105bd6116a5565b6103de6116ac565b6105bd6004803603604081101561070657600080fd5b50600160a060020a0381358116916020013516611816565b6105bd6004803603604081101561073457600080fd5b50600160a060020a038135811691602001351661182f565b6105bd6118c4565b6103de6004803603604081101561076a57600080fd5b50600160a060020a03813581169160200135166118cb565b6103de6004803603602081101561079857600080fd5b50356001604060020a031661197e565b6103de600480360360c08110156107be57600080fd5b50600160a060020a0381358116916020810135909116906040810135906060810135906001604060020a036080820135169060a001356119e1565b6105bd6004803603604081101561080f57600080fd5b50600160a060020a0381358116916020013516611ab8565b6103de6004803603602081101561083d57600080fd5b5035600160a060020a0316611ad2565b6103de611b88565b6103de6004803603606081101561086b57600080fd5b50600160a060020a03813581169160208101359091169060400135611b9d565b6105bd600480360360408110156108a157600080fd5b50600160a060020a0381358116916020013516611bff565b610462600480360360408110156108cf57600080fd5b50600160a060020a0381358116916020013516611c1a565b6108ef611c3c565b604080519115158252519081900360200190f35b6103de600480360360c081101561091957600080fd5b50600160a060020a0381358116916020810135909116906040810135906060810135906001604060020a036080820135169060a001351515611c4b565b6103de611cd5565b6108ef6004803603606081101561097457600080fd5b50600160a060020a038135811691602081013590911690604001351515611ced565b6108ef600480360360408110156109ac57600080fd5b50600160a060020a0381358116916020013516611d8f565b6105bd600480360360608110156109da57600080fd5b50600160a060020a038135811691602081013590911690604001351515611db0565b6103de611dcd565b6103de611e78565b6103de60048036036020811015610a2257600080fd5b50356001604060020a0316612060565b6103de6004803603610160811015610a4957600080fd5b50600160a060020a03813581169160208101358216916001604060020a0360408301358116926060810135821692608082013583169260a08301359260c08101359260e0820135926101008301351691610120810135821691610140909101351661208c565b6103de60048036036080811015610ac557600080fd5b50600160a060020a03813581169160208101359091169060408101359060600135612179565b6103de60048036036080811015610b0157600080fd5b600160a060020a03823581169260208101359091169160408201359190810190608081016060820135640100000000811115610b3c57600080fd5b820183602082011115610b4e57600080fd5b80359060200191846020830284011164010000000083111715610b7057600080fd5b5090925090506121d4565b610ba960048036036040811015610b9157600080fd5b50600160a060020a03813581169160200135166122a4565b60405180826003811115610bb957fe5b60ff16815260200191505060405180910390f35b610bd56122be565b60408051938452602084019290925282820152519081900360600190f35b6105bd60048036036040811015610c0957600080fd5b50600160a060020a03813581169160200135166122ca565b6103de600480360360a0811015610c3757600080fd5b508035600160a060020a0390811691602081013590911690604081013590606081013590608001356001604060020a03166122e1565b6103de60048036036020811015610c8357600080fd5b50356122f8565b6105bd612306565b6105bd612311565b6103de600480360360a0811015610cb057600080fd5b508035600160a060020a0390811691602081013590911690604081013590606081013590608001356001604060020a0316612318565b6105bd612328565b6103de60048036036020811015610d0457600080fd5b5035600160a060020a031661232f565b6108ef612359565b6103de60048036036020811015610d3257600080fd5b5035612363565b610d6760048036036040811015610d4f57600080fd5b50600160a060020a0381358116916020013516612371565b604080516001604060020a039094168452602084019290925282820152519081900360600190f35b6103de60048036036020811015610da557600080fd5b5035600160a060020a03166123a9565b6103de60048036036020811015610dcb57600080fd5b5035612469565b6103de600480360360a0811015610de857600080fd5b50600160a060020a03813581169160208101358216916040820135169060608101359060800135612477565b6104626125ae565b6105bd60048036036060811015610e3257600080fd5b50600160a060020a038135811691602081013591604090910135166125c4565b610e5a6126a9565b60405180806020018281038252838181518152602001915080516000925b81841015610eba57602080850284010151604080838360005b83811015610ea9578181015183820152602001610e91565b505050509050019260010192610e78565b925050509250505060405180910390f35b6103de60048036036020811015610ee157600080fd5b50356001604060020a0316612730565b6103de60048036036060811015610f0757600080fd5b50600160a060020a038135811691602081013590911690604001351515612793565b6103de600480360360c0811015610f3f57600080fd5b50600160a060020a0381358116916020810135909116906040810135906060810135906001604060020a036080820135169060a0013561287b565b6105bd60048036036040811015610f9057600080fd5b50600160a060020a0381358116916020013516612945565b6103de60048036036060811015610fbe57600080fd5b50600160a060020a03813581169160208101359091169060400135612992565b6105bd60048036036040811015610ff457600080fd5b50600160a060020a0381358116916020013516612a24565b61103a6004803603604081101561102257600080fd5b50600160a060020a0381358116916020013516612a38565b604080519485526020850193909352838301919091526060830152519081900360800190f35b6101d15482906001604060020a0390811690821611156110b8576040805160e560020a62461bcd0281526020600482015260116024820152600080516020615ab9833981519152604482015290519081900360640190fd5b846110c281612b12565b826110cd57876110cf565b885b878a6110dc838383612c1d565b6110eb8c8c8c8c8c8c8c612c87565b505050505050505050505050565b610135546040805180820190915260128152600080516020615a23833981519152602082015290610100900460ff16156111b45760405160e560020a62461bcd0281526004018080602001828103825283818151815260200191508051906020019080838360005b83811015611179578181015183820152602001611161565b50505050905090810190601f1680156111a65780820380516001836020036101000a031916815260200191505b509250505060405180910390fd5b5060006111c18888612eeb565b61019b546040517fd34e59d800000000000000000000000000000000000000000000000000000000815260048101838152600160a060020a03909216602482018190528915156044830152606482018990526084820188905260a482018790529293507312ede3eebf9e3fd6317cfbcb3ebfc762db954d689263d34e59d89285928b918b918b918b918b919060c40182600181111561125c57fe5b60ff16815260200197505050505050505060006040518083038186803b15801561128557600080fd5b505af41580156110eb573d6000803e3d6000fd5b6112a1612f56565b6101358054600160a060020a03909216620100000275ffffffffffffffffffffffffffffffffffffffff000019909216919091179055565b603354600160a060020a031681565b61019b54600160a060020a031681565b81816113048282611d8f565b15611347576040805160e560020a62461bcd02815260206004820152600f60248201526000805160206159de833981519152604482015290519081900360640190fd5b6113518484613069565b50505050565b83836113638282611d8f565b156113a6576040805160e560020a62461bcd02815260206004820152600f60248201526000805160206159de833981519152604482015290519081900360640190fd5b6113b286868686613136565b505050505050565b6000806000806000806000806000806000806113d68e8e6131cb565b959d50939b5091995097509550935091506113f18e8e612a38565b929e50909c509a5098506114058e8e61182f565b90509295989b509295989b509295989b565b81816114238282611d8f565b15611466576040805160e560020a62461bcd02815260206004820152600f60248201526000805160206159de833981519152604482015290519081900360640190fd5b6113518484613200565b670de0b6b3a764000081565b609c828154811061148957fe5b906000526020600020906002020181600281106114a257fe5b0154600160a060020a03169150829050565b6101d1546001604060020a031681565b6114cc612f56565b60006114d88484612eeb565b9050670de0b6b3a76400008211156115245760405160e560020a62461bcd02815260040180806020018281038252602b815260200180615b49602b913960400191505060405180910390fd5b603f01555050565b611534612f56565b60006115408484612eeb565b603e0191909155505050565b611554612f56565b6002816001604060020a031610156115b6576040805160e560020a62461bcd02815260206004820181905260248201527f4578706563746564206f726465727320666f72207469636b20746f6f206c6f77604482015290519081900360640190fd5b6001604060020a0316606655565b6115cc612f56565b6115d683836132c9565b61162a576040805160e560020a62461bcd02815260206004820152601760248201527f546865207061697220646f6573206e6f74206578697374000000000000000000604482015290519081900360640190fd5b600160a060020a0381166116725760405160e560020a62461bcd028152600401808060200182810382526024815260200180615a716024913960400191505060405180910390fd5b600061167e8484612eeb565b601c018054600160a060020a031916600160a060020a039390931692909217909155505050565b609c545b90565b6101355460408051808201909152600b81527f6e6f745f73746f70706572000000000000000000000000000000000000000000602082015290620100009004600160a060020a031633146117445760405160e560020a62461bcd028152602060048201818152835160248401528351909283926044909101919085019080838360008315611179578181015183820152602001611161565b506101355460408051808201909152601281527f636f6e74726163745f69735f6163746976650000000000000000000000000000602082015290610100900460ff166117d45760405160e560020a62461bcd028152602060048201818152835160248401528351909283926044909101919085019080838360008315611179578181015183820152602001611161565b50610135805461ff00191690556040805133815290517f5db9ee0a495bf2e6ff9c91a7834c1ba4fdd244a5e8aa4e537bd38aeae4b073aa9181900360200190a1565b600061182283836132dd565b6003015490505b92915050565b60008061183c84846132dd565b90507312ede3eebf9e3fd6317cfbcb3ebfc762db954d6863323bfe21826040518263ffffffff1660e060020a0281526004018082815260200191505060206040518083038186803b15801561189057600080fd5b505af41580156118a4573d6000803e3d6000fd5b505050506040513d60208110156118ba57600080fd5b5051949350505050565b6101ce5481565b600054610100900460ff16806118e457506118e4613303565b806118f2575060005460ff16155b6119305760405160e560020a62461bcd02815260040180806020018281038252602e815260200180615a43602e913960400191505060405180910390fd5b600054610100900460ff1615801561195b576000805460ff1961ff0019909116610100171660011790555b61196783836001612793565b8015611979576000805461ff00191690555b505050565b611986612f56565b6068546001604060020a03821610156119d35760405160e560020a62461bcd028152600401808060200182810382526029815260200180615b206029913960400191505060405180910390fd5b6001604060020a0316606755565b8484876119ef838383612c1d565b6101d15485906001604060020a039081169082161115611a47576040805160e560020a62461bcd0281526020600482015260116024820152600080516020615ab9833981519152604482015290519081900360640190fd5b8680611a9d576040805160e560020a62461bcd02815260206004820152601460248201527f50726963652063616e6e6f74206265207a65726f000000000000000000000000604482015290519081900360640190fd5b611aab8b8b8b8b8b8b613309565b5050505050505050505050565b6000611ac483836131cb565b509198975050505050505050565b61016880546001019081905561019b54604080517fa82a5759000000000000000000000000000000000000000000000000000000008152600160a060020a0380861660048301529092166024830152517312ede3eebf9e3fd6317cfbcb3ebfc762db954d689163a82a5759916044808301926000929190829003018186803b158015611b5d57600080fd5b505af4158015611b71573d6000803e3d6000fd5b50505050610168548114611b8457600080fd5b5050565b611b90612f56565b610135805460ff19169055565b611ba5612f56565b60008111611be75760405160e560020a62461bcd02815260040180806020018281038252603081526020018061596c6030913960400191505060405180910390fd5b6000611bf38484612eeb565b603c0191909155505050565b6000611c13611c0e84846132dd565b61339e565b9392505050565b600080611c2784846132dd565b601c0154600160a060020a0316949350505050565b61013554610100900460ff1690565b6101d15482906001604060020a039081169082161115611ca3576040805160e560020a62461bcd0281526020600482015260116024820152600080516020615ab9833981519152604482015290519081900360640190fd5b83611cad81612b12565b82611cb85786611cba565b875b8689611cc7838383612c1d565b611aab8b8b8b8b8b8b6133a5565b611cdd612f56565b610135805460ff19166001179055565b600080611cfa8585612eeb565b90507312ede3eebf9e3fd6317cfbcb3ebfc762db954d6863e71df42882856040518363ffffffff1660e060020a02815260040180838152602001821515151581526020019250505060206040518083038186803b158015611d5a57600080fd5b505af4158015611d6e573d6000803e3d6000fd5b505050506040513d6020811015611d8457600080fd5b505195945050505050565b600080611d9c84846122a4565b6003811115611da757fe5b14159392505050565b6000611dc5611dbf85856132dd565b83613435565b949350505050565b600054610100900460ff1680611de65750611de6613303565b80611df4575060005460ff16155b611e325760405160e560020a62461bcd02815260040180806020018281038252602e815260200180615a43602e913960400191505060405180910390fd5b600054610100900460ff16158015611e5d576000805460ff1961ff0019909116610100171660011790555b6001610168558015611e75576000805461ff00191690555b50565b6101355460408051808201909152600b81527f756e73746f707061626c6500000000000000000000000000000000000000000060208201529060ff16611f025760405160e560020a62461bcd028152602060048201818152835160248401528351909283926044909101919085019080838360008315611179578181015183820152602001611161565b506101355460408051808201909152600b81527f6e6f745f73746f70706572000000000000000000000000000000000000000000602082015290620100009004600160a060020a03163314611f9b5760405160e560020a62461bcd028152602060048201818152835160248401528351909283926044909101919085019080838360008315611179578181015183820152602001611161565b50610135546040805180820190915260128152600080516020615a23833981519152602082015290610100900460ff161561201a5760405160e560020a62461bcd028152602060048201818152835160248401528351909283926044909101919085019080838360008315611179578181015183820152602001611161565b50610135805461ff0019166101001790556040805133815290517f62e78cea01bee320cd4e420270b5ea74000d11b0c9f74754ebdbfc544b05a2589181900360200190a1565b612068612f56565b6101d1805467ffffffffffffffff19166001604060020a0392909216919091179055565b600054610100900460ff16806120a557506120a5613303565b806120b3575060005460ff16155b6120f15760405160e560020a62461bcd02815260040180806020018281038252602e815260200180615a43602e913960400191505060405180910390fd5b600054610100900460ff1615801561211c576000805460ff1961ff0019909116610100171660011790555b61212b8c8c8c8c8c888861344f565b6101ce8790556101d1805467ffffffffffffffff19166001604060020a0386161790556101cf8690556101d085905580156110eb576000805461ff0019169055505050505050505050505050565b83836121858282611d8f565b156121c8576040805160e560020a62461bcd02815260206004820152600f60248201526000805160206159de833981519152604482015290519081900360640190fd5b6113b286868686613538565b610135546040805180820190915260128152600080516020615a23833981519152602082015290610100900460ff16156122525760405160e560020a62461bcd028152602060048201818152835160248401528351909283926044909101919085019080838360008315611179578181015183820152602001611161565b50600061225f8686612eeb565b6021810191506122739060230184846157be565b5061228761228187876135cd565b856135d9565b612295600282016000615809565b60006003909101555050505050565b60006122b08383612eeb565b603a015460ff169392505050565b60665460675460685483565b60006122d683836132dd565b601101549392505050565b6122f1858585858560001961287b565b5050505050565b612300612f56565b6101ce55565b663ab9f28a23200081565b6101d05481565b6122f185858585856000196119e1565b6101cf5481565b612337612f56565b60338054600160a060020a031916600160a060020a0392909216919091179055565b6101355460ff1681565b61236b612f56565b6101cf55565b60008060008061238186866132dd565b6020810154601d820154601e909201546001604060020a039091169891975095509350505050565b600054610100900460ff16806123c257506123c2613303565b806123d0575060005460ff16155b61240e5760405160e560020a62461bcd02815260040180806020018281038252602e815260200180615a43602e913960400191505060405180910390fd5b600054610100900460ff16158015612439576000805460ff1961ff0019909116610100171660011790555b60338054600160a060020a031916600160a060020a0384161790558015611b84576000805461ff00191690555050565b612471612f56565b6101d055565b61248485858585856135e9565b600061249086866135cd565b60408051600380825260808201909252919250606091906020820183803883390190505090506124c1826000613677565b816000815181106124ce57fe5b6020026020010181815250506124e5826001613677565b816001815181106124f257fe5b602002602001018181525050612509826002613677565b8160028151811061251657fe5b60209081029190910101526125478160008151811061253157fe5b60200260200101516136e0613796613825613884565b61256d8160018151811061255757fe5b6020026020010151613893613921611b84613884565b6125938160028151811061257d57fe5b60200260200101516139666139c6611b84613884565b6125a58282613a05613a596001613ad5565b50505050505050565b61013554620100009004600160a060020a031681565b60cf54600090600160a060020a03858116911614156125e4575081611c13565b60cf546000906125fd90600160a060020a0316866132dd565b905061260881613ae8565b15612628576126208482603e015483603b0154613b24565b915050611c13565b60cf5461263e90600160a060020a0316846132dd565b905061264981613ae8565b1561269d5760006126638583603e015484603b0154613b24565b905061266f84876132dd565b915061267a82613ae8565b1561269b576126928183603e015484603b0154613b24565b92505050611c13565b505b50600019949350505050565b6060609c805480602002602001604051908101604052809291908181526020016000905b828210156127275760008481526020902060408051808201918290529160028581029091019182845b8154600160a060020a031681526001909101906020018083116126f6575050505050815260200190600101906126cd565b50505050905090565b612738612f56565b6067546001604060020a03821611156127855760405160e560020a62461bcd028152600401808060200182810382526029815260200180615b206029913960400191505060405180910390fd5b6001604060020a0316606855565b600054610100900460ff16806127ac57506127ac613303565b806127ba575060005460ff16155b6127f85760405160e560020a62461bcd02815260040180806020018281038252602e815260200180615a43602e913960400191505060405180910390fd5b600054610100900460ff16158015612823576000805460ff1961ff0019909116610100171660011790555b610135805460ff19168315151775ffffffffffffffffffffffffffffffffffffffff0000191662010000600160a060020a03871602179055612864836123a9565b8015611351576000805461ff001916905550505050565b858487612889838383612c1d565b6101d15485906001604060020a0390811690821611156128e1576040805160e560020a62461bcd0281526020600482015260116024820152600080516020615ab9833981519152604482015290519081900360640190fd5b8680612937576040805160e560020a62461bcd02815260206004820152601460248201527f50726963652063616e6e6f74206265207a65726f000000000000000000000000604482015290519081900360640190fd5b611aab8b8b8b8b8b8b613b46565b604080516c01000000000000000000000000600160a060020a0394851681026020808401919091529390941690930260348401528051602881850301815260489093019052815191012090565b610135546040805180820190915260128152600080516020615a23833981519152602082015290610100900460ff1615612a105760405160e560020a62461bcd028152602060048201818152835160248401528351909283926044909101919085019080838360008315611179578181015183820152602001611161565b50611979612a1e84846135cd565b826135d9565b6000611c13612a3384846132dd565b613bdb565b6000806000806000612a4a87876132dd565b9050612a5581613ae8565b612a6c575060009350839250829150819050612b09565b807312ede3eebf9e3fd6317cfbcb3ebfc762db954d6863f786a14090916040518263ffffffff1660e060020a0281526004018082815260200191505060806040518083038186803b158015612ac057600080fd5b505af4158015612ad4573d6000803e3d6000fd5b505050506040513d6080811015612aea57600080fd5b5080516020820151604083015160609093015191975095509093509150505b92959194509250565b80612b67576040805160e560020a62461bcd02815260206004820152601660248201527f4d756c7469706c79466163746f72206973207a65726f00000000000000000000604482015290519081900360640190fd5b6101cf54811015612bc2576040805160e560020a62461bcd02815260206004820152601260248201527f4c6f77204d756c7469706c79466163746f720000000000000000000000000000604482015290519081900360640190fd5b6101d054811115611e75576040805160e560020a62461bcd02815260206004820152601360248201527f48696768204d756c7469706c79466163746f7200000000000000000000000000604482015290519081900360640190fd5b6000612c2a8484846125c4565b90506101ce54811015611351576040805160e560020a62461bcd02815260206004820152600e60248201527f416d6f756e7420746f6f206c6f77000000000000000000000000000000000000604482015290519081900360640190fd5b610135546040805180820190915260128152600080516020615a23833981519152602082015290610100900460ff1615612d055760405160e560020a62461bcd028152602060048201818152835160248401528351909283926044909101919085019080838360008315611179578181015183820152602001611161565b506000612d128888612eeb565b90506000612d4183612d245788612d26565b895b670de0b6b3a764000085612d3a578b612d3c565b8a5b6125c4565b61019b546040805160e260020a631e2ca63d028152600481018b9052602481018490529051929350600092600160a060020a03909216916378b298f491604480820192602092909190829003018186803b158015612d9e57600080fd5b505afa158015612db2573d6000803e3d6000fd5b505050506040513d6020811015612dc857600080fd5b5051905087811115612e12576040805160e560020a62461bcd02815260206004820152601a602482015260008051602061594c833981519152604482015290519081900360640190fd5b7312ede3eebf9e3fd6317cfbcb3ebfc762db954d6863126fd5b484612e35613be2565b612e458c8663ffffffff613bf116565b6040805160e060020a63ffffffff871602815260048101949094526024840192909252604483015260648201859052608482018b90526001604060020a03891660a483015260c482018a90523360e483015287151561010483015251610124808301926020929190829003018186803b158015612ec157600080fd5b505af4158015612ed5573d6000803e3d6000fd5b505050506040513d60208110156110eb57600080fd5b6000612ef783836132dd565b9050612f0281613ae8565b611829576040805160e560020a62461bcd02815260206004820152601960248201527f546f6b656e207061697220646f6573206e6f7420657869737400000000000000604482015290519081900360640190fd5b603354604080517fd994d6d50000000000000000000000000000000000000000000000000000000081523360048201529051600160a060020a039092169163d994d6d591602480820192602092909190829003018186803b158015612fba57600080fd5b505afa158015612fce573d6000803e3d6000fd5b505050506040513d6020811015612fe457600080fd5b505160408051808201909152601681527f6e6f745f617574686f72697a65645f6368616e67657200000000000000000000602082015290611e755760405160e560020a62461bcd028152602060048201818152835160248401528351909283926044909101919085019080838360008315611179578181015183820152602001611161565b613071612f56565b600061307d8383612eeb565b603d81015490915060ff16156130dd576040805160e560020a62461bcd02815260206004820152601560248201527f5061697220616c72656164792064697361626c65640000000000000000000000604482015290519081900360640190fd5b603d8101805460ff1916600117905560408051600160a060020a0380861682528416602082015281517f71a055a513c927530cb6f44f826ef705d11b6b00e0912135c1f73796663138ed929181900390910190a1505050565b610135546040805180820190915260128152600080516020615a23833981519152602082015290610100900460ff16156131b45760405160e560020a62461bcd028152602060048201818152835160248401528351909283926044909101919085019080838360008315611179578181015183820152602001611161565b506113516131c28585612eeb565b83836001613c06565b60008060008060008060006131e86131e38a8a6132dd565b613e76565b959f949e50929c50909a509850965090945092505050565b613208612f56565b60006132148383612eeb565b603d81015490915060ff16613273576040805160e560020a62461bcd02815260206004820152601460248201527f5061697220616c726561647920656e61626c6564000000000000000000000000604482015290519081900360640190fd5b603d8101805460ff1916905560408051600160a060020a0380861682528416602082015281517f53affae818baf7c49a51b11722048f56b718a0eb3ea1e4e494915a852ead79b0929181900390910190a1505050565b6000611c136132d884846132dd565b613ae8565b6000609b60006132ed8585612945565b8152602001908152602001600020905092915050565b303b1590565b610135546040805180820190915260128152600080516020615a23833981519152602082015290610100900460ff16156133875760405160e560020a62461bcd028152602060048201818152835160248401528351909283926044909101919085019080838360008315611179578181015183820152602001611161565b506113b26133958787612eeb565b85858585613eb6565b6018015490565b610135546040805180820190915260128152600080516020615a23833981519152602082015290610100900460ff16156134235760405160e560020a62461bcd028152602060048201818152835160248401528351909283926044909101919085019080838360008315611179578181015183820152602001611161565b506113b2868686866000198787611060565b600081613446576019830154611c13565b5050600b015490565b600054610100900460ff16806134685750613468613303565b80613476575060005460ff16155b6134b45760405160e560020a62461bcd02815260040180806020018281038252602e815260200180615a43602e913960400191505060405180910390fd5b600054610100900460ff161580156134df576000805460ff1961ff0019909116610100171660011790555b6134ec888787878761409e565b6134f660006141b6565b61019b8054600160a060020a031916600160a060020a03891617905561351c82846118cb565b801561352e576000805461ff00191690555b5050505050505050565b610135546040805180820190915260128152600080516020615a23833981519152602082015290610100900460ff16156135b65760405160e560020a62461bcd028152602060048201818152835160248401528351909283926044909101919085019080838360008315611179578181015183820152602001611161565b506113516135c48585612eeb565b83836000613c06565b6000611c138383612945565b611b8461020561020484846141bc565b60cf54600160a060020a0386811691161480613616575060cf5461361690600160a060020a0316866132c9565b61366a576040805160e560020a62461bcd02815260206004820152600c60248201527f496e76616c696420506169720000000000000000000000000000000000000000604482015290519081900360640190fd5b6122f18585858585614391565b600082826040516020018083815260200182600381111561369457fe5b60ff167f01000000000000000000000000000000000000000000000000000000000000000281526001019250505060405160208183030381529060405280519060200120905092915050565b6000806136ec85614d47565b90506001603a82015460ff16600381111561370357fe5b1461370a57fe5b6000817312ede3eebf9e3fd6317cfbcb3ebfc762db954d68630f0ea5af90916040518263ffffffff1660e060020a0281526004018082815260200191505060206040518083038186803b15801561376057600080fd5b505af4158015613774573d6000803e3d6000fd5b505050506040513d602081101561378a57600080fd5b50519695505050505050565b60006137a183614d47565b90506000603a82015460ff1660038111156137b857fe5b146137bf57fe5b7312ede3eebf9e3fd6317cfbcb3ebfc762db954d6863d50d46a4826040518263ffffffff1660e060020a0281526004018082815260200191505060006040518083038186803b15801561381157600080fd5b505af41580156125a5573d6000803e3d6000fd5b600061383083614d47565b90507312ede3eebf9e3fd6317cfbcb3ebfc762db954d6863582e61a9826040518263ffffffff1660e060020a0281526004018082815260200191505060006040518083038186803b15801561381157600080fd5b61135161020485858585614db7565b60008061389f85614d47565b61019b54604080517fab62503200000000000000000000000000000000000000000000000000000000815260048101849052600160a060020a039092166024830152519192507312ede3eebf9e3fd6317cfbcb3ebfc762db954d689163ab62503291604480820192602092909190829003018186803b158015611d5a57600080fd5b600061392c83614d47565b90506001603a82015460ff16600381111561394357fe5b1461394a57fe5b603a810180546002919060ff19166001835b0217905550505050565b60008061397285614d47565b90507312ede3eebf9e3fd6317cfbcb3ebfc762db954d6863a433a92a826040518263ffffffff1660e060020a0281526004018082815260200191505060206040518083038186803b158015611d5a57600080fd5b60006139d183614d47565b90506002603a82015460ff1660038111156139e857fe5b146139ef57fe5b603a810180546003919060ff191660018361395c565b6000613a1082614d47565b90506000603a82015460ff166003811115613a2757fe5b14613a2e57fe5b600d810154601b820154611b8491601d840191600160a060020a03918216911663ffffffff614ee816565b6000613a6482614d47565b90507312ede3eebf9e3fd6317cfbcb3ebfc762db954d6863ef6d501c8260666040518363ffffffff1660e060020a028152600401808381526020018281526020019250505060006040518083038186803b158015613ac157600080fd5b505af41580156113b2573d6000803e3d6000fd5b6122f16102056102048787878787614f9d565b600d810154600090600160a060020a031615801590613b135750601b820154600160a060020a031615155b8015611829575050603b0154151590565b6000611dc582613b3a868663ffffffff61516116565b9063ffffffff61518816565b610135546040805180820190915260128152600080516020615a23833981519152602082015290610100900460ff1615613bc45760405160e560020a62461bcd028152602060048201818152835160248401528351909283926044909101919085019080838360008315611179578181015183820152602001611161565b506113b2613bd28787612eeb565b858585856151aa565b600a015490565b61010280546001019081905590565b600082821115613c0057600080fd5b50900390565b600081613c165784600e01613c18565b845b604080517fcf1ba0660000000000000000000000000000000000000000000000000000000081526004810188905260248101879052604481018690528415156064820152815192935060009283927312ede3eebf9e3fd6317cfbcb3ebfc762db954d689263cf1ba0669260848083019392829003018186803b158015613c9d57600080fd5b505af4158015613cb1573d6000803e3d6000fd5b505050506040513d6040811015613cc757600080fd5b50805160209091015161019b54600d860154604080517f332d3ca5000000000000000000000000000000000000000000000000000000008152600160a060020a0393841660048201529190921660248201526044810184905260648101839052336084820152600060a482018190529151939550919350918291829182917312ede3eebf9e3fd6317cfbcb3ebfc762db954d689163332d3ca59160c480820192608092909190829003018186803b158015613d8157600080fd5b505af4158015613d95573d6000803e3d6000fd5b505050506040513d6080811015613dab57600080fd5b508051602082015160408301516060909301519196509450909250905083613e1d576040805160e560020a62461bcd02815260206004820152601560248201527f546f6b656e207472616e73666572206661696c65640000000000000000000000604482015290519081900360640190fd5b60408051848152602081018490528082018390528915156060820152905133918c917fd975b60b6329c797ae584f3af10b37331736bff9e1e5c69342394824d8c19b819181900360800190a35050505050505050505050565b6020810154601d820154601e830154603c840154603d850154603e860154603f909601546001604060020a039095169693959294919360ff909116929190565b601b850154600d860154600091613ee391600160a060020a0391821691670de0b6b3a764000091166125c4565b61019b546040805160e260020a631e2ca63d02815260048101899052602481018490529051929350600092600160a060020a03909216916378b298f491604480820192602092909190829003018186803b158015613f4057600080fd5b505afa158015613f54573d6000803e3d6000fd5b505050506040513d6020811015613f6a57600080fd5b5051905085811115613fb4576040805160e560020a62461bcd02815260206004820152601a602482015260008051602061594c833981519152604482015290519081900360640190fd5b7312ede3eebf9e3fd6317cfbcb3ebfc762db954d6863e9322fe188613fd7613be2565b613fe78a8663ffffffff613bf116565b6040805160e060020a63ffffffff871602815260048101949094526024840192909252604483015260648201859052608482018990526001604060020a03881660a483015260c482018790523360e483015230610104830152600061012483015251610144808301926020929190829003018186803b15801561406957600080fd5b505af415801561407d573d6000803e3d6000fd5b505050506040513d602081101561409357600080fd5b505050505050505050565b600054610100900460ff16806140b757506140b7613303565b806140c5575060005460ff16155b6141035760405160e560020a62461bcd02815260040180806020018281038252602e815260200180615a43602e913960400191505060405180910390fd5b600054610100900460ff1615801561412e576000805460ff1961ff0019909116610100171660011790555b600160a060020a0386166141765760405160e560020a62461bcd028152600401808060200182810382526024815260200180615a956024913960400191505060405180910390fd5b60cf8054600160a060020a031916600160a060020a03881617905561419d8585858561535d565b80156113b2576000805461ff0019169055505050505050565b61010255565b6000828152602085905260409020816142095760405160e560020a62461bcd02815260040180806020018281038252604281526020018061599c6042913960600191505060405180910390fd5b805461425f576040805160e560020a62461bcd02815260206004820152601860248201527f7468652067726f757020646f6573206e6f742065786973740000000000000000604482015290519081900360640190fd5b6000600182015460ff16600281111561427457fe5b141561429f578054600382015461428e919063ffffffff16565b6001818101805460ff191690911790555b60018082015460ff1660028111156142b357fe5b14156122f1578160005b6000821180156142d05750600283015481105b156143335760008660008560020184815481106142e957fe5b9060005260206000200154815260200190815260200160002090506000614315828660000154866154ff565b9050614327848263ffffffff613bf116565b935050506001016142bd565b5061433e82866156c9565b156113b25760018201805460ff1916600217905581546003830154614373919063ffffffff6801000000000000000090910416565b6003820154608060020a900460ff16156113b2576113b28286615736565b614399612f56565b84846143a582826132c9565b156143fa576040805160e560020a62461bcd02815260206004820152600d60248201527f4578697374656e74207061697200000000000000000000000000000000000000604482015290519081900360640190fd5b61440481836132c9565b15614459576040805160e560020a62461bcd02815260206004820152601560248201527f4578697374656e7420696e766572736520706169720000000000000000000000604482015290519081900360640190fd5b80600160a060020a031682600160a060020a031614156144c3576040805160e560020a62461bcd02815260206004820152601760248201527f4261736520657175616c20746f207365636f6e64617279000000000000000000604482015290519081900360640190fd5b6000831161451b576040805160e560020a62461bcd02815260206004820152601460248201527f696e697469616c5072696365206e6f207a65726f000000000000000000000000604482015290519081900360640190fd5b60006145278888612945565b60408051808201909152600160a060020a03808b16825289166020820152609c8054600181018083556000929092529293509161458b9160029182027faf85b9071dfafeac1409d3f1d19bafc9bc7c37974cde8df0ee6168f0086e539c0191615827565b5050604051806101600160405280604051806040016040528060405180610180016040528060008152602001600081526020016000815260200160008152602001600081526020016000815260200160008152602001600081526020016000815260200160008152602001600081526020016001151581525081526020018b600160a060020a03168152508152602001604051806040016040528060405180610180016040528060008152602001600081526020016000815260200160008152602001600081526020016000815260200160008152602001600081526020016000815260200160008152602001600081526020016000151581525081526020018a600160a060020a0316815250815260200187600160a060020a0316815260200160405180608001604052806146c64360666002015461574c565b8152602001600081526020016000815260200160016001604060020a0316815250815260200160405180610160016040528060008152602001600081526020016000604051908082528060200260200182016040528015614731578160200160208202803883390190505b508152602001600081526020016040518061012001604052806000600181111561475757fe5b81526020016000815260200160008152602001600081526020016000815260200160008152602001600081526020016000600160a060020a0316815260200160006001604060020a03168152508152602001604051806101200160405280600060018111156147c257fe5b81526020016000815260200160008152602001600081526020016000815260200160008152602001600081526020016000600160a060020a0316815260200160006001604060020a0316815250815260200160008152602001600081526020016000815260200160008152602001600081525081526020016000600381111561484757fe5b8152602001868152602001858152602001600015158152602001858152602001663ab9f28a232000815250609b6000838152602001908152602001600020600082015181600001600082015181600001600082015181600101556020820151816002015560408201518160030155606082015181600401556080820151816005015560a0820151816006015560c0820151816007015560e08201518160080155610100820151816009015561012082015181600a015561014082015181600b015561016082015181600c0160006101000a81548160ff0219169083151502179055505050602082015181600d0160006101000a815481600160a060020a030219169083600160a060020a031602179055505050602082015181600e01600082015181600001600082015181600101556020820151816002015560408201518160030155606082015181600401556080820151816005015560a0820151816006015560c0820151816007015560e08201518160080155610100820151816009015561012082015181600a015561014082015181600b015561016082015181600c0160006101000a81548160ff0219169083151502179055505050602082015181600d0160006101000a815481600160a060020a030219169083600160a060020a031602179055505050604082015181601c0160006101000a815481600160a060020a030219169083600160a060020a03160217905550606082015181601d0160008201518160000155602082015181600101556040820151816002015560608201518160030160006101000a8154816001604060020a0302191690836001604060020a03160217905550505060808201518160210160008201518160000155602082015181600101556040820151816002019080519060200190614aeb92919061587b565b506060820151600382015560808201518051600483018054909190829060ff191660018381811115614b1957fe5b0217905550602082015160018083019190915560408301516002830155606083015160038301556080830151600483015560a080840151600584015560c0840151600684015560e084015160079093018054610100909501516001604060020a031674010000000000000000000000000000000000000000027bffffffffffffffff000000000000000000000000000000000000000019600160a060020a03909516600160a060020a0319909616959095179390931693909317909155908301518051600c8401805492939092839160ff19909116908381811115614bfa57fe5b02179055506020820151816001015560408201518160020155606082015181600301556080820151816004015560a0820151816005015560c0820151816006015560e08201518160070160006101000a815481600160a060020a030219169083600160a060020a031602179055506101008201518160070160146101000a8154816001604060020a0302191690836001604060020a03160217905550505060c0820151816014015560e08201518160150155610100820151816016015561012082015181601701556101408201518160180155505060a082015181603a0160006101000a81548160ff02191690836003811115614cf357fe5b021790555060c0820151603b82015560e0820151603c820155610100820151603d8201805460ff1916911515919091179055610120820151603e82015561014090910151603f909101555050505050505050565b6000818152609b60205260409020614d5e81613ae8565b614db2576040805160e560020a62461bcd02815260206004820152601960248201527f546f6b656e207061697220646f6573206e6f7420657869737400000000000000604482015290519081900360640190fd5b919050565b83614e0c576040805160e560020a62461bcd02815260206004820152601c60248201527f61207461736b2063616e6e6f7420686176652061206e756c6c20696400000000604482015290519081900360640190fd5b6000848152602086905260409020805415614e5b5760405160e560020a62461bcd02815260040180806020018281038252602281526020018061592a6022913960400191505060405180910390fd5b93845560018401805460038601805460ff191690556001604060020a03928316608060020a0277ffffffffffffffff000000000000000000000000000000001994841668010000000000000000026fffffffffffffffff00000000000000001990921691909117939093169290921767ffffffffffffffff19169216919091179055600060029091015550565b8254431015614f41576040805160e560020a62461bcd02815260206004820152601560248201527f4e657874207469636b206e6f7420726561636865640000000000000000000000604482015290519081900360640190fd5b4360028401556003830154604080516001604060020a03909216825251600160a060020a0380841692908516917fa87d06f354e4eb6a0b84a1931ddf2227694fff0707633220127d3e307bd5341c9181900360200190a3505050565b84614ff2576040805160e560020a62461bcd02815260206004820152601d60248201527f612067726f75702063616e6e6f7420686176652061206e756c6c206964000000604482015290519081900360640190fd5b60008581526020889052604090208054156150415760405160e560020a62461bcd028152600401808060200182810382526023815260200180615ad96023913960400191505060405180910390fd5b85815560005b85518110156150df57600086828151811061505e57fe5b6020908102919091018101516000818152918b905260409091208054919250906150bc5760405160e560020a62461bcd0281526004018080602001828103825260258152602001806159fe6025913960400191505060405180910390fd5b506002830180546001818101835560009283526020909220019190915501615047565b506003810180546001909201805460ff19169055911515608060020a026001604060020a0393841668010000000000000000026fffffffffffffffff0000000000000000199590941667ffffffffffffffff1990921691909117939093169190911770ff00000000000000000000000000000000191691909117905550505050565b60008261517057506000611829565b8282028284828161517d57fe5b0414611c1357600080fd5b600080821161519657600080fd5b60008284816151a157fe5b04949350505050565b600d850154601b8601546000916151d791600160a060020a0391821691670de0b6b3a764000091166125c4565b61019b546040805160e260020a631e2ca63d02815260048101899052602481018490529051929350600092600160a060020a03909216916378b298f491604480820192602092909190829003018186803b15801561523457600080fd5b505afa158015615248573d6000803e3d6000fd5b505050506040513d602081101561525e57600080fd5b50519050858111156152a8576040805160e560020a62461bcd02815260206004820152601a602482015260008051602061594c833981519152604482015290519081900360640190fd5b7312ede3eebf9e3fd6317cfbcb3ebfc762db954d6863e9322fe1886152cb613be2565b6152db8a8663ffffffff613bf116565b6040805160e060020a63ffffffff871602815260048101949094526024840192909252604483015260648201859052608482018990526001604060020a03881660a483015260c482018790523360e483015230610104830152600161012483015251610144808301926020929190829003018186803b15801561406957600080fd5b600054610100900460ff16806153765750615376613303565b80615384575060005460ff16155b6153c25760405160e560020a62461bcd02815260040180806020018281038252602e815260200180615a43602e913960400191505060405180910390fd5b600054610100900460ff161580156153ed576000805460ff1961ff0019909116610100171660011790555b6002856001604060020a0316101561544f576040805160e560020a62461bcd02815260206004820181905260248201527f4578706563746564206f726465727320666f72207469636b20746f6f206c6f77604482015290519081900360640190fd5b826001604060020a0316846001604060020a031610156154a35760405160e560020a62461bcd028152600401808060200182810382526029815260200180615b206029913960400191505060405180910390fd5b604080516060810182526001604060020a0380881680835287821660208401819052918716929093018290526066929092556067919091556068556154e7826123a9565b80156122f1576000805461ff00191690555050505050565b60008082116155425760405160e560020a62461bcd0281526004018080602001828103825260358152602001806158f56035913960400191505060405180910390fd5b83546155825760405160e560020a62461bcd028152600401808060200182810382526024815260200180615afc6024913960400191505060405180910390fd5b60028085015490600386015460ff16600281111561559c57fe5b14156155ac576000915050611c13565b6000600386015460ff1660028111156155c157fe5b14156155f857845460018601546155e891869168010000000000000000900463ffffffff16565b60038501805460ff191660011790555b6001600386015460ff16600281111561560d57fe5b14156156ab5760028501546000906001908290615630908763ffffffff61574c16565b9050876002015492505b81801561564657508083105b1561566f5787546001890154615662918991869063ffffffff16565b600190930192915061563a565b60028801839055816156a75760038801805460ff19166002179055875460018901546156a791899163ffffffff608060020a90910416565b5050505b60028501546156c0908263ffffffff613bf116565b95945050505050565b6002820180546000918291849183916156e990600163ffffffff613bf116565b815481106156f357fe5b90600052602060002001548152602001908152602001600020905060028081111561571a57fe5b600382015460ff16600281111561572d57fe5b14949350505050565b60018201805460ff19169055611b84828261575e565b600082820183811015611c1357600080fd5b60005b6002830154811015611979576157a082600085600201848154811061578257fe5b906000526020600020015481526020019081526020016000206157a8565b600101615761565b60038101805460ff191690556000600290910155565b8280548282559060005260206000209081019282156157f9579160200282015b828111156157f95782358255916020019190600101906157de565b506158059291506158b6565b5090565b5080546000825590600052602060002090810190611e7591906158b6565b826002810192821561586f579160200282015b8281111561586f5782518254600160a060020a031916600160a060020a0390911617825560209092019160019091019061583a565b506158059291506158d0565b8280548282559060005260206000209081019282156157f9579160200282015b828111156157f957825182559160200191906001019061589b565b6116a991905b8082111561580557600081556001016158bc565b6116a991905b80821115615805578054600160a060020a03191681556001016158d656fe697420646f6573206e6f74206d616b652073656e736520746f20657865637574652061207461736b2077697468203020737465707361207461736b2077697468207468617420696420616c726561647920657869737473416d6f756e742069732067726561746572207468616e2046656500000000000054686520676976656e20696e697469616c2070726963652073686f756c642062652067726561746572207468616e2030697420646f6573206e6f74206d616b652073656e736520746f206578656375746520612067726f7570206f66207461736b732077697468207a65726f2073746570735469636b2069732072756e6e696e6700000000000000000000000000000000006f6e65206f662074686520737065636966696564207461736b7320697320696e76616c6964636f6e74726163745f69735f7061757365640000000000000000000000000000436f6e747261637420696e7374616e63652068617320616c7265616479206265656e20696e697469616c697a656450726963652070726f766964657220616464726573732063616e206e6f74206265203078636f6d6d6f42617365546f6b656e416464726573732063616e6e6f74206265206e756c6c4c6966657370616e20746f6f2068696768000000000000000000000000000000612067726f75702077697468207468617420696420616c726561647920657869737473697420697320696e76616c696420746f20657865637574652061206e756c6c207461736b6d696e20426c6f636b466f725469636b2073686f756c64206265206c6f776572207468616e206d6178536d6f6f7468696e6720666163746f722073686f756c6420626520696e2072656c6174696f6e20746f2031a165627a7a72305820081ab525bc7edc12c5f45fbecff8a52365b00b2bc2a9ce3fb7bb381a06bd89850029"
}